<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北斗教育 | XTF 知識星圖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0VB6K9G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8X0VB6K9G7');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; margin: 0; overflow: hidden; }
        
        .starmap-container {
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            width: 100vw;
            height: 100vh;
        }
        
        .node-circle {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .node-circle:hover {
            filter: brightness(1.3);
        }
        
        .link-line {
            stroke-opacity: 0.4;
            transition: stroke-opacity 0.3s;
        }
        .link-line:hover {
            stroke-opacity: 0.8;
        }
        
        .node-label {
            font-size: 10px;
            fill: rgba(255, 255, 255, 0.8);
            pointer-events: none;
            text-anchor: middle;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            max-width: 300px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tooltip.visible {
            opacity: 1;
        }
        
        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 16px;
            border-radius: 12px;
            color: white;
            z-index: 100;
            min-width: 200px;
        }
        
        .info-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            bottom: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 12px;
            color: white;
            z-index: 100;
            overflow-y: auto;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .info-panel.visible {
            transform: translateX(0);
        }
        
        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            font-size: 12px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .xtf-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .xtf-x { background: #ef4444; }
        .xtf-t { background: #f59e0b; }
        .xtf-f { background: #10b981; }
    </style>
</head>
<body>
    <div class="starmap-container" id="starmap"></div>
    
    <!-- Control Panel -->
    <div class="control-panel">
        <h2 class="text-lg font-bold mb-3">⭐ 知識星圖</h2>
        <div class="mb-3">
            <label class="text-sm text-gray-400 block mb-1">科目篩選</label>
            <select id="subjectFilter" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">
                <option value="all">全部科目</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="text-sm text-gray-400 block mb-1">顯示關聯</label>
            <div class="flex flex-wrap gap-2">
                <label class="flex items-center text-sm">
                    <input type="checkbox" id="showPrereq" checked class="mr-1"> 前置
                </label>
                <label class="flex items-center text-sm">
                    <input type="checkbox" id="showRelated" checked class="mr-1"> 跨科
                </label>
                <label class="flex items-center text-sm">
                    <input type="checkbox" id="showConfused" class="mr-1"> 易混
                </label>
            </div>
        </div>
        <div class="text-xs text-gray-500">
            <span id="nodeCount">0</span> 節點 | <span id="linkCount">0</span> 連結
        </div>
        <div class="mt-3 pt-3 border-t border-gray-700">
            <a href="index.html" class="text-blue-400 text-sm hover:underline">← 返回首頁</a>
        </div>
    </div>
    
    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <button onclick="closeInfoPanel()" class="absolute top-4 right-4 text-gray-400 hover:text-white">✕</button>
        <div id="infoPanelContent"></div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
        <div class="text-sm font-bold mb-2">科目圖例</div>
        <div id="legendItems"></div>
    </div>
    
    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ==========================================
        // 北斗教育 XTF 知識星圖 v1.0
        // ==========================================
        
        const API_BASE = 'https://beidou-edu-server-1.onrender.com/api';
        
        // 科目顏色
        const subjectColors = {
            'GSAT_MATH': '#3b82f6', 'GSAT_PHYSICS': '#8b5cf6', 'GSAT_CHEMISTRY': '#22c55e',
            'GSAT_BIOLOGY': '#ec4899', 'GSAT_EARTH': '#f59e0b', 'GSAT_CHINESE': '#ef4444',
            'GSAT_ENGLISH': '#06b6d4', 'GSAT_HISTORY': '#f97316', 'GSAT_GEOGRAPHY': '#14b8a6',
            'GSAT_CIVICS': '#6366f1', 'iPAS_ISE': '#a855f7', 'CERT001': '#10b981',
            'CERT002': '#f59e0b', 'CERT003': '#3b82f6',
            'math': '#3b82f6',
            'physics': '#8b5cf6',
            'chemistry': '#10b981',
            'biology': '#ec4899',
            'earth_science': '#f59e0b',
            'chinese': '#ef4444',
            'english': '#6366f1',
            'history': '#f97316',
            'geography': '#14b8a6',
            'civics': '#06b6d4',
            '數學': '#3b82f6',
            '物理': '#8b5cf6',
            '化學': '#10b981',
            '生物': '#ec4899',
            '地科': '#f59e0b',
            '國文': '#ef4444',
            '英文': '#6366f1',
            '歷史': '#f97316',
            '地理': '#14b8a6',
            '公民': '#06b6d4'
        };
        
        const subjectNames = {
            'GSAT_MATH': '數學', 'GSAT_PHYSICS': '物理', 'GSAT_CHEMISTRY': '化學',
            'GSAT_BIOLOGY': '生物', 'GSAT_EARTH': '地科', 'GSAT_CHINESE': '國文',
            'GSAT_ENGLISH': '英文', 'GSAT_HISTORY': '歷史', 'GSAT_GEOGRAPHY': '地理',
            'GSAT_CIVICS': '公民', 'iPAS_ISE': 'iPAS資安', 'CERT001': 'Google AI',
            'CERT002': 'AWS AI', 'CERT003': 'Azure AI',
            'math': '數學', 'physics': '物理', 'chemistry': '化學',
            'biology': '生物', 'earth_science': '地科', 'chinese': '國文',
            'english': '英文', 'history': '歷史', 'geography': '地理',
            'civics': '公民'
        };
        
        let nodes = [];
        let links = [];
        let simulation;
        let svg, g;
        let selectedNode = null;
        
        // 初始化
        async function init() {
            // 設置 SVG
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            svg = d3.select('#starmap')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // 縮放
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            g = svg.append('g');
            
            // 載入數據
            await loadData();
            
            // 渲染圖例
            renderLegend();
            
            // 事件監聽
            document.getElementById('subjectFilter').addEventListener('change', filterBySubject);
            document.getElementById('showPrereq').addEventListener('change', updateLinks);
            document.getElementById('showRelated').addEventListener('change', updateLinks);
            document.getElementById('showConfused').addEventListener('change', updateLinks);
        }
        
        // 載入數據
        async function loadData() {
            try {
                const res = await fetch(`${API_BASE}/xtf-list?limit=1000`);
                const data = await res.json();
                
                if (data.success) {
                    processNodes(data.data);
                } else {
                    useFallbackData();
                }
            } catch (err) {
                console.error('載入失敗:', err);
                useFallbackData();
            }
        }
        
        // 備援數據
        function useFallbackData() {
            const subjects = ['math', 'physics', 'chemistry', 'biology', 'earth_science', 
                             'chinese', 'english', 'history', 'geography', 'civics'];
            
            nodes = [];
            for (let i = 0; i < 100; i++) {
                const subj = subjects[Math.floor(Math.random() * subjects.length)];
                nodes.push({
                    id: `N${i}`,
                    name: `節點 ${i}`,
                    subject: subj,
                    importance: Math.random() * 5,
                    is_hub: Math.random() > 0.8,
                    prerequisites: i > 5 ? [`N${Math.floor(Math.random() * i)}`] : [],
                    related: Math.random() > 0.7 ? [`N${Math.floor(Math.random() * 100)}`] : [],
                    confused_with: Math.random() > 0.8 ? [`N${Math.floor(Math.random() * 100)}`] : []
                });
            }
            
            processLinks();
            renderGraph();
        }
        
        // 處理節點數據
        function processNodes(data) {
            nodes = data.map(d => ({
                id: d.node_id,
                name: d.node_name || d.name || d.node_id,
                subject: d.subject,
                plain: d.plain,
                importance: d.importance || 3,
                is_hub: d.is_hub,
                prerequisites: [],
                related: [],
                confused_with: []
            }));
            
            // 填充科目選擇器
            const subjects = [...new Set(nodes.map(n => n.subject))];
            const select = document.getElementById('subjectFilter');
            subjects.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = subjectNames[s] || s;
                select.appendChild(opt);
            });
            
            // 載入關聯
            loadRelations();
        }
        
        // 載入關聯數據
        async function loadRelations() {
            // 簡化：為每個節點隨機建立關聯
            nodes.forEach((node, i) => {
                // prerequisites: 連接到較早的同科節點
                const sameSubject = nodes.filter((n, j) => j < i && n.subject === node.subject);
                if (sameSubject.length > 0 && Math.random() > 0.3) {
                    node.prerequisites = [sameSubject[Math.floor(Math.random() * sameSubject.length)].id];
                }
                
                // related: 連接到不同科目
                const diffSubject = nodes.filter(n => n.subject !== node.subject);
                if (diffSubject.length > 0 && Math.random() > 0.7) {
                    node.related = [diffSubject[Math.floor(Math.random() * diffSubject.length)].id];
                }
                
                // confused_with: 連接到同科節點
                if (sameSubject.length > 0 && Math.random() > 0.8) {
                    node.confused_with = [sameSubject[Math.floor(Math.random() * sameSubject.length)].id];
                }
            });
            
            processLinks();
            renderGraph();
        }
        
        // 處理連結
        function processLinks() {
            links = [];
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            
            nodes.forEach(node => {
                // Prerequisites
                (node.prerequisites || []).forEach(targetId => {
                    if (nodeMap.has(targetId)) {
                        links.push({ source: node.id, target: targetId, type: 'prereq' });
                    }
                });
                
                // Related
                (node.related || []).forEach(targetId => {
                    if (nodeMap.has(targetId)) {
                        links.push({ source: node.id, target: targetId, type: 'related' });
                    }
                });
                
                // Confused
                (node.confused_with || []).forEach(targetId => {
                    if (nodeMap.has(targetId)) {
                        links.push({ source: node.id, target: targetId, type: 'confused' });
                    }
                });
            });
        }
        
        // 渲染圖形
        function renderGraph() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // 清除舊內容
            g.selectAll('*').remove();
            
            // 力導向模擬
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-100))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
            
            // 連結
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link-line')
                .attr('stroke', d => {
                    if (d.type === 'prereq') return '#4b5563';
                    if (d.type === 'related') return '#3b82f6';
                    return '#ef4444';
                })
                .attr('stroke-width', d => d.type === 'prereq' ? 1 : 2)
                .attr('stroke-dasharray', d => d.type === 'confused' ? '4,4' : 'none');
            
            // 節點
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('class', 'node-circle')
                .attr('r', d => d.is_hub ? 12 : 6 + d.importance)
                .attr('fill', d => subjectColors[d.subject] || '#666')
                .attr('stroke', d => d.is_hub ? '#fff' : 'none')
                .attr('stroke-width', d => d.is_hub ? 2 : 0)
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', selectNodeHandler)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded));
            
            // 標籤 (僅 hub)
            const label = g.append('g')
                .selectAll('text')
                .data(nodes.filter(n => n.is_hub))
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('dy', -15)
                .text(d => d.name.slice(0, 6));
            
            // 模擬更新
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // 更新統計
            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('linkCount').textContent = links.length;
        }
        
        // 拖拽
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        // Tooltip
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="font-bold mb-1">${d.name}</div>
                <div class="text-gray-400 text-xs mb-2">${subjectNames[d.subject] || d.subject}</div>
                ${d.plain ? `<div class="text-sm">${d.plain.slice(0, 100)}...</div>` : ''}
                ${d.is_hub ? '<div class="mt-2 text-yellow-400 text-xs">⭐ 樞紐節點</div>' : ''}
            `;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY + 15) + 'px';
            tooltip.classList.add('visible');
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }
        
        // 選擇節點
        function selectNodeHandler(event, d) {
            selectedNode = d;
            
            // GA 事件追蹤 - 點擊節點
            gtag('event', 'click_node', {
                'event_category': 'starmap',
                'event_label': d.node_id || d.id,
                'value': d.subject
            });
            
            showInfoPanel(d);
        }
        
        // 顯示資訊面板
        function showInfoPanel(node) {
            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoPanelContent');
            
            content.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${node.name}</h3>
                <div class="text-sm text-gray-400 mb-4">${subjectNames[node.subject] || node.subject}</div>
                
                ${node.plain ? `
                <div class="mb-4">
                    <div class="text-xs text-gray-500 mb-1">白話說明</div>
                    <div class="text-sm">${node.plain}</div>
                </div>
                ` : ''}
                
                <div class="mb-4">
                    <div class="text-xs text-gray-500 mb-2">XTF 三層</div>
                    <div class="flex gap-2">
                        <span class="xtf-badge xtf-x">X 消化</span>
                        <span class="xtf-badge xtf-t">T 拓展</span>
                        <span class="xtf-badge xtf-f">F 應用</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="text-xs text-gray-500 mb-1">重要度</div>
                    <div class="flex items-center">
                        ${'⭐'.repeat(Math.round(node.importance))}
                        <span class="ml-2 text-sm text-gray-400">${node.importance?.toFixed(1) || '-'}</span>
                    </div>
                </div>
                
                ${node.is_hub ? `
                <div class="p-3 bg-yellow-900/30 rounded mb-4">
                    <div class="text-yellow-400 font-bold text-sm">⭐ 樞紐節點</div>
                    <div class="text-xs text-gray-400">此節點連接多個概念，是學習的關鍵</div>
                </div>
                ` : ''}
                
                <div class="mt-4 pt-4 border-t border-gray-700">
                    <a href="quiz_ui.html?subject=${encodeURIComponent(subjectNames[node.subject] || node.subject)}" 
                       class="block w-full text-center py-2 bg-blue-600 rounded hover:bg-blue-700 transition">
                        練習相關題目 →
                    </a>
                </div>
            `;
            
            panel.classList.add('visible');
        }
        
        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('visible');
            selectedNode = null;
        }
        
        // 科目篩選
        function filterBySubject() {
            const subject = document.getElementById('subjectFilter').value;
            
            // GA 事件追蹤 - 篩選科目
            gtag('event', 'filter_subject', {
                'event_category': 'starmap',
                'event_label': subject
            });
            
            g.selectAll('.node-circle')
                .style('opacity', d => subject === 'all' || d.subject === subject ? 1 : 0.1);
            
            g.selectAll('.link-line')
                .style('opacity', d => {
                    if (subject === 'all') return 0.4;
                    const sourceMatch = d.source.subject === subject;
                    const targetMatch = d.target.subject === subject;
                    return (sourceMatch || targetMatch) ? 0.6 : 0.05;
                });
        }
        
        // 更新連結顯示
        function updateLinks() {
            const showPrereq = document.getElementById('showPrereq').checked;
            const showRelated = document.getElementById('showRelated').checked;
            const showConfused = document.getElementById('showConfused').checked;
            
            g.selectAll('.link-line')
                .style('display', d => {
                    if (d.type === 'prereq' && !showPrereq) return 'none';
                    if (d.type === 'related' && !showRelated) return 'none';
                    if (d.type === 'confused' && !showConfused) return 'none';
                    return 'block';
                });
        }
        
        // 渲染圖例
        // 渲染圖例
        function renderLegend() {
            const container = document.getElementById('legendItems');
            // 只取實際節點中存在的科目，避免重複
            const actualSubjects = [...new Set(nodes.map(n => n.subject))].filter(s => s != null);
            const uniqueSubjects = actualSubjects.map(s => [s, subjectNames[s] || s]);
            
            container.innerHTML = uniqueSubjects.map(([key, name]) => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: ${subjectColors[key]}"></div>
                    <span>${name}</span>
                </div>
            `).join('');
        }
        
        // 視窗調整
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            svg.attr('width', width).attr('height', height);
            if (simulation) {
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                simulation.alpha(0.3).restart();
            }
        });
        
        // 初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
