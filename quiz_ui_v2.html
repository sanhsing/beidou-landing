<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šå…ƒé¡Œå‹ç·´ç¿’ - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root { --primary: #4F46E5; --success: #10B981; --danger: #EF4444; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .option-card { transition: all 0.2s; border: 2px solid #E5E7EB; cursor: pointer; }
    .option-card:hover:not(.disabled) { border-color: var(--primary); transform: translateX(4px); }
    .option-card.selected { border-color: var(--primary); background: #EEF2FF; }
    .option-card.correct { border-color: var(--success); background: #DCFCE7; }
    .option-card.wrong { border-color: var(--danger); background: #FEE2E2; }
    .option-card.disabled { pointer-events: none; }
    .matching-item { padding: 12px 16px; background: white; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .matching-item:hover { border-color: var(--primary); }
    .matching-item.selected { border-color: var(--primary); background: #EEF2FF; }
    .matching-item.matched { border-color: var(--success); background: #DCFCE7; }
    .matching-item.wrong-match { border-color: var(--danger); background: #FEE2E2; }
    .sortable-item { padding: 12px 16px; background: white; border: 2px solid #E5E7EB; border-radius: 8px; cursor: grab; transition: all 0.2s; user-select: none; }
    .sortable-item.dragging { opacity: 0.5; border-color: var(--primary); }
    .sortable-item .handle { color: #9CA3AF; margin-right: 12px; }
    .sortable-item .number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.8rem; font-weight: bold; margin-right: 12px; }
    .fill-blank-input { border: 2px solid #E5E7EB; border-radius: 8px; padding: 12px 20px; font-size: 1.2rem; width: 250px; text-align: center; }
    .fill-blank-input:focus { border-color: var(--primary); outline: none; }
    .fill-blank-input.correct { border-color: var(--success); background: #DCFCE7; }
    .fill-blank-input.wrong { border-color: var(--danger); background: #FEE2E2; }
    .multi-option { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .multi-option:hover { border-color: var(--primary); }
    .multi-option.selected { border-color: var(--primary); background: #EEF2FF; }
    .multi-option.correct-option { border-color: var(--success); background: #DCFCE7; }
    .multi-option.wrong-option { border-color: var(--danger); background: #FEE2E2; }
    .multi-option .checkbox { width: 22px; height: 22px; border: 2px solid #D1D5DB; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .multi-option.selected .checkbox { background: var(--primary); border-color: var(--primary); color: white; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease; }
    .score-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; animation: scoreAnim 1s ease forwards; pointer-events: none; z-index: 100; }
    @keyframes scoreAnim { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    .score-correct { color: var(--success); }
    .score-wrong { color: var(--danger); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="fixed top-0 left-0 right-0 h-1.5 bg-gray-200 z-50">
    <div id="progressBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" style="width: 0%"></div>
  </div>

  <nav class="bg-white shadow-sm sticky top-0 z-40 mt-1.5">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="dashboard.html" class="flex items-center gap-2 text-gray-600 hover:text-indigo-600">â† è¿”å›</a>
      <div class="flex items-center gap-4">
        <span class="bg-gray-100 px-3 py-1.5 rounded-full">â±ï¸ <span id="timer" class="font-mono font-bold">00:00</span></span>
        <span class="bg-indigo-100 px-3 py-1.5 rounded-full">ğŸ“Š <span id="score" class="font-bold text-indigo-600">0 åˆ†</span></span>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <div id="loadingBox" class="hidden flex flex-col items-center justify-center py-20">
      <div class="loader mb-4"></div>
      <p class="text-gray-500">è¼‰å…¥é¡Œç›®ä¸­...</p>
    </div>

    <div id="questionInfo" class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="px-4 py-1.5 bg-indigo-600 text-white rounded-full text-sm font-bold" id="questionNum">1 / 10</span>
        <span class="px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full text-sm" id="typeBadge">ğŸ“ å–®é¸é¡Œ</span>
        <span class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm" id="subjectBadge">æ•¸å­¸</span>
      </div>
      <div class="flex items-center gap-2">
        <span id="streakEmoji">ğŸ”¥</span>
        <span class="font-bold text-orange-500" id="streak">0</span>
      </div>
    </div>

    <div id="questionCard" class="bg-white rounded-2xl shadow-lg p-6 mb-6 animate-fade-in">
      <h2 class="text-xl font-bold text-gray-800 mb-6" id="questionStem">é¡Œç›®è¼‰å…¥ä¸­...</h2>
      <div id="questionContent"></div>
    </div>

    <div class="flex justify-center gap-4">
      <button id="submitBtn" onclick="checkAnswer()" class="px-10 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">âœ“ ç¢ºèªç­”æ¡ˆ</button>
      <button id="nextBtn" onclick="nextQuestion()" class="px-10 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 hidden">ä¸‹ä¸€é¡Œ â†’</button>
    </div>

    <div id="explanationBox" class="mt-6 bg-green-50 border border-green-200 rounded-xl p-5 hidden">
      <h3 class="font-bold text-green-800 mb-2">ğŸ“– è§£æ</h3>
      <p id="explanationText" class="text-green-700"></p>
    </div>
  </main>

  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <h2 class="text-2xl font-bold mb-6">ğŸ¯ é¸æ“‡ç·´ç¿’æ¨¡å¼</h2>
      <div class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“š ç§‘ç›®</label>
          <select id="subjectSelect" class="w-full border-2 rounded-xl px-4 py-3">
            <option value="">å…¨éƒ¨ç§‘ç›®</option>
            <option value="æ•¸å­¸">æ•¸å­¸</option>
            <option value="ç‰©ç†">ç‰©ç†</option>
            <option value="åŒ–å­¸">åŒ–å­¸</option>
            <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
            <option value="åœ‹æ–‡">åœ‹æ–‡</option>
            <option value="è‹±æ–‡">è‹±æ–‡</option>
            <option value="æ­·å²">æ­·å²</option>
            <option value="åœ°ç†">åœ°ç†</option>
            <option value="å…¬æ°‘">å…¬æ°‘</option>
            <option value="åœ°ç§‘">åœ°ç§‘</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“ é¡Œå‹</label>
          <select id="typeSelect" class="w-full border-2 rounded-xl px-4 py-3">
            <option value="mixed">ğŸ² æ··åˆé¡Œå‹</option>
            <option value="single_choice">ğŸ“ å–®é¸é¡Œ</option>
            <option value="matching">ğŸ”— é…å°é¡Œ</option>
            <option value="ordering">ğŸ“‹ æ’åºé¡Œ</option>
            <option value="fill_blank">âœï¸ å¡«ç©ºé¡Œ</option>
            <option value="multiple_select">â˜‘ï¸ å¤šé¸é¡Œ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ”¢ é¡Œæ•¸</label>
          <select id="countSelect" class="w-full border-2 rounded-xl px-4 py-3">
            <option value="5">5 é¡Œ</option>
            <option value="10" selected>10 é¡Œ</option>
            <option value="20">20 é¡Œ</option>
          </select>
        </div>
      </div>
      <button onclick="startQuiz()" class="w-full mt-8 px-6 py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700">é–‹å§‹ç·´ç¿’ ğŸš€</button>
    </div>
  </div>

  <div id="scorePopup" class="score-popup hidden"></div>

  <script>
    const API_BASE = 'https://beidou-edu-server-1.onrender.com';
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let streak = 0;
    let timer = 0;
    let timerInterval = null;
    
    // åˆ†é–‹å­˜æ”¾ä¸åŒé¡Œå‹çš„ç­”æ¡ˆ
    let singleAnswer = null;      // å–®é¸é¡Œï¼šæ•¸å­—
    let multiAnswers = [];        // å¤šé¸é¡Œï¼šå­—æ¯é™£åˆ—
    let matchingData = {};        // é…å°é¡Œ
    let orderingData = [];        // æ’åºé¡Œ
    
    const typeIcons = { 'single_choice': 'ğŸ“', 'matching': 'ğŸ”—', 'ordering': 'ğŸ“‹', 'fill_blank': 'âœï¸', 'multiple_select': 'â˜‘ï¸' };
    const typeNames = { 'single_choice': 'å–®é¸é¡Œ', 'matching': 'é…å°é¡Œ', 'ordering': 'æ’åºé¡Œ', 'fill_blank': 'å¡«ç©ºé¡Œ', 'multiple_select': 'å¤šé¸é¡Œ' };

    async function startQuiz() {
      const subject = document.getElementById('subjectSelect').value;
      const type = document.getElementById('typeSelect').value;
      const count = parseInt(document.getElementById('countSelect').value);
      document.getElementById('settingsModal').classList.add('hidden');
      document.getElementById('loadingBox').classList.remove('hidden');
      document.getElementById('questionCard').classList.add('hidden');
      try {
        if (type === 'mixed') await loadMixedQuestions(subject, count);
        else if (type === 'single_choice') await loadSingleChoice(subject, count);
        else await loadNewType(type, subject, count);
        if (questions.length === 0) throw new Error('æ²’æœ‰æ‰¾åˆ°é¡Œç›®');
        document.getElementById('loadingBox').classList.add('hidden');
        document.getElementById('questionCard').classList.remove('hidden');
        startTimer();
        renderQuestion();
      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        document.getElementById('loadingBox').classList.add('hidden');
        alert('è¼‰å…¥å¤±æ•—: ' + error.message);
        document.getElementById('settingsModal').classList.remove('hidden');
      }
    }

    async function loadSingleChoice(subject, count) {
      const url = `${API_BASE}/api/v2/questions?count=${count}${subject ? '&subject=' + encodeURIComponent(subject) : ''}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      questions = data.data || [];
    }

    async function loadNewType(type, subject, count) {
      const url = `${API_BASE}/api/v2/types/${type}?count=${count}${subject ? '&subject=' + encodeURIComponent(subject) : ''}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.success) throw new Error(data.error);
      questions = data.data || [];
    }

    async function loadMixedQuestions(subject, count) {
      const single = Math.ceil(count * 0.4), others = Math.max(1, Math.floor(count * 0.15));
      const sp = subject ? '&subject=' + encodeURIComponent(subject) : '';
      const results = await Promise.allSettled([
        fetch(`${API_BASE}/api/v2/questions?count=${single}${sp}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/matching?count=${others}${sp}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/ordering?count=${others}${sp}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/fill_blank?count=${others}${sp}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/multiple_select?count=${others}${sp}`).then(r => r.json())
      ]);
      questions = [];
      results.forEach(r => { if (r.status === 'fulfilled' && r.value.success) questions.push(...(r.value.data || [])); });
      questions = questions.sort(() => Math.random() - 0.5).slice(0, count);
    }

    function startTimer() {
      timer = 0;
      timerInterval = setInterval(() => {
        timer++;
        document.getElementById('timer').textContent = `${Math.floor(timer/60).toString().padStart(2,'0')}:${(timer%60).toString().padStart(2,'0')}`;
      }, 1000);
    }

    function showScorePopup(correct, points) {
      const popup = document.getElementById('scorePopup');
      popup.textContent = correct ? `+${points}` : 'âœ—';
      popup.className = `score-popup ${correct ? 'score-correct' : 'score-wrong'}`;
      popup.classList.remove('hidden');
      setTimeout(() => popup.classList.add('hidden'), 1000);
    }

    function updateStreak(correct) {
      if (correct) { streak++; document.getElementById('streakEmoji').textContent = streak >= 5 ? 'ğŸ”¥ğŸ”¥' : 'ğŸ”¥'; }
      else { streak = 0; document.getElementById('streakEmoji').textContent = 'ğŸ’ª'; }
      document.getElementById('streak').textContent = streak;
    }

    function resetAnswers() {
      singleAnswer = null;
      multiAnswers = [];
      matchingData = { matches: {}, selectedLeft: null };
      orderingData = [];
    }

    function renderQuestion() {
      if (currentIndex >= questions.length) { showResult(); return; }
      const q = questions[currentIndex];
      document.getElementById('progressBar').style.width = `${((currentIndex + 1) / questions.length) * 100}%`;
      document.getElementById('questionNum').textContent = `${currentIndex + 1} / ${questions.length}`;
      document.getElementById('subjectBadge').textContent = q.subject || 'ç¶œåˆ';
      const type = q.type || 'single_choice';
      document.getElementById('typeBadge').textContent = `${typeIcons[type] || 'ğŸ“'} ${typeNames[type] || type}`;
      
      // é‡è¨­ç­”æ¡ˆ
      resetAnswers();
      
      switch (type) {
        case 'single_choice': renderSingleChoice(q); break;
        case 'matching': renderMatching(q); break;
        case 'ordering': renderOrdering(q); break;
        case 'fill_blank': renderFillBlank(q); break;
        case 'multiple_select': renderMultipleSelect(q); break;
      }
      document.getElementById('submitBtn').classList.remove('hidden');
      document.getElementById('nextBtn').classList.add('hidden');
      document.getElementById('explanationBox').classList.add('hidden');
    }

    // ===== å–®é¸é¡Œ =====
    function renderSingleChoice(q) {
      document.getElementById('questionStem').textContent = q.stem || q.question;
      document.getElementById('questionContent').innerHTML = (q.options || []).map((opt, i) => `
        <div class="option-card rounded-xl p-4 mb-3" onclick="selectSingleOption(${i})" data-index="${i}">
          <span class="inline-flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full font-bold mr-3">${String.fromCharCode(65+i)}</span>${opt}
        </div>
      `).join('');
    }
    
    function selectSingleOption(i) {
      document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.option-card[data-index="${i}"]`).classList.add('selected');
      singleAnswer = i;
    }

    // ===== é…å°é¡Œ =====
    function renderMatching(q) {
      document.getElementById('questionStem').textContent = q.instruction;
      document.getElementById('questionContent').innerHTML = `
        <div class="grid grid-cols-2 gap-6">
          <div id="leftColumn" class="space-y-3">${(q.leftItems||[]).map((item,i) => `<div class="matching-item" data-side="left" data-index="${i}" onclick="selectMatchingItem('left',${i})"><span class="inline-flex items-center justify-center w-6 h-6 bg-indigo-100 text-indigo-700 rounded-full text-sm font-bold mr-3">${i+1}</span>${item}</div>`).join('')}</div>
          <div id="rightColumn" class="space-y-3">${(q.rightItems||[]).map((item,i) => `<div class="matching-item" data-side="right" data-index="${i}" onclick="selectMatchingItem('right',${i})"><span class="inline-flex items-center justify-center w-6 h-6 bg-purple-100 text-purple-700 rounded-full text-sm font-bold mr-3">${String.fromCharCode(65+i)}</span>${item}</div>`).join('')}</div>
        </div>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-600">ğŸ’¡ é»æ“Šå·¦æ¬„ï¼Œå†é»æ“Šå³æ¬„é…å°</div>`;
    }
    
    function selectMatchingItem(side, i) {
      if (side === 'left') {
        document.querySelectorAll('#leftColumn .matching-item').forEach(el => el.classList.remove('selected'));
        document.querySelector(`#leftColumn .matching-item[data-index="${i}"]`).classList.add('selected');
        matchingData.selectedLeft = i;
      } else if (matchingData.selectedLeft !== null) {
        matchingData.matches[matchingData.selectedLeft] = i;
        document.querySelector(`#leftColumn .matching-item[data-index="${matchingData.selectedLeft}"]`).classList.replace('selected','matched');
        document.querySelector(`#rightColumn .matching-item[data-index="${i}"]`).classList.add('matched');
        matchingData.selectedLeft = null;
      }
    }

    // ===== æ’åºé¡Œ =====
    function renderOrdering(q) {
      document.getElementById('questionStem').textContent = q.instruction;
      document.getElementById('questionContent').innerHTML = `
        <div id="sortableList" class="space-y-3">${(q.items||[]).map((item,i) => `<div class="sortable-item" draggable="true" data-index="${i}" data-original="${i}"><span class="handle">â˜°</span><span class="number">${i+1}</span>${item}</div>`).join('')}</div>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-600">ğŸ’¡ æ‹–æ›³èª¿æ•´é †åº</div>`;
      initSortable();
    }
    
    function initSortable() {
      const list = document.getElementById('sortableList');
      let draggedItem = null;
      list.querySelectorAll('.sortable-item').forEach(item => {
        item.addEventListener('dragstart', function() { draggedItem = this; this.classList.add('dragging'); });
        item.addEventListener('dragend', function() { this.classList.remove('dragging'); updateSortNumbers(); updateSortOrder(); });
        item.addEventListener('dragover', function(e) { e.preventDefault(); const after = getDragAfterElement(list, e.clientY); after ? list.insertBefore(draggedItem, after) : list.appendChild(draggedItem); });
      });
    }
    
    function getDragAfterElement(container, y) {
      return [...container.querySelectorAll('.sortable-item:not(.dragging)')].reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return offset < 0 && offset > closest.offset ? { offset, element: child } : closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function updateSortNumbers() { document.querySelectorAll('#sortableList .sortable-item').forEach((el, i) => el.querySelector('.number').textContent = i + 1); }
    function updateSortOrder() { orderingData = Array.from(document.querySelectorAll('#sortableList .sortable-item')).map(el => parseInt(el.dataset.original)); }

    // ===== å¡«ç©ºé¡Œ =====
    function renderFillBlank(q) {
      document.getElementById('questionStem').textContent = q.stem;
      document.getElementById('questionContent').innerHTML = `
        <div class="flex flex-col items-center gap-4 py-4">
          <input type="text" id="fillBlankInput" class="fill-blank-input" placeholder="è¼¸å…¥ç­”æ¡ˆ" onkeypress="if(event.key==='Enter')checkAnswer()">
          ${q.hint ? `<div class="text-sm text-gray-500">ğŸ’¡ æç¤º: ${q.hint}</div>` : ''}
        </div>`;
      setTimeout(() => document.getElementById('fillBlankInput').focus(), 100);
    }

    // ===== å¤šé¸é¡Œ =====
    function renderMultipleSelect(q) {
      document.getElementById('questionStem').textContent = q.stem;
      document.getElementById('questionContent').innerHTML = `
        <div class="space-y-3">${(q.options||[]).map((opt,i) => `<div class="multi-option" onclick="toggleMultiAnswer(${i})" data-index="${i}"><div class="checkbox">âœ“</div><span class="font-bold mr-2">${String.fromCharCode(65+i)}.</span>${opt}</div>`).join('')}</div>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-600">ğŸ’¡ å¯é¸å¤šå€‹ç­”æ¡ˆï¼ˆéƒ¨åˆ†çµ¦åˆ†ï¼‰</div>`;
      // ç¢ºä¿ multiAnswers å·²é‡è¨­ç‚ºç©ºé™£åˆ—
      multiAnswers = [];
    }
    
    function toggleMultiAnswer(i) {
      const el = document.querySelector(`.multi-option[data-index="${i}"]`);
      const letter = String.fromCharCode(65 + i);
      
      console.log('é»æ“Šé¸é …:', letter, 'ç•¶å‰é¸æ“‡:', multiAnswers);
      
      const idx = multiAnswers.indexOf(letter);
      if (idx > -1) {
        // å·²é¸å–ï¼Œç§»é™¤
        multiAnswers.splice(idx, 1);
        el.classList.remove('selected');
      } else {
        // æœªé¸å–ï¼ŒåŠ å…¥
        multiAnswers.push(letter);
        el.classList.add('selected');
      }
      
      console.log('æ›´æ–°å¾Œé¸æ“‡:', multiAnswers);
    }

    // ===== æª¢æŸ¥ç­”æ¡ˆ =====
    async function checkAnswer() {
      const q = questions[currentIndex];
      const type = q.type || 'single_choice';
      let correct = false, points = 0;

      switch (type) {
        case 'single_choice':
          if (singleAnswer === null) { alert('è«‹é¸æ“‡ç­”æ¡ˆ'); return; }
          const userAns = String.fromCharCode(65 + singleAnswer);
          correct = userAns === q.answer;
          points = correct ? 100 : 0;
          document.querySelectorAll('.option-card').forEach((el, i) => {
            el.classList.add('disabled');
            if (String.fromCharCode(65+i) === q.answer) el.classList.add('correct');
            else if (i === singleAnswer && !correct) el.classList.add('wrong');
          });
          break;
          
        case 'matching':
          const leftCount = (q.leftItems||[]).length;
          if (Object.keys(matchingData.matches).length < leftCount) { alert('è«‹å®Œæˆæ‰€æœ‰é…å°'); return; }
          let matchAns = []; 
          for (let i = 0; i < leftCount; i++) matchAns.push(matchingData.matches[i]);
          correct = JSON.stringify(matchAns) === JSON.stringify(q.answer);
          points = correct ? 100 : 0;
          for (let i = 0; i < leftCount; i++) {
            const leftEl = document.querySelector(`#leftColumn .matching-item[data-index="${i}"]`);
            const rightEl = document.querySelector(`#rightColumn .matching-item[data-index="${matchingData.matches[i]}"]`);
            if (matchingData.matches[i] === q.answer[i]) { leftEl.classList.add('matched'); rightEl.classList.add('matched'); }
            else { leftEl.classList.add('wrong-match'); rightEl.classList.add('wrong-match'); }
          }
          break;
          
        case 'ordering':
          updateSortOrder();
          if (orderingData.length === 0) orderingData = Array.from(document.querySelectorAll('#sortableList .sortable-item')).map(el => parseInt(el.dataset.original));
          correct = JSON.stringify(orderingData) === JSON.stringify(q.answer);
          points = correct ? 100 : 0;
          break;
          
        case 'fill_blank':
          const input = document.getElementById('fillBlankInput');
          if (!input.value.trim()) { alert('è«‹è¼¸å…¥ç­”æ¡ˆ'); return; }
          correct = input.value.trim().toLowerCase() === String(q.answer).toLowerCase();
          points = correct ? 100 : 0;
          input.classList.add(correct ? 'correct' : 'wrong');
          input.disabled = true;
          break;
          
        case 'multiple_select':
          if (multiAnswers.length === 0) { alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç­”æ¡ˆ'); return; }
          const correctAns = (q.answer||[]).sort();
          const userSel = [...multiAnswers].sort();
          const correctSet = new Set(correctAns);
          const userSet = new Set(userSel);
          const correctCount = [...userSet].filter(x => correctSet.has(x)).length;
          const wrongCount = [...userSet].filter(x => !correctSet.has(x)).length;
          
          if (wrongCount === 0 && correctCount === correctSet.size) { 
            points = 100; 
            correct = true; 
          } else if (wrongCount <= 1 && correctCount > 0) {
            points = 60;
          } else if (wrongCount <= 2 && correctCount > 0) {
            points = 20;
          }
          
          document.querySelectorAll('.multi-option').forEach((el, i) => {
            const letter = String.fromCharCode(65 + i);
            if (correctSet.has(letter)) el.classList.add('correct-option');
            else if (userSet.has(letter)) el.classList.add('wrong-option');
          });
          break;
      }

      score += points;
      document.getElementById('score').textContent = `${Math.round(score / (currentIndex + 1))} åˆ†`;
      showScorePopup(points > 0, points);
      updateStreak(points >= 60);
      if (q.explanation) { document.getElementById('explanationText').textContent = q.explanation; document.getElementById('explanationBox').classList.remove('hidden'); }
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('nextBtn').classList.remove('hidden');
    }

    function nextQuestion() { currentIndex++; renderQuestion(); }

    function showResult() {
      clearInterval(timerInterval);
      const avgScore = questions.length > 0 ? Math.round(score / questions.length) : 0;
      const mins = Math.floor(timer / 60), secs = timer % 60;
      let grade = '', emoji = '';
      if (avgScore >= 90) { grade = 'S'; emoji = 'ğŸ†'; }
      else if (avgScore >= 80) { grade = 'A'; emoji = 'ğŸ‰'; }
      else if (avgScore >= 70) { grade = 'B'; emoji = 'ğŸ‘'; }
      else if (avgScore >= 60) { grade = 'C'; emoji = 'ğŸ’ª'; }
      else { grade = 'D'; emoji = 'ğŸ“š'; }
      document.getElementById('questionInfo').classList.add('hidden');
      document.getElementById('questionCard').innerHTML = `
        <div class="text-center py-8">
          <div class="text-8xl mb-6">${emoji}</div>
          <h2 class="text-3xl font-bold mb-2">ç·´ç¿’å®Œæˆï¼</h2>
          <div class="text-6xl font-bold text-indigo-600 mb-2">${avgScore} åˆ†</div>
          <div class="text-2xl font-bold text-gray-400 mb-4">ç­‰ç´š ${grade}</div>
          <div class="text-gray-500 mb-6">â±ï¸ ${mins}åˆ†${secs}ç§’ | ğŸ”¥ é€£å‹ ${streak}</div>
          <div class="flex justify-center gap-4">
            <button onclick="location.reload()" class="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold">ğŸ”„ å†ç·´ä¸€æ¬¡</button>
            <a href="dashboard.html" class="px-8 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold">ğŸ  è¿”å›é¦–é </a>
          </div>
        </div>`;
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('nextBtn').classList.add('hidden');
    }
  </script>
</body>
</html>
