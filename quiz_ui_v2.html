<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤šå…ƒé¡Œå‹ç·´ç¿’ - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="js/components.css">
  <style>
    :root {
      --primary: #4F46E5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
    }
    
    /* é€šç”¨é¸é …æ¨£å¼ */
    .option-card {
      transition: all 0.2s ease;
      border: 2px solid #E5E7EB;
      cursor: pointer;
    }
    .option-card:hover:not(.disabled) {
      border-color: var(--primary);
      transform: translateX(4px);
    }
    .option-card.selected {
      border-color: var(--primary);
      background: #EEF2FF;
    }
    .option-card.correct {
      border-color: var(--success);
      background: #DCFCE7;
    }
    .option-card.wrong {
      border-color: var(--danger);
      background: #FEE2E2;
    }
    .option-card.disabled { pointer-events: none; }
    
    /* é…å°é¡Œæ¨£å¼ */
    .matching-item {
      padding: 12px 16px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .matching-item:hover { border-color: var(--primary); }
    .matching-item.selected { border-color: var(--primary); background: #EEF2FF; }
    .matching-item.matched { border-color: var(--success); background: #DCFCE7; }
    .matching-line {
      stroke: var(--primary);
      stroke-width: 2;
      fill: none;
    }
    
    /* æ’åºé¡Œæ¨£å¼ */
    .sortable-item {
      padding: 12px 16px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }
    .sortable-item:active { cursor: grabbing; }
    .sortable-item.dragging {
      opacity: 0.5;
      border-color: var(--primary);
    }
    .sortable-item .handle {
      color: #9CA3AF;
      margin-right: 8px;
    }
    
    /* å¡«ç©ºé¡Œæ¨£å¼ */
    .fill-blank-input {
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 1.1rem;
      width: 200px;
      text-align: center;
      transition: all 0.2s;
    }
    .fill-blank-input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .fill-blank-input.correct { border-color: var(--success); background: #DCFCE7; }
    .fill-blank-input.wrong { border-color: var(--danger); background: #FEE2E2; }
    
    /* å¤šé¸é¡Œæ¨£å¼ */
    .multi-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .multi-option:hover { border-color: var(--primary); }
    .multi-option.selected { border-color: var(--primary); background: #EEF2FF; }
    .multi-option .checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #D1D5DB;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .multi-option.selected .checkbox {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* å‹•ç•« */
    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .animate-bounce-in { animation: bounceIn 0.5s ease; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- é ‚éƒ¨é€²åº¦æ¢ -->
  <div class="fixed top-0 left-0 right-0 h-1 bg-gray-200 z-50">
    <div id="progressBar" class="h-full bg-indigo-600 transition-all duration-300" style="width: 0%"></div>
  </div>

  <!-- é ‚éƒ¨å°èˆª -->
  <nav class="bg-white shadow-sm sticky top-0 z-40 mt-1">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="dashboard.html" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
        <span>â†</span> è¿”å›
      </a>
      <div class="flex items-center gap-4">
        <span id="timer" class="font-mono text-lg font-bold">â±ï¸ 00:00</span>
        <span id="score" class="font-bold text-indigo-600">ğŸ“Š 0åˆ†</span>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- é¡Œç›®è³‡è¨Š -->
    <div class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium" id="questionNum">1 / 10</span>
        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm" id="typeBadge">å–®é¸é¡Œ</span>
        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm" id="subjectBadge">æ•¸å­¸</span>
      </div>
    </div>

    <!-- é¡Œç›®å¡ç‰‡ -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4" id="questionStem">é¡Œç›®è¼‰å…¥ä¸­...</h2>
      
      <!-- å‹•æ…‹å…§å®¹å€ -->
      <div id="questionContent">
        <!-- æ ¹æ“šé¡Œå‹å‹•æ…‹æ¸²æŸ“ -->
      </div>
    </div>

    <!-- æäº¤æŒ‰éˆ• -->
    <div class="flex justify-center gap-4">
      <button id="submitBtn" onclick="checkAnswer()" 
              class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition">
        ç¢ºèªç­”æ¡ˆ
      </button>
      <button id="nextBtn" onclick="nextQuestion()" 
              class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition hidden">
        ä¸‹ä¸€é¡Œ â†’
      </button>
    </div>

    <!-- è§£æå€ -->
    <div id="explanationBox" class="mt-6 bg-green-50 border border-green-200 rounded-xl p-4 hidden">
      <h3 class="font-bold text-green-800 mb-2">ğŸ“– è§£æ</h3>
      <p id="explanationText" class="text-green-700"></p>
    </div>
  </main>

  <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">ğŸ¯ é¸æ“‡ç·´ç¿’æ¨¡å¼</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ç§‘ç›®</label>
          <select id="subjectSelect" class="w-full border rounded-lg px-4 py-2">
            <option value="">å…¨éƒ¨ç§‘ç›®</option>
            <option value="æ•¸å­¸">æ•¸å­¸</option>
            <option value="ç‰©ç†">ç‰©ç†</option>
            <option value="åŒ–å­¸">åŒ–å­¸</option>
            <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
            <option value="åœ‹æ–‡">åœ‹æ–‡</option>
            <option value="è‹±æ–‡">è‹±æ–‡</option>
            <option value="æ­·å²">æ­·å²</option>
            <option value="åœ°ç†">åœ°ç†</option>
            <option value="å…¬æ°‘">å…¬æ°‘</option>
            <option value="åœ°ç§‘">åœ°ç§‘</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¡Œå‹</label>
          <select id="typeSelect" class="w-full border rounded-lg px-4 py-2">
            <option value="mixed">æ··åˆé¡Œå‹</option>
            <option value="single_choice">å–®é¸é¡Œ</option>
            <option value="matching">é…å°é¡Œ</option>
            <option value="ordering">æ’åºé¡Œ</option>
            <option value="fill_blank">å¡«ç©ºé¡Œ</option>
            <option value="multiple_select">å¤šé¸é¡Œ</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¡Œæ•¸</label>
          <select id="countSelect" class="w-full border rounded-lg px-4 py-2">
            <option value="5">5 é¡Œ</option>
            <option value="10" selected>10 é¡Œ</option>
            <option value="20">20 é¡Œ</option>
          </select>
        </div>
      </div>
      
      <button onclick="startQuiz()" 
              class="w-full mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">
        é–‹å§‹ç·´ç¿’ ğŸš€
      </button>
    </div>
  </div>

  <script>
    // ============================================================
    // è¨­å®š
    // ============================================================
    const API_BASE = 'https://beidou-edu-api.onrender.com'; // ä¿®æ”¹ç‚ºå¯¦éš› API
    // const API_BASE = 'http://localhost:10000'; // æœ¬åœ°æ¸¬è©¦ç”¨
    
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let userAnswers = {};
    let timer = 0;
    let timerInterval = null;
    
    // ============================================================
    // åˆå§‹åŒ–
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      // é¡¯ç¤ºè¨­å®šæ¨¡æ…‹æ¡†
    });
    
    async function startQuiz() {
      const subject = document.getElementById('subjectSelect').value;
      const type = document.getElementById('typeSelect').value;
      const count = parseInt(document.getElementById('countSelect').value);
      
      document.getElementById('settingsModal').classList.add('hidden');
      
      // è¼‰å…¥é¡Œç›®
      try {
        if (type === 'mixed') {
          await loadMixedQuestions(subject, count);
        } else if (type === 'single_choice') {
          await loadSingleChoice(subject, count);
        } else {
          await loadNewType(type, subject, count);
        }
        
        startTimer();
        renderQuestion();
      } catch (error) {
        console.error('è¼‰å…¥é¡Œç›®å¤±æ•—:', error);
        alert('è¼‰å…¥é¡Œç›®å¤±æ•—ï¼Œè«‹é‡è©¦');
      }
    }
    
    // ============================================================
    // API å‘¼å«
    // ============================================================
    async function loadSingleChoice(subject, count) {
      const url = `${API_BASE}/api/v2/questions?count=${count}${subject ? '&subject=' + subject : ''}`;
      const res = await fetch(url);
      const data = await res.json();
      questions = data.data || [];
    }
    
    async function loadNewType(type, subject, count) {
      const url = `${API_BASE}/api/v2/types/${type}?count=${count}${subject ? '&subject=' + subject : ''}`;
      const res = await fetch(url);
      const data = await res.json();
      questions = data.data || [];
    }
    
    async function loadMixedQuestions(subject, count) {
      // æ··åˆè¼‰å…¥å„é¡Œå‹
      const single = Math.ceil(count * 0.4);
      const others = Math.floor(count * 0.15);
      
      const [q1, q2, q3, q4, q5] = await Promise.all([
        fetch(`${API_BASE}/api/v2/questions?count=${single}${subject ? '&subject=' + subject : ''}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/matching?count=${others}${subject ? '&subject=' + subject : ''}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/ordering?count=${others}${subject ? '&subject=' + subject : ''}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/fill_blank?count=${others}${subject ? '&subject=' + subject : ''}`).then(r => r.json()),
        fetch(`${API_BASE}/api/v2/types/multiple_select?count=${others}${subject ? '&subject=' + subject : ''}`).then(r => r.json())
      ]);
      
      questions = [
        ...(q1.data || []),
        ...(q2.data || []),
        ...(q3.data || []),
        ...(q4.data || []),
        ...(q5.data || [])
      ];
      
      // æ‰“äº‚é †åº
      questions = questions.sort(() => Math.random() - 0.5);
    }
    
    // ============================================================
    // è¨ˆæ™‚å™¨
    // ============================================================
    function startTimer() {
      timer = 0;
      timerInterval = setInterval(() => {
        timer++;
        const mins = Math.floor(timer / 60).toString().padStart(2, '0');
        const secs = (timer % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `â±ï¸ ${mins}:${secs}`;
      }, 1000);
    }
    
    // ============================================================
    // æ¸²æŸ“é¡Œç›®
    // ============================================================
    function renderQuestion() {
      if (currentIndex >= questions.length) {
        showResult();
        return;
      }
      
      const q = questions[currentIndex];
      const progress = ((currentIndex + 1) / questions.length) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
      document.getElementById('questionNum').textContent = `${currentIndex + 1} / ${questions.length}`;
      document.getElementById('subjectBadge').textContent = q.subject || 'ç¶œåˆ';
      
      // æ ¹æ“šé¡Œå‹æ¸²æŸ“
      const type = q.type || 'single_choice';
      const typeNames = {
        'single_choice': 'å–®é¸é¡Œ',
        'matching': 'é…å°é¡Œ',
        'ordering': 'æ’åºé¡Œ',
        'fill_blank': 'å¡«ç©ºé¡Œ',
        'multiple_select': 'å¤šé¸é¡Œ'
      };
      document.getElementById('typeBadge').textContent = typeNames[type] || type;
      
      switch (type) {
        case 'single_choice':
          renderSingleChoice(q);
          break;
        case 'matching':
          renderMatching(q);
          break;
        case 'ordering':
          renderOrdering(q);
          break;
        case 'fill_blank':
          renderFillBlank(q);
          break;
        case 'multiple_select':
          renderMultipleSelect(q);
          break;
      }
      
      // é‡è¨­æŒ‰éˆ•ç‹€æ…‹
      document.getElementById('submitBtn').classList.remove('hidden');
      document.getElementById('nextBtn').classList.add('hidden');
      document.getElementById('explanationBox').classList.add('hidden');
      userAnswers = {};
    }
    
    // ============================================================
    // å–®é¸é¡Œ
    // ============================================================
    function renderSingleChoice(q) {
      document.getElementById('questionStem').textContent = q.stem || q.question;
      
      const options = q.options || [];
      const html = options.map((opt, i) => `
        <div class="option-card rounded-lg p-4 mb-3" onclick="selectOption(${i})" data-index="${i}">
          <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span>
          <span>${opt}</span>
        </div>
      `).join('');
      
      document.getElementById('questionContent').innerHTML = html;
    }
    
    function selectOption(index) {
      document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
      document.querySelector(`.option-card[data-index="${index}"]`).classList.add('selected');
      userAnswers.selected = index;
    }
    
    // ============================================================
    // é…å°é¡Œ
    // ============================================================
    function renderMatching(q) {
      document.getElementById('questionStem').textContent = q.instruction;
      
      const leftItems = q.leftItems || [];
      const rightItems = q.rightItems || [];
      
      const html = `
        <div class="grid grid-cols-2 gap-8">
          <div class="space-y-3" id="leftColumn">
            ${leftItems.map((item, i) => `
              <div class="matching-item" data-side="left" data-index="${i}" onclick="selectMatching('left', ${i})">
                ${i + 1}. ${item}
              </div>
            `).join('')}
          </div>
          <div class="space-y-3" id="rightColumn">
            ${rightItems.map((item, i) => `
              <div class="matching-item" data-side="right" data-index="${i}" onclick="selectMatching('right', ${i})">
                ${String.fromCharCode(65 + i)}. ${item}
              </div>
            `).join('')}
          </div>
        </div>
        <div class="mt-4 text-sm text-gray-500">é»æ“Šå·¦æ¬„é …ç›®ï¼Œå†é»æ“Šå³æ¬„å°æ‡‰é …ç›®é€²è¡Œé…å°</div>
      `;
      
      document.getElementById('questionContent').innerHTML = html;
      userAnswers.matches = {};
      userAnswers.selectedLeft = null;
    }
    
    function selectMatching(side, index) {
      if (side === 'left') {
        document.querySelectorAll('#leftColumn .matching-item').forEach(el => el.classList.remove('selected'));
        document.querySelector(`#leftColumn .matching-item[data-index="${index}"]`).classList.add('selected');
        userAnswers.selectedLeft = index;
      } else if (side === 'right' && userAnswers.selectedLeft !== null) {
        // é…å°å®Œæˆ
        userAnswers.matches[userAnswers.selectedLeft] = index;
        
        // æ›´æ–°è¦–è¦º
        const leftEl = document.querySelector(`#leftColumn .matching-item[data-index="${userAnswers.selectedLeft}"]`);
        const rightEl = document.querySelector(`#rightColumn .matching-item[data-index="${index}"]`);
        leftEl.classList.remove('selected');
        leftEl.classList.add('matched');
        rightEl.classList.add('matched');
        
        userAnswers.selectedLeft = null;
      }
    }
    
    // ============================================================
    // æ’åºé¡Œ
    // ============================================================
    function renderOrdering(q) {
      document.getElementById('questionStem').textContent = q.instruction;
      
      const items = q.items || [];
      
      const html = `
        <div id="sortableList" class="space-y-3">
          ${items.map((item, i) => `
            <div class="sortable-item flex items-center" draggable="true" data-index="${i}">
              <span class="handle">â˜°</span>
              <span class="font-bold mr-2">${i + 1}.</span>
              <span>${item}</span>
            </div>
          `).join('')}
        </div>
        <div class="mt-4 text-sm text-gray-500">æ‹–æ›³é …ç›®èª¿æ•´é †åº</div>
      `;
      
      document.getElementById('questionContent').innerHTML = html;
      initSortable();
    }
    
    function initSortable() {
      const list = document.getElementById('sortableList');
      let draggedItem = null;
      
      list.querySelectorAll('.sortable-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
          draggedItem = this;
          this.classList.add('dragging');
        });
        
        item.addEventListener('dragend', function() {
          this.classList.remove('dragging');
          updateSortOrder();
        });
        
        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          const afterElement = getDragAfterElement(list, e.clientY);
          if (afterElement == null) {
            list.appendChild(draggedItem);
          } else {
            list.insertBefore(draggedItem, afterElement);
          }
        });
      });
    }
    
    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
      return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    function updateSortOrder() {
      const items = document.querySelectorAll('#sortableList .sortable-item');
      userAnswers.order = Array.from(items).map(el => parseInt(el.dataset.index));
    }
    
    // ============================================================
    // å¡«ç©ºé¡Œ
    // ============================================================
    function renderFillBlank(q) {
      document.getElementById('questionStem').textContent = q.stem;
      
      const html = `
        <div class="flex flex-col items-center gap-4">
          <input type="text" id="fillBlankInput" class="fill-blank-input" placeholder="è¼¸å…¥ç­”æ¡ˆ" autofocus>
          ${q.hint ? `<div class="text-sm text-gray-500">æç¤º: ${q.hint}</div>` : ''}
        </div>
      `;
      
      document.getElementById('questionContent').innerHTML = html;
    }
    
    // ============================================================
    // å¤šé¸é¡Œ
    // ============================================================
    function renderMultipleSelect(q) {
      document.getElementById('questionStem').textContent = q.stem;
      
      const options = q.options || [];
      
      const html = `
        <div class="space-y-3">
          ${options.map((opt, i) => `
            <div class="multi-option" onclick="toggleMultiOption(${i})" data-index="${i}">
              <div class="checkbox">âœ“</div>
              <span class="font-bold">${String.fromCharCode(65 + i)}.</span>
              <span>${opt}</span>
            </div>
          `).join('')}
        </div>
        <div class="mt-4 text-sm text-gray-500">å¯é¸æ“‡å¤šå€‹ç­”æ¡ˆ</div>
      `;
      
      document.getElementById('questionContent').innerHTML = html;
      userAnswers.selected = [];
    }
    
    function toggleMultiOption(index) {
      const el = document.querySelector(`.multi-option[data-index="${index}"]`);
      const letter = String.fromCharCode(65 + index);
      
      if (userAnswers.selected.includes(letter)) {
        userAnswers.selected = userAnswers.selected.filter(x => x !== letter);
        el.classList.remove('selected');
      } else {
        userAnswers.selected.push(letter);
        el.classList.add('selected');
      }
    }
    
    // ============================================================
    // æª¢æŸ¥ç­”æ¡ˆ
    // ============================================================
    async function checkAnswer() {
      const q = questions[currentIndex];
      const type = q.type || 'single_choice';
      
      let userAnswer;
      let correct = false;
      
      switch (type) {
        case 'single_choice':
          if (userAnswers.selected === undefined) {
            alert('è«‹é¸æ“‡ç­”æ¡ˆ');
            return;
          }
          userAnswer = String.fromCharCode(65 + userAnswers.selected);
          correct = userAnswer === q.answer;
          
          // é¡¯ç¤ºå°éŒ¯
          document.querySelectorAll('.option-card').forEach((el, i) => {
            el.classList.add('disabled');
            const letter = String.fromCharCode(65 + i);
            if (letter === q.answer) el.classList.add('correct');
            else if (i === userAnswers.selected) el.classList.add('wrong');
          });
          break;
          
        case 'matching':
          if (Object.keys(userAnswers.matches).length < (q.leftItems || []).length) {
            alert('è«‹å®Œæˆæ‰€æœ‰é…å°');
            return;
          }
          userAnswer = Object.values(userAnswers.matches);
          correct = JSON.stringify(userAnswer) === JSON.stringify(q.answer);
          break;
          
        case 'ordering':
          updateSortOrder();
          if (!userAnswers.order) {
            alert('è«‹æ’åºé …ç›®');
            return;
          }
          userAnswer = userAnswers.order;
          correct = JSON.stringify(userAnswer) === JSON.stringify(q.answer);
          break;
          
        case 'fill_blank':
          const input = document.getElementById('fillBlankInput');
          userAnswer = input.value.trim();
          if (!userAnswer) {
            alert('è«‹è¼¸å…¥ç­”æ¡ˆ');
            return;
          }
          correct = String(userAnswer).toLowerCase() === String(q.answer).toLowerCase();
          input.classList.add(correct ? 'correct' : 'wrong');
          break;
          
        case 'multiple_select':
          if (userAnswers.selected.length === 0) {
            alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ç­”æ¡ˆ');
            return;
          }
          userAnswer = userAnswers.selected.sort();
          const correctAns = (q.answer || []).sort();
          correct = JSON.stringify(userAnswer) === JSON.stringify(correctAns);
          
          // éƒ¨åˆ†çµ¦åˆ†è¨ˆç®—
          const correctSet = new Set(correctAns);
          const userSet = new Set(userAnswer);
          const correctCount = [...userSet].filter(x => correctSet.has(x)).length;
          const wrongCount = [...userSet].filter(x => !correctSet.has(x)).length;
          
          if (wrongCount === 0 && correctCount === correctSet.size) {
            score += 100;
          } else if (wrongCount <= 1) {
            score += 60;
          } else if (wrongCount <= 2) {
            score += 20;
          }
          break;
      }
      
      if (type !== 'multiple_select') {
        score += correct ? 100 : 0;
      }
      
      document.getElementById('score').textContent = `ğŸ“Š ${Math.round(score / (currentIndex + 1))}åˆ†`;
      
      // é¡¯ç¤ºè§£æ
      if (q.explanation) {
        document.getElementById('explanationText').textContent = q.explanation;
        document.getElementById('explanationBox').classList.remove('hidden');
      }
      
      // åˆ‡æ›æŒ‰éˆ•
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('nextBtn').classList.remove('hidden');
    }
    
    // ============================================================
    // ä¸‹ä¸€é¡Œ
    // ============================================================
    function nextQuestion() {
      currentIndex++;
      renderQuestion();
    }
    
    // ============================================================
    // é¡¯ç¤ºçµæœ
    // ============================================================
    function showResult() {
      clearInterval(timerInterval);
      
      const avgScore = Math.round(score / questions.length);
      const mins = Math.floor(timer / 60);
      const secs = timer % 60;
      
      document.getElementById('questionContent').innerHTML = `
        <div class="text-center py-8">
          <div class="text-6xl mb-4">${avgScore >= 80 ? 'ğŸ‰' : avgScore >= 60 ? 'ğŸ‘' : 'ğŸ’ª'}</div>
          <h2 class="text-2xl font-bold mb-2">ç·´ç¿’å®Œæˆï¼</h2>
          <div class="text-4xl font-bold text-indigo-600 mb-4">${avgScore} åˆ†</div>
          <div class="text-gray-500 mb-6">ç”¨æ™‚ ${mins} åˆ† ${secs} ç§’</div>
          <div class="flex justify-center gap-4">
            <button onclick="location.reload()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg">å†ç·´ä¸€æ¬¡</button>
            <a href="dashboard.html" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg">è¿”å›é¦–é </a>
          </div>
        </div>
      `;
      
      document.getElementById('questionStem').textContent = '';
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('nextBtn').classList.add('hidden');
    }
  </script>
</body>
</html>
