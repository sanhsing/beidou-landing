<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹å­¸ç¿’ - åŒ—æ–—æ•™è‚²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        .card { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .lesson-item { transition: all 0.2s ease; }
        .lesson-item:hover { background: rgba(139,92,246,0.2); }
        .lesson-item.completed { border-left: 3px solid #10b981; }
        .lesson-item.current { border-left: 3px solid #8b5cf6; background: rgba(139,92,246,0.1); }
        .video-placeholder { aspect-ratio: 16/9; background: linear-gradient(45deg, #1e1b4b, #312e81); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-gray-800/80 backdrop-blur border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="courses.html" class="text-gray-400 hover:text-white">â† è¿”å›èª²ç¨‹</a>
                <span id="courseName" class="font-bold text-purple-400"></span>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm">
                    <span class="text-gray-400">é€²åº¦ï¼š</span>
                    <span id="progressPercent" class="text-purple-400 font-bold">0%</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- å´é‚Šæ¬„ï¼šèª²ç¨‹å¤§ç¶± -->
        <aside id="sidebar" class="w-80 bg-gray-800/50 border-r border-white/10 h-[calc(100vh-57px)] overflow-y-auto sticky top-[57px] hidden lg:block">
            <div class="p-4">
                <h2 class="font-bold mb-4">ğŸ“š èª²ç¨‹å¤§ç¶±</h2>
                <div id="moduleList" class="space-y-2">
                    <div class="text-gray-500">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </aside>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="flex-1 min-h-[calc(100vh-57px)]">
            <!-- å…§å®¹å€ -->
            <div class="max-w-4xl mx-auto p-6">
                <!-- èª²ç¨‹å…§å®¹æ¨™é¡Œ -->
                <div class="mb-6">
                    <div class="text-sm text-gray-400 mb-1" id="moduleTitle">Module 1</div>
                    <h1 class="text-2xl font-bold" id="lessonTitle">èª²ç¨‹å…§å®¹</h1>
                </div>

                <!-- å½±ç‰‡/å…§å®¹å€ -->
                <div class="card rounded-2xl overflow-hidden mb-6">
                    <div id="contentArea" class="video-placeholder flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ“–</div>
                            <div class="text-gray-400">é¸æ“‡å·¦å´ç« ç¯€é–‹å§‹å­¸ç¿’</div>
                        </div>
                    </div>
                </div>

                <!-- èª²ç¨‹èªªæ˜ -->
                <div class="card rounded-2xl p-6 mb-6">
                    <h3 class="font-bold mb-3">ğŸ“ æœ¬ç¯€é‡é»</h3>
                    <div id="lessonContent" class="text-gray-300 space-y-3">
                        <p>è«‹å¾å·¦å´é¸æ“‡ç« ç¯€é–‹å§‹å­¸ç¿’ã€‚</p>
                    </div>
                </div>

                <!-- ç·´ç¿’é¡Œå€ -->
                <div id="quizSection" class="hidden">
                    <div class="card rounded-2xl p-6 mb-6">
                        <h3 class="font-bold mb-4">ğŸ¯ éš¨å ‚æ¸¬é©—</h3>
                        <div id="quizContent"></div>
                    </div>
                </div>

                <!-- åº•éƒ¨å°èˆª -->
                <div class="flex justify-between items-center py-4">
                    <button onclick="prevLesson()" id="prevBtn" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg transition disabled:opacity-50" disabled>
                        â† ä¸Šä¸€ç¯€
                    </button>
                    <button onclick="completeAndNext()" id="nextBtn" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg transition">
                        å®Œæˆä¸¦ç¹¼çºŒ â†’
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ç§»å‹•ç«¯å¤§ç¶±æŠ½å±œ -->
    <div id="mobileDrawer" class="fixed inset-0 bg-black/70 z-50 hidden">
        <div class="absolute left-0 top-0 bottom-0 w-80 bg-gray-800 overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold">ğŸ“š èª²ç¨‹å¤§ç¶±</h2>
                    <button onclick="closeMobileDrawer()" class="text-gray-400 text-2xl">&times;</button>
                </div>
                <div id="mobileModuleList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- ç§»å‹•ç«¯å¤§ç¶±æŒ‰éˆ• -->
    <button onclick="openMobileDrawer()" class="lg:hidden fixed bottom-6 left-6 bg-purple-600 w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl z-40">
        ğŸ“‹
    </button>

    <!-- æ¸¬é©—å®Œæˆå½ˆçª— -->
    <div id="quizResultModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-md mx-4 text-center">
            <div id="resultIcon" class="text-6xl mb-4">ğŸ‰</div>
            <h3 id="resultTitle" class="text-2xl font-bold mb-2">æ¸¬é©—å®Œæˆï¼</h3>
            <p id="resultMessage" class="text-gray-400 mb-6"></p>
            <div class="flex gap-3">
                <button onclick="closeQuizResult()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg transition">
                    æŸ¥çœ‹è§£æ
                </button>
                <button onclick="closeQuizResult(); completeAndNext();" class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg transition">
                    ç¹¼çºŒå­¸ç¿’
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://beidou-edu-server-1.onrender.com';
        
        let currentUser = null;
        let courseId = null;
        let courseData = null;
        let progressData = null;
        let currentModuleIndex = 0;
        let currentLessonIndex = 0;
        let completedLessons = new Set();

        // èª²ç¨‹å…§å®¹æ¨¡æ¿ï¼ˆå¯¦éš›æ‡‰å¾å¾Œç«¯å–å¾—ï¼‰
        const COURSE_CONTENT = {
            'google-ai': {
                modules: [
                    {
                        id: 'ga-01',
                        name: 'AI åŸºç¤æ¦‚å¿µ',
                        lessons: [
                            { id: 'ga-01-01', title: 'ä»€éº¼æ˜¯äººå·¥æ™ºæ…§', content: 'äººå·¥æ™ºæ…§ï¼ˆAIï¼‰æ˜¯è®“é›»è…¦æ¨¡æ“¬äººé¡æ™ºæ…§çš„æŠ€è¡“ã€‚åŒ…æ‹¬æ©Ÿå™¨å­¸ç¿’ã€æ·±åº¦å­¸ç¿’ã€è‡ªç„¶èªè¨€è™•ç†ç­‰é ˜åŸŸã€‚', duration: '10åˆ†é˜' },
                            { id: 'ga-01-02', title: 'AI çš„ç™¼å±•æ­·å²', content: 'å¾ 1950 å¹´ä»£çš„åœ–éˆæ¸¬è©¦ï¼Œåˆ° 2020 å¹´ä»£çš„å¤§èªè¨€æ¨¡å‹ï¼ŒAI ç¶“æ­·äº†å¤šæ¬¡ç™¼å±•æµªæ½®ã€‚', duration: '12åˆ†é˜' },
                            { id: 'ga-01-03', title: 'AI çš„é¡å‹åˆ†é¡', content: 'å¼± AI vs å¼· AIã€ç›£ç£å¼å­¸ç¿’ vs éç›£ç£å¼å­¸ç¿’ã€ç”Ÿæˆå¼ AI vs åˆ¤åˆ¥å¼ AIã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-01-04', title: 'AI çš„æ‡‰ç”¨å ´æ™¯', content: 'é†«ç™‚è¨ºæ–·ã€è‡ªå‹•é§•é§›ã€æ¨è–¦ç³»çµ±ã€æ™ºæ…§å®¢æœã€ç¨‹å¼ç¢¼ç”Ÿæˆç­‰ã€‚', duration: '12åˆ†é˜' },
                            { id: 'ga-01-05', title: 'ç« ç¯€æ¸¬é©—', content: '', isQuiz: true, duration: '10åˆ†é˜' }
                        ]
                    },
                    {
                        id: 'ga-02',
                        name: 'Google AI ç”¢å“ç”Ÿæ…‹',
                        lessons: [
                            { id: 'ga-02-01', title: 'Google Cloud AI æœå‹™', content: 'Vertex AIã€AutoMLã€Document AIã€Vision AI ç­‰é›²ç«¯ AI æœå‹™ä»‹ç´¹ã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-02-02', title: 'Google Gemini ç³»åˆ—', content: 'Gemini Proã€Gemini Ultraã€Gemini Nano çš„ç‰¹é»èˆ‡æ‡‰ç”¨ã€‚', duration: '12åˆ†é˜' },
                            { id: 'ga-02-03', title: 'TensorFlow ç”Ÿæ…‹ç³»çµ±', content: 'TensorFlowã€TensorFlow.jsã€TensorFlow Lite çš„ä½¿ç”¨å ´æ™¯ã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-02-04', title: 'ç« ç¯€æ¸¬é©—', content: '', isQuiz: true, duration: '10åˆ†é˜' }
                        ]
                    },
                    {
                        id: 'ga-03',
                        name: 'æ©Ÿå™¨å­¸ç¿’åŸºç¤',
                        lessons: [
                            { id: 'ga-03-01', title: 'æ©Ÿå™¨å­¸ç¿’æ ¸å¿ƒæ¦‚å¿µ', content: 'ç‰¹å¾µå·¥ç¨‹ã€æ¨¡å‹è¨“ç·´ã€é©—è­‰ã€æ¸¬è©¦ã€éæ“¬åˆèˆ‡æ¬ æ“¬åˆã€‚', duration: '18åˆ†é˜' },
                            { id: 'ga-03-02', title: 'ç›£ç£å¼å­¸ç¿’', content: 'åˆ†é¡ã€å›æ­¸ã€æ±ºç­–æ¨¹ã€éš¨æ©Ÿæ£®æ—ã€æ”¯æŒå‘é‡æ©Ÿã€‚', duration: '20åˆ†é˜' },
                            { id: 'ga-03-03', title: 'éç›£ç£å¼å­¸ç¿’', content: 'èšé¡ã€é™ç¶­ã€K-meansã€PCAã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-03-04', title: 'æ¨¡å‹è©•ä¼°æŒ‡æ¨™', content: 'æº–ç¢ºç‡ã€ç²¾ç¢ºç‡ã€å¬å›ç‡ã€F1-Scoreã€ROC-AUCã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-03-05', title: 'å¯¦ä½œç·´ç¿’', content: 'ä½¿ç”¨ AutoML è¨“ç·´ä¸€å€‹åœ–ç‰‡åˆ†é¡æ¨¡å‹ã€‚', duration: '20åˆ†é˜' },
                            { id: 'ga-03-06', title: 'ç« ç¯€æ¸¬é©—', content: '', isQuiz: true, duration: '12åˆ†é˜' }
                        ]
                    },
                    {
                        id: 'ga-04',
                        name: 'ç”Ÿæˆå¼ AI èˆ‡ LLM',
                        lessons: [
                            { id: 'ga-04-01', title: 'ä»€éº¼æ˜¯ç”Ÿæˆå¼ AI', content: 'å¾åˆ¤åˆ¥å¼ AI åˆ°ç”Ÿæˆå¼ AI çš„æ¼”é€²ï¼ŒVAEã€GANã€Transformerã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-04-02', title: 'å¤§èªè¨€æ¨¡å‹åŸç†', content: 'Transformer æ¶æ§‹ã€æ³¨æ„åŠ›æ©Ÿåˆ¶ã€é è¨“ç·´èˆ‡å¾®èª¿ã€‚', duration: '20åˆ†é˜' },
                            { id: 'ga-04-03', title: 'Prompt Engineering', content: 'å¦‚ä½•æ’°å¯«æœ‰æ•ˆçš„æç¤ºè©ï¼ŒFew-shot Learningã€Chain of Thoughtã€‚', duration: '18åˆ†é˜' },
                            { id: 'ga-04-04', title: 'RAG èˆ‡å‘é‡è³‡æ–™åº«', content: 'æª¢ç´¢å¢å¼·ç”Ÿæˆã€Embeddingã€å‘é‡æœç´¢ã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-04-05', title: 'ç« ç¯€æ¸¬é©—', content: '', isQuiz: true, duration: '12åˆ†é˜' }
                        ]
                    },
                    {
                        id: 'ga-05',
                        name: 'è² è²¬ä»»çš„ AI',
                        lessons: [
                            { id: 'ga-05-01', title: 'AI å€«ç†åŸå‰‡', content: 'Google çš„ AI åŸå‰‡ã€å…¬å¹³æ€§ã€é€æ˜æ€§ã€å¯è§£é‡‹æ€§ã€‚', duration: '12åˆ†é˜' },
                            { id: 'ga-05-02', title: 'åè¦‹èˆ‡å…¬å¹³æ€§', content: 'æ•¸æ“šåè¦‹ã€ç®—æ³•åè¦‹ã€å¦‚ä½•æª¢æ¸¬èˆ‡ç·©è§£ã€‚', duration: '15åˆ†é˜' },
                            { id: 'ga-05-03', title: 'éš±ç§èˆ‡å®‰å…¨', content: 'å·®åˆ†éš±ç§ã€è¯é‚¦å­¸ç¿’ã€æ¨¡å‹å®‰å…¨ã€‚', duration: '12åˆ†é˜' },
                            { id: 'ga-05-04', title: 'ç« ç¯€æ¸¬é©—', content: '', isQuiz: true, duration: '10åˆ†é˜' }
                        ]
                    },
                    {
                        id: 'ga-06',
                        name: 'æ¨¡æ“¬æ¸¬é©—',
                        lessons: [
                            { id: 'ga-06-01', title: 'æ¨¡æ“¬æ¸¬é©—ä¸€', content: '', isQuiz: true, isFinal: true, duration: '30åˆ†é˜' },
                            { id: 'ga-06-02', title: 'æ¨¡æ“¬æ¸¬é©—äºŒ', content: '', isQuiz: true, isFinal: true, duration: '30åˆ†é˜' },
                            { id: 'ga-06-03', title: 'è€ƒå‰é‡é»æ•´ç†', content: 'è€ƒè©¦é‡é»å›é¡§ã€å¸¸è¦‹éŒ¯èª¤ã€æ‡‰è©¦æŠ€å·§ã€‚', duration: '20åˆ†é˜' }
                        ]
                    }
                ]
            }
        };

        // æ¸¬é©—é¡Œç›®æ¨¡æ¿
        const QUIZ_QUESTIONS = {
            'ga-01-05': [
                { q: 'ä¸‹åˆ—ä½•è€…ä¸æ˜¯ AI çš„ä¸»è¦é¡å‹ï¼Ÿ', options: ['æ©Ÿå™¨å­¸ç¿’', 'æ·±åº¦å­¸ç¿’', 'å€å¡Šéˆ', 'è‡ªç„¶èªè¨€è™•ç†'], answer: 2 },
                { q: 'åœ–éˆæ¸¬è©¦çš„ç›®çš„æ˜¯ä»€éº¼ï¼Ÿ', options: ['æ¸¬è©¦é›»è…¦é‹ç®—é€Ÿåº¦', 'æ¸¬è©¦é›»è…¦æ˜¯å¦èƒ½æ¨¡æ“¬äººé¡æ™ºæ…§', 'æ¸¬è©¦ç¶²è·¯å®‰å…¨', 'æ¸¬è©¦ç¨‹å¼æ•ˆèƒ½'], answer: 1 },
                { q: 'ç”Ÿæˆå¼ AI çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼Ÿ', options: ['åˆ†é¡è³‡æ–™', 'å‰µé€ æ–°å…§å®¹', 'åŠ å¯†è³‡æ–™', 'å£“ç¸®æª”æ¡ˆ'], answer: 1 }
            ],
            'ga-02-04': [
                { q: 'Vertex AI æ˜¯å“ªå®¶å…¬å¸çš„ç”¢å“ï¼Ÿ', options: ['Amazon', 'Microsoft', 'Google', 'OpenAI'], answer: 2 },
                { q: 'TensorFlow ä¸»è¦ç”¨æ–¼ä»€éº¼ï¼Ÿ', options: ['ç¶²é è¨­è¨ˆ', 'æ©Ÿå™¨å­¸ç¿’æ¨¡å‹é–‹ç™¼', 'è³‡æ–™åº«ç®¡ç†', 'ä½œæ¥­ç³»çµ±'], answer: 1 }
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // å–å¾—èª²ç¨‹ ID
            const params = new URLSearchParams(window.location.search);
            courseId = params.get('id') || 'google-ai';
            
            checkAuth();
            loadCourse();
        });

        // æª¢æŸ¥ç™»å…¥
        function checkAuth() {
            const token = localStorage.getItem('beidou_token');
            const userData = localStorage.getItem('beidou_user');
            
            if (!token || !userData) {
                window.location.href = `auth.html?redirect=course_learn.html?id=${courseId}`;
                return;
            }
            
            currentUser = JSON.parse(userData);
        }

        // è¼‰å…¥èª²ç¨‹
        async function loadCourse() {
            // ä½¿ç”¨æœ¬åœ°å…§å®¹ï¼ˆå¯¦éš›æ‡‰å¾ API å–å¾—ï¼‰
            courseData = COURSE_CONTENT[courseId] || COURSE_CONTENT['google-ai'];
            
            // è¨­å®šèª²ç¨‹åç¨±
            const courseNames = {
                'google-ai': 'Google AI Essentials',
                'aws-ai': 'AWS AI Practitioner',
                'azure-ai': 'Azure AI Fundamentals',
                'ipas-security': 'iPAS è³‡å®‰èªè­‰'
            };
            document.getElementById('courseName').textContent = courseNames[courseId] || courseId;
            
            // è¼‰å…¥é€²åº¦
            await loadProgress();
            
            // æ¸²æŸ“å¤§ç¶±
            renderModuleList();
            
            // è¼‰å…¥ç¬¬ä¸€å€‹æœªå®Œæˆçš„èª²ç¨‹
            loadNextIncomplete();
        }

        // è¼‰å…¥é€²åº¦
        async function loadProgress() {
            try {
                const response = await fetch(`${API_BASE}/api/courses/${courseId}/progress/${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success) {
                    progressData = result.data;
                    completedLessons = new Set(result.data.progress?.completedLessons || []);
                    updateProgressDisplay();
                }
            } catch (error) {
                console.error('Load progress error:', error);
                // ä½¿ç”¨æœ¬åœ°å„²å­˜ä½œç‚ºå‚™ç”¨
                const saved = localStorage.getItem(`course_progress_${courseId}`);
                if (saved) {
                    completedLessons = new Set(JSON.parse(saved));
                }
            }
        }

        // æ›´æ–°é€²åº¦é¡¯ç¤º
        function updateProgressDisplay() {
            const totalLessons = courseData.modules.reduce((sum, m) => sum + m.lessons.length, 0);
            const percent = Math.round((completedLessons.size / totalLessons) * 100);
            document.getElementById('progressPercent').textContent = `${percent}%`;
        }

        // æ¸²æŸ“æ¨¡çµ„åˆ—è¡¨
        function renderModuleList() {
            const html = courseData.modules.map((module, mi) => {
                const completedCount = module.lessons.filter(l => completedLessons.has(l.id)).length;
                const isExpanded = mi === currentModuleIndex;
                
                return `
                    <div class="module-item">
                        <div onclick="toggleModule(${mi})" class="flex justify-between items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700">
                            <div>
                                <div class="font-medium text-sm">${module.name}</div>
                                <div class="text-xs text-gray-400">${completedCount}/${module.lessons.length} å®Œæˆ</div>
                            </div>
                            <span class="transform transition ${isExpanded ? 'rotate-180' : ''}">â–¼</span>
                        </div>
                        <div id="module-${mi}" class="${isExpanded ? '' : 'hidden'} mt-1 space-y-1 pl-2">
                            ${module.lessons.map((lesson, li) => {
                                const isCompleted = completedLessons.has(lesson.id);
                                const isCurrent = mi === currentModuleIndex && li === currentLessonIndex;
                                return `
                                    <div onclick="goToLesson(${mi}, ${li})" 
                                         class="lesson-item p-2 rounded cursor-pointer text-sm flex items-center gap-2 ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
                                        <span>${isCompleted ? 'âœ…' : lesson.isQuiz ? 'ğŸ“' : 'ğŸ“–'}</span>
                                        <span class="flex-1">${lesson.title}</span>
                                        <span class="text-xs text-gray-500">${lesson.duration}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('moduleList').innerHTML = html;
            document.getElementById('mobileModuleList').innerHTML = html;
        }

        // åˆ‡æ›æ¨¡çµ„å±•é–‹
        function toggleModule(index) {
            const el = document.getElementById(`module-${index}`);
            el.classList.toggle('hidden');
        }

        // è·³è½‰åˆ°æŒ‡å®šèª²ç¨‹
        function goToLesson(moduleIndex, lessonIndex) {
            currentModuleIndex = moduleIndex;
            currentLessonIndex = lessonIndex;
            loadCurrentLesson();
            renderModuleList();
            closeMobileDrawer();
        }

        // è¼‰å…¥ä¸‹ä¸€å€‹æœªå®Œæˆçš„èª²ç¨‹
        function loadNextIncomplete() {
            for (let mi = 0; mi < courseData.modules.length; mi++) {
                for (let li = 0; li < courseData.modules[mi].lessons.length; li++) {
                    const lesson = courseData.modules[mi].lessons[li];
                    if (!completedLessons.has(lesson.id)) {
                        currentModuleIndex = mi;
                        currentLessonIndex = li;
                        loadCurrentLesson();
                        return;
                    }
                }
            }
            // å…¨éƒ¨å®Œæˆ
            currentModuleIndex = 0;
            currentLessonIndex = 0;
            loadCurrentLesson();
        }

        // è¼‰å…¥ç•¶å‰èª²ç¨‹
        function loadCurrentLesson() {
            const module = courseData.modules[currentModuleIndex];
            const lesson = module.lessons[currentLessonIndex];
            
            document.getElementById('moduleTitle').textContent = `Module ${currentModuleIndex + 1}: ${module.name}`;
            document.getElementById('lessonTitle').textContent = lesson.title;
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•
            document.getElementById('prevBtn').disabled = (currentModuleIndex === 0 && currentLessonIndex === 0);
            
            const isLast = currentModuleIndex === courseData.modules.length - 1 && 
                           currentLessonIndex === module.lessons.length - 1;
            document.getElementById('nextBtn').textContent = isLast ? 'å®Œæˆèª²ç¨‹ ğŸ‰' : 'å®Œæˆä¸¦ç¹¼çºŒ â†’';
            
            if (lesson.isQuiz) {
                // é¡¯ç¤ºæ¸¬é©—
                document.getElementById('contentArea').innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">${lesson.isFinal ? 'ğŸ¯' : 'ğŸ“'}</div>
                        <h3 class="text-xl font-bold mb-2">${lesson.title}</h3>
                        <p class="text-gray-400 mb-6">${lesson.isFinal ? 'æ¨¡æ“¬æ­£å¼è€ƒè©¦ç’°å¢ƒ' : 'æ¸¬è©¦æœ¬ç« ç¯€çš„ç†è§£ç¨‹åº¦'}</p>
                        <button onclick="startQuiz('${lesson.id}')" class="bg-purple-600 hover:bg-purple-700 px-8 py-3 rounded-lg transition">
                            é–‹å§‹æ¸¬é©—
                        </button>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = '<p>å®Œæˆæ¸¬é©—ä»¥ç¹¼çºŒå­¸ç¿’ã€‚</p>';
                document.getElementById('quizSection').classList.add('hidden');
            } else {
                // é¡¯ç¤ºèª²ç¨‹å…§å®¹
                document.getElementById('contentArea').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="text-6xl mb-4">ğŸ“–</div>
                            <div class="text-xl font-bold">${lesson.title}</div>
                            <div class="text-gray-400 mt-2">é è¨ˆå­¸ç¿’æ™‚é–“ï¼š${lesson.duration}</div>
                        </div>
                    </div>
                `;
                document.getElementById('lessonContent').innerHTML = `
                    <p>${lesson.content}</p>
                    <div class="mt-4 p-4 bg-purple-600/20 rounded-lg">
                        <div class="font-bold mb-2">ğŸ’¡ å­¸ç¿’æç¤º</div>
                        <p class="text-sm text-gray-300">é–±è®€å®Œæˆå¾Œï¼Œé»æ“Šã€Œå®Œæˆä¸¦ç¹¼çºŒã€é€²å…¥ä¸‹ä¸€ç¯€ã€‚å»ºè­°åšç­†è¨˜ä»¥åŠ æ·±å°è±¡ã€‚</p>
                    </div>
                `;
                document.getElementById('quizSection').classList.add('hidden');
            }
            
            renderModuleList();
        }

        // é–‹å§‹æ¸¬é©—
        function startQuiz(lessonId) {
            const questions = QUIZ_QUESTIONS[lessonId] || [
                { q: 'é€™æ˜¯ä¸€é“æ¸¬è©¦é¡Œç›®', options: ['é¸é …A', 'é¸é …B', 'é¸é …C', 'é¸é …D'], answer: 0 }
            ];
            
            let currentQ = 0;
            let userAnswers = [];
            
            function renderQuestion() {
                const q = questions[currentQ];
                document.getElementById('contentArea').innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-sm text-gray-400">ç¬¬ ${currentQ + 1} / ${questions.length} é¡Œ</span>
                            <div class="bg-gray-700 rounded-full h-2 w-32">
                                <div class="bg-purple-500 h-2 rounded-full" style="width: ${((currentQ + 1) / questions.length) * 100}%"></div>
                            </div>
                        </div>
                        <h3 class="text-lg font-bold mb-6">${q.q}</h3>
                        <div class="space-y-3">
                            ${q.options.map((opt, i) => `
                                <button onclick="selectAnswer(${i})" class="quiz-option w-full text-left p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                                    ${String.fromCharCode(65 + i)}. ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            window.selectAnswer = function(index) {
                userAnswers.push(index);
                currentQ++;
                
                if (currentQ < questions.length) {
                    renderQuestion();
                } else {
                    // è¨ˆç®—åˆ†æ•¸
                    let correct = 0;
                    questions.forEach((q, i) => {
                        if (userAnswers[i] === q.answer) correct++;
                    });
                    
                    const score = Math.round((correct / questions.length) * 100);
                    const passed = score >= 60;
                    
                    document.getElementById('resultIcon').textContent = passed ? 'ğŸ‰' : 'ğŸ˜…';
                    document.getElementById('resultTitle').textContent = passed ? 'æ¸¬é©—é€šéï¼' : 'å†æ¥å†å²';
                    document.getElementById('resultMessage').textContent = `å¾—åˆ†ï¼š${score}%ï¼ˆ${correct}/${questions.length}ï¼‰`;
                    
                    document.getElementById('quizResultModal').classList.remove('hidden');
                    document.getElementById('quizResultModal').classList.add('flex');
                    
                    if (passed) {
                        markComplete(lessonId);
                    }
                }
            };
            
            renderQuestion();
        }

        // é—œé–‰æ¸¬é©—çµæœ
        function closeQuizResult() {
            document.getElementById('quizResultModal').classList.add('hidden');
            document.getElementById('quizResultModal').classList.remove('flex');
            loadCurrentLesson();
        }

        // æ¨™è¨˜å®Œæˆ
        async function markComplete(lessonId) {
            if (!lessonId) {
                const module = courseData.modules[currentModuleIndex];
                lessonId = module.lessons[currentLessonIndex].id;
            }
            
            completedLessons.add(lessonId);
            
            // å„²å­˜åˆ°æœ¬åœ°
            localStorage.setItem(`course_progress_${courseId}`, JSON.stringify([...completedLessons]));
            
            // åŒæ­¥åˆ°å¾Œç«¯
            try {
                await fetch(`${API_BASE}/api/courses/${courseId}/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        lessonId,
                        timeSpent: 300  // å‡è¨­ 5 åˆ†é˜
                    })
                });
            } catch (e) {
                console.error('Sync progress error:', e);
            }
            
            updateProgressDisplay();
            renderModuleList();
        }

        // å®Œæˆä¸¦ç¹¼çºŒ
        function completeAndNext() {
            const module = courseData.modules[currentModuleIndex];
            const lesson = module.lessons[currentLessonIndex];
            
            // å¦‚æœæ˜¯æ¸¬é©—ä½†æœªå®Œæˆï¼Œä¸æ¨™è¨˜
            if (!lesson.isQuiz || completedLessons.has(lesson.id)) {
                markComplete();
            }
            
            nextLesson();
        }

        // ä¸Šä¸€ç¯€
        function prevLesson() {
            if (currentLessonIndex > 0) {
                currentLessonIndex--;
            } else if (currentModuleIndex > 0) {
                currentModuleIndex--;
                currentLessonIndex = courseData.modules[currentModuleIndex].lessons.length - 1;
            }
            loadCurrentLesson();
        }

        // ä¸‹ä¸€ç¯€
        function nextLesson() {
            const module = courseData.modules[currentModuleIndex];
            
            if (currentLessonIndex < module.lessons.length - 1) {
                currentLessonIndex++;
            } else if (currentModuleIndex < courseData.modules.length - 1) {
                currentModuleIndex++;
                currentLessonIndex = 0;
            } else {
                // èª²ç¨‹å®Œæˆ
                alert('ğŸ‰ æ­å–œå®Œæˆå…¨éƒ¨èª²ç¨‹ï¼');
                return;
            }
            loadCurrentLesson();
        }

        // ç§»å‹•ç«¯æŠ½å±œ
        function openMobileDrawer() {
            document.getElementById('mobileDrawer').classList.remove('hidden');
        }

        function closeMobileDrawer() {
            document.getElementById('mobileDrawer').classList.add('hidden');
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰
        document.getElementById('mobileDrawer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('mobileDrawer')) {
                closeMobileDrawer();
            }
        });
    </script>
</body>
</html>
