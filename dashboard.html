<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | å­¸ç¿’å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0VB6K9G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8X0VB6K9G7');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.2);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- å°èˆªåˆ— -->
    <nav class="border-b border-white/10 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒŸ</span>
                <span class="font-bold text-xl">åŒ—æ–—æ•™è‚²</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="quiz_ui.html" class="text-gray-400 hover:text-white transition">æ¸¬é©—</a>
                <a href="xtf_starmap.html" class="text-gray-400 hover:text-white transition">æ˜Ÿåœ–</a>
                <a href="leaderboard.html" class="text-gray-400 hover:text-white transition">æ’è¡Œæ¦œ</a>
                <div class="flex items-center gap-2 ml-4">
                    <span id="userCoins" class="text-yellow-400">ğŸª™ 0</span>
                    <span id="userLevel" class="bg-purple-600 px-2 py-0.5 rounded text-sm">Lv.1</span>
                </div>
                <button onclick="logout()" class="text-gray-400 hover:text-red-400 transition">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- æ­¡è¿å€ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">
                <span id="greeting">ä½ å¥½</span>ï¼Œ<span id="userName">å­¸ç¿’è€…</span>ï¼
            </h1>
            <p class="text-gray-400">ä»Šå¤©ä¹Ÿè¦ç¹¼çºŒåŠªåŠ›å­¸ç¿’å–” ğŸ’ª</p>
        </div>
        
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card stat-card rounded-xl p-5 transition">
                <div class="text-3xl mb-2">ğŸ”¥</div>
                <div id="statStreak" class="text-3xl font-bold text-orange-400">0</div>
                <div class="text-gray-400 text-sm">é€£çºŒå­¸ç¿’å¤©æ•¸</div>
            </div>
            <div class="card stat-card rounded-xl p-5 transition">
                <div class="text-3xl mb-2">ğŸ“</div>
                <div id="statToday" class="text-3xl font-bold text-blue-400">0</div>
                <div class="text-gray-400 text-sm">ä»Šæ—¥ç­”é¡Œæ•¸</div>
            </div>
            <div class="card stat-card rounded-xl p-5 transition">
                <div class="text-3xl mb-2">âœ…</div>
                <div id="statAccuracy" class="text-3xl font-bold text-green-400">0%</div>
                <div class="text-gray-400 text-sm">ç¸½æ­£ç¢ºç‡</div>
            </div>
            <div class="card stat-card rounded-xl p-5 transition">
                <div class="text-3xl mb-2">â­</div>
                <div id="statXP" class="text-3xl font-bold text-purple-400">0</div>
                <div class="text-gray-400 text-sm">ç´¯ç©ç¶“é©—å€¼</div>
            </div>
        </div>
        
        <!-- åœ–è¡¨å€ -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- é€±å­¸ç¿’è¶¨å‹¢ -->
            <div class="card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ æœ¬é€±å­¸ç¿’è¶¨å‹¢</h3>
                <canvas id="weeklyChart" height="200"></canvas>
            </div>
            
            <!-- ç§‘ç›®åˆ†ä½ˆ -->
            <div class="card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“Š ç§‘ç›®åˆ†ä½ˆ</h3>
                <canvas id="subjectChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- å¿«æ·æ“ä½œ -->
        <div class="grid md:grid-cols-3 gap-4 mb-8">
            <a href="quiz_ui.html" class="card rounded-xl p-6 hover:bg-white/10 transition group">
                <div class="text-4xl mb-3 group-hover:scale-110 transition">ğŸ¯</div>
                <h3 class="font-semibold mb-1">é–‹å§‹æ¸¬é©—</h3>
                <p class="text-gray-400 text-sm">æŒ‘æˆ°éš¨æ©Ÿé¡Œç›®</p>
            </a>
            <a href="wrong_book.html" class="card rounded-xl p-6 hover:bg-white/10 transition group">
                <div class="text-4xl mb-3 group-hover:scale-110 transition">ğŸ“•</div>
                <h3 class="font-semibold mb-1">éŒ¯é¡Œæœ¬</h3>
                <p class="text-gray-400 text-sm">å¾éŒ¯èª¤ä¸­å­¸ç¿’</p>
            </a>
            <a href="report.html" class="card rounded-xl p-6 hover:bg-white/10 transition group">
                <div class="text-4xl mb-3 group-hover:scale-110 transition">ğŸ“Š</div>
                <h3 class="font-semibold mb-1">å­¸ç¿’å ±å‘Š</h3>
                <p class="text-gray-400 text-sm">æŸ¥çœ‹å­¸ç¿’åˆ†æ</p>
            </a>
        </div>
        
        <!-- æ›´å¤šåŠŸèƒ½ -->
        <div class="grid md:grid-cols-4 gap-4 mb-8">
            <a href="xtf_flashcard.html" class="card rounded-xl p-4 hover:bg-white/10 transition text-center">
                <div class="text-2xl mb-2">ğŸ“š</div>
                <div class="text-sm">è¤‡ç¿’å¡ç‰‡</div>
            </a>
            <a href="achievements.html" class="card rounded-xl p-4 hover:bg-white/10 transition text-center">
                <div class="text-2xl mb-2">ğŸ†</div>
                <div class="text-sm">æˆå°±å¾½ç« </div>
            </a>
            <a href="leaderboard.html" class="card rounded-xl p-4 hover:bg-white/10 transition text-center">
                <div class="text-2xl mb-2">ğŸ¥‡</div>
                <div class="text-sm">æ’è¡Œæ¦œ</div>
            </a>
            <a href="cert_exam.html" class="card rounded-xl p-4 hover:bg-white/10 transition text-center">
                <div class="text-2xl mb-2">ğŸ“œ</div>
                <div class="text-sm">è­‰ç…§è€ƒè©¦</div>
            </a>
        </div>
        
        <!-- æ¨è–¦ç¢¼ -->
        <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ é‚€è«‹å¥½å‹</h3>
            <p class="text-gray-400 text-sm mb-4">åˆ†äº«ä½ çš„æ¨è–¦ç¢¼ï¼Œé›™æ–¹å„å¾— 50 é‡‘å¹£ï¼</p>
            <div class="flex items-center gap-3">
                <div class="flex-1 bg-white/10 rounded-lg px-4 py-3 font-mono text-lg" id="referralCode">
                    è¼‰å…¥ä¸­...
                </div>
                <button onclick="copyReferral()" 
                    class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg transition">
                    è¤‡è£½
                </button>
            </div>
            <div id="copyMsg" class="hidden mt-2 text-green-400 text-sm">âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>
        </div>
    </main>

    <script>
        const API_BASE = 'https://beidou-edu-server-1.onrender.com/api';
        let user = null;
        let weeklyChart = null;
        let subjectChart = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // æª¢æŸ¥ç™»å…¥
            const token = localStorage.getItem('beidou_token');
            const userData = localStorage.getItem('beidou_user');
            
            if (!token || !userData) {
                window.location.href = 'auth.html';
                return;
            }
            
            user = JSON.parse(userData);
            
            // é¡¯ç¤ºåŸºæœ¬è³‡æ–™
            document.getElementById('userName').textContent = user.username;
            document.getElementById('userCoins').textContent = `ğŸª™ ${user.coins || 0}`;
            document.getElementById('userLevel').textContent = `Lv.${user.level || 1}`;
            document.getElementById('referralCode').textContent = user.referralCode || 'N/A';
            document.getElementById('statXP').textContent = user.xp || 0;
            
            // å•å€™èª
            const hour = new Date().getHours();
            let greeting = 'ä½ å¥½';
            if (hour < 12) greeting = 'æ—©å®‰';
            else if (hour < 18) greeting = 'åˆå®‰';
            else greeting = 'æ™šå®‰';
            document.getElementById('greeting').textContent = greeting;
            
            // è¼‰å…¥çµ±è¨ˆ
            await loadStats();
            
            // GA
            gtag('event', 'page_view', {
                'event_category': 'dashboard'
            });
        });
        
        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const token = localStorage.getItem('beidou_token');
            
            try {
                // å–å¾—ç”¨æˆ¶çµ±è¨ˆ
                const profileRes = await fetch(`${API_BASE}/user/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const profileData = await profileRes.json();
                
                if (profileData.success) {
                    const stats = profileData.data.stats;
                    document.getElementById('statStreak').textContent = stats.streak || 0;
                    document.getElementById('statToday').textContent = stats.todayQuestions || 0;
                    document.getElementById('statAccuracy').textContent = `${stats.accuracy || 0}%`;
                    
                    // æ›´æ–°ç”¨æˆ¶è³‡æ–™
                    const u = profileData.data.user;
                    document.getElementById('userCoins').textContent = `ğŸª™ ${u.coins || 0}`;
                    document.getElementById('userLevel').textContent = `Lv.${u.level || 1}`;
                    document.getElementById('statXP').textContent = u.xp || 0;
                }
                
                // å–å¾—è©³ç´°çµ±è¨ˆ
                const statsRes = await fetch(`${API_BASE}/user/stats?days=7`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const statsData = await statsRes.json();
                
                if (statsData.success) {
                    renderWeeklyChart(statsData.data.daily);
                    renderSubjectChart(statsData.data.subjects);
                }
            } catch (err) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', err);
                // ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                renderWeeklyChart([]);
                renderSubjectChart([]);
            }
        }
        
        // é€±è¶¨å‹¢åœ–
        function renderWeeklyChart(daily) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            // æº–å‚™ 7 å¤©è³‡æ–™
            const labels = [];
            const data = [];
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(days[date.getDay()]);
                
                const dayData = daily.find(d => d.date === dateStr);
                data.push(dayData ? dayData.totalQuestions : 0);
            }
            
            if (weeklyChart) weeklyChart.destroy();
            
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'ç­”é¡Œæ•¸',
                        data,
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: 'rgba(139, 92, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // ç§‘ç›®åˆ†ä½ˆåœ–
        function renderSubjectChart(subjects) {
            const ctx = document.getElementById('subjectChart').getContext('2d');
            
            // æº–å‚™è³‡æ–™
            let labels = [];
            let data = [];
            
            if (subjects && subjects.length > 0) {
                labels = subjects.map(s => s._id);
                data = subjects.map(s => s.total);
            } else {
                // æ¨¡æ“¬è³‡æ–™
                labels = ['æ•¸å­¸', 'ç‰©ç†', 'åŒ–å­¸', 'ç”Ÿç‰©', 'è‹±æ–‡'];
                data = [0, 0, 0, 0, 0];
            }
            
            const colors = [
                '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#84cc16'
            ];
            
            if (subjectChart) subjectChart.destroy();
            
            subjectChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }
        
        // è¤‡è£½æ¨è–¦ç¢¼
        function copyReferral() {
            const code = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                document.getElementById('copyMsg').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copyMsg').classList.add('hidden');
                }, 2000);
                
                gtag('event', 'copy_referral', {
                    'event_category': 'dashboard'
                });
            });
        }
        
        // ç™»å‡º
        function logout() {
            localStorage.removeItem('beidou_token');
            localStorage.removeItem('beidou_user');
            gtag('event', 'logout', {
                'event_category': 'auth'
            });
            window.location.href = 'auth.html';
        }
    </script>
</body>
</html>
