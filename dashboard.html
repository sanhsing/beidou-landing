<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç¿’å„€è¡¨æ¿ - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="js/components.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .chart-container { position: relative; height: 200px; }
    .quick-action { transition: transform 0.2s; }
    .quick-action:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- é ‚éƒ¨å°èˆª -->
  <nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸŒŸ</span>
        <span class="font-bold text-xl text-indigo-600">åŒ—æ–—æ•™è‚²</span>
      </div>
      <div class="flex items-center gap-4">
        <span id="userName" class="text-gray-600">è¼‰å…¥ä¸­...</span>
        <button onclick="logout()" class="btn btn-secondary text-sm">ç™»å‡º</button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- æ­¡è¿å€ -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-gray-800">
        <span id="greeting">æ—©å®‰</span>ï¼Œ<span id="displayName">åŒå­¸</span>ï¼
      </h1>
      <p class="text-gray-500 mt-1">ç¹¼çºŒä½ çš„å­¸ç¿’ä¹‹æ—…å§ âœ¨</p>
    </div>

    <!-- ä»Šæ—¥çµ±è¨ˆ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“š</div>
        <div class="stat-content">
          <div class="stat-value" id="todayQuestions">-</div>
          <div class="stat-label">ä»Šæ—¥ç­”é¡Œ</div>
        </div>
      </div>
      <div class="stat-card success">
        <div class="stat-icon">âœ“</div>
        <div class="stat-content">
          <div class="stat-value" id="todayAccuracy">-%</div>
          <div class="stat-label">ä»Šæ—¥æ­£ç¢ºç‡</div>
        </div>
      </div>
      <div class="stat-card warning">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-content">
          <div class="stat-value" id="streakDays">0</div>
          <div class="stat-label">é€£çºŒå­¸ç¿’</div>
        </div>
      </div>
      <div class="stat-card info">
        <div class="stat-icon">ğŸ†</div>
        <div class="stat-content">
          <div class="stat-value" id="currentRank">-</div>
          <div class="stat-label">ç•¶å‰æ’å</div>
        </div>
      </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="grid md:grid-cols-3 gap-6">
      <!-- å·¦å´ï¼šç¸½é«”é€²åº¦ -->
      <div class="md:col-span-2 space-y-6">
        <!-- ç¸½é«”æŒæ¡åº¦ -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“Š ç¸½é«”å­¸ç¿’é€²åº¦</h2>
            <span class="badge badge-primary" id="totalNodes">0 ç¯€é»</span>
          </div>
          <div class="flex items-center gap-8">
            <div class="w-32 h-32">
              <canvas id="masteryRing"></canvas>
            </div>
            <div class="flex-1">
              <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-600">ç¸½æŒæ¡åº¦</span>
                  <span class="font-semibold" id="overallMastery">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="fill" id="masteryBar" style="width: 0%"></div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-green-500" id="excellentCount">0</div>
                  <div class="text-xs text-gray-500">å„ªç§€</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-yellow-500" id="goodCount">0</div>
                  <div class="text-xs text-gray-500">è‰¯å¥½</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-red-500" id="needWorkCount">0</div>
                  <div class="text-xs text-gray-500">å¾…åŠ å¼·</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç§‘ç›®é€²åº¦ -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“ˆ å„ç§‘æŒæ¡åº¦</h2>
          </div>
          <div class="chart-container" style="height: 250px;">
            <canvas id="subjectChart"></canvas>
          </div>
        </div>

        <!-- æœ¬é€±è¶¨å‹¢ -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ğŸ“… æœ¬é€±å­¸ç¿’è¶¨å‹¢</h2>
          </div>
          <div class="chart-container">
            <canvas id="weeklyTrend"></canvas>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šå¿«æ·æ“ä½œ + å¼±é» -->
      <div class="space-y-6">
        <!-- å¿«æ·æ“ä½œ -->
        <div class="card">
          <h2 class="card-title mb-4">âš¡ å¿«æ·æ“ä½œ</h2>
          <div class="space-y-3">
            <a href="quiz_ui.html" class="quick-action flex items-center gap-3 p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100">
              <span class="text-2xl">ğŸ“</span>
              <div>
                <div class="font-semibold text-indigo-700">é–‹å§‹ç­”é¡Œ</div>
                <div class="text-sm text-gray-500">éš¨æ©Ÿç·´ç¿’é¡Œç›®</div>
              </div>
            </a>
            <a href="wrong_book.html" class="quick-action flex items-center gap-3 p-3 bg-red-50 rounded-lg hover:bg-red-100">
              <span class="text-2xl">ğŸ“•</span>
              <div>
                <div class="font-semibold text-red-700">éŒ¯é¡Œè¤‡ç¿’</div>
                <div class="text-sm text-gray-500"><span id="wrongCount">0</span> é¡Œå¾…è¤‡ç¿’</div>
              </div>
            </a>
            <a href="xtf_starmap.html" class="quick-action flex items-center gap-3 p-3 bg-purple-50 rounded-lg hover:bg-purple-100">
              <span class="text-2xl">ğŸŒŒ</span>
              <div>
                <div class="font-semibold text-purple-700">çŸ¥è­˜æ˜Ÿåœ–</div>
                <div class="text-sm text-gray-500">æ¢ç´¢çŸ¥è­˜ç¶²çµ¡</div>
              </div>
            </a>
            <a href="cert_exam.html" class="quick-action flex items-center gap-3 p-3 bg-green-50 rounded-lg hover:bg-green-100">
              <span class="text-2xl">ğŸ“</span>
              <div>
                <div class="font-semibold text-green-700">AI èªè­‰</div>
                <div class="text-sm text-gray-500">è€ƒå–è­‰ç…§</div>
              </div>
            </a>
          </div>
        </div>

        <!-- å¼±é»åˆ†æ -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">âš ï¸ å¾…åŠ å¼·</h2>
            <a href="report.html" class="text-sm text-indigo-600">æŸ¥çœ‹è©³æƒ… â†’</a>
          </div>
          <div id="weaknessList" class="space-y-3">
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text"></div>
          </div>
        </div>

        <!-- æœ€è¿‘æ´»å‹• -->
        <div class="card">
          <h2 class="card-title mb-4">ğŸ• æœ€è¿‘æ´»å‹•</h2>
          <div id="recentActivity" class="space-y-2 text-sm">
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast å®¹å™¨ -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/api.js"></script>
  <script src="js/charts.js"></script>
  <script>
    // å…¨åŸŸç‹€æ…‹
    let charts = {};
    let dashboardData = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      // æª¢æŸ¥ç™»å…¥
      const token = BeidouAPI.getToken();
      if (!token) {
        window.location.href = 'auth.html';
        return;
      }

      // è¨­å®šå•å€™èª
      setGreeting();

      // è¼‰å…¥è³‡æ–™
      await loadDashboard();
    }

    function setGreeting() {
      const hour = new Date().getHours();
      let greeting = 'æ—©å®‰';
      if (hour >= 12 && hour < 18) greeting = 'åˆå®‰';
      else if (hour >= 18) greeting = 'æ™šå®‰';
      document.getElementById('greeting').textContent = greeting;

      const user = JSON.parse(localStorage.getItem('beidou_user') || '{}');
      document.getElementById('displayName').textContent = user.displayName || user.username || 'åŒå­¸';
      document.getElementById('userName').textContent = user.email || '';
    }

    async function loadDashboard() {
      try {
        // ä¸¦è¡Œè¼‰å…¥è³‡æ–™
        const [dashRes, weakRes] = await Promise.all([
          BeidouAPI.analytics.dashboard(),
          BeidouAPI.analytics.weakness()
        ]);

        if (dashRes.success) {
          dashboardData = dashRes.data;
          renderDashboard(dashboardData);
        }

        if (weakRes.success) {
          renderWeakness(weakRes.data);
        }

      } catch (error) {
        console.error('Dashboard load error:', error);
        showToast('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†', 'error');
      }
    }

    function renderDashboard(data) {
      const { overview, today, week, rank, recentActivity } = data;

      // ä»Šæ—¥çµ±è¨ˆ
      document.getElementById('todayQuestions').textContent = today?.questions || 0;
      document.getElementById('todayAccuracy').textContent = 
        today?.questions > 0 ? Math.round(today.correct / today.questions * 100) + '%' : '-';
      document.getElementById('streakDays').textContent = overview?.streak_days || 0;
      document.getElementById('currentRank').textContent = rank?.current ? `#${rank.current}` : '-';

      // ç¸½é«”é€²åº¦
      const mastery = Math.round(overview?.avg_mastery || 0);
      document.getElementById('overallMastery').textContent = mastery + '%';
      document.getElementById('masteryBar').style.width = mastery + '%';
      document.getElementById('totalNodes').textContent = (overview?.nodes_studied || 0) + ' ç¯€é»';

      // åˆ†ä½ˆçµ±è¨ˆ (æ¨¡æ“¬)
      document.getElementById('excellentCount').textContent = Math.floor((overview?.nodes_studied || 0) * 0.3);
      document.getElementById('goodCount').textContent = Math.floor((overview?.nodes_studied || 0) * 0.5);
      document.getElementById('needWorkCount').textContent = overview?.wrong_count || 0;
      document.getElementById('wrongCount').textContent = overview?.wrong_count || 0;

      // ç¹ªè£½ç’°å½¢åœ–
      if (charts.masteryRing) charts.masteryRing.destroy();
      charts.masteryRing = BeidouCharts.progressRing('masteryRing', mastery);

      // ç¹ªè£½è¶¨å‹¢åœ–
      if (recentActivity && recentActivity.length > 0) {
        if (charts.weeklyTrend) charts.weeklyTrend.destroy();
        charts.weeklyTrend = BeidouCharts.trendLine('weeklyTrend', 
          recentActivity.map(a => ({ date: a.date.slice(5), value: a.count }))
        );
        
        // æœ€è¿‘æ´»å‹•
        document.getElementById('recentActivity').innerHTML = recentActivity.slice(0, 5).map(a => `
          <div class="flex justify-between py-1 border-b border-gray-100">
            <span class="text-gray-600">${a.date.slice(5)}</span>
            <span class="font-medium">${a.count} é¡Œ</span>
          </div>
        `).join('');
      }

      // è¼‰å…¥ç§‘ç›®é€²åº¦
      loadSubjectProgress();
    }

    async function loadSubjectProgress() {
      try {
        const res = await BeidouAPI.progress.get();
        if (res.success && res.data.progress) {
          // æŒ‰ç§‘ç›®å½™æ•´
          const bySubject = {};
          res.data.progress.forEach(p => {
            const subj = p.subject_id || 'other';
            if (!bySubject[subj]) {
              bySubject[subj] = { total: 0, correct: 0, count: 0 };
            }
            bySubject[subj].total += p.total_questions || 0;
            bySubject[subj].correct += p.correct_count || 0;
            bySubject[subj].count++;
          });

          const chartData = Object.entries(bySubject).map(([subj, data]) => ({
            subject: subj,
            mastery: data.total > 0 ? Math.round(data.correct / data.total * 100) : 0
          })).filter(d => d.mastery > 0);

          if (chartData.length > 0) {
            if (charts.subjectChart) charts.subjectChart.destroy();
            charts.subjectChart = BeidouCharts.subjectBars('subjectChart', chartData);
          }
        }
      } catch (e) {
        console.error('Subject progress error:', e);
      }
    }

    function renderWeakness(data) {
      const { weakNodes, recommendations } = data;
      const list = document.getElementById('weaknessList');

      if (weakNodes && weakNodes.length > 0) {
        list.innerHTML = weakNodes.slice(0, 5).map(node => `
          <div class="flex items-center justify-between p-2 bg-red-50 rounded">
            <div>
              <div class="font-medium text-sm">${node.node_name || node.node_id}</div>
              <div class="text-xs text-gray-500">${node.subject_id || ''}</div>
            </div>
            <div class="text-red-600 font-bold">${node.mastery_level}%</div>
          </div>
        `).join('');
      } else {
        list.innerHTML = '<div class="text-center text-gray-400 py-4">ğŸ‘ ç›®å‰æ²’æœ‰å¾…åŠ å¼·é …ç›®</div>';
      }
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function logout() {
      localStorage.removeItem('beidou_token');
      localStorage.removeItem('beidou_user');
      window.location.href = 'auth.html';
    }
  </script>
</body>
</html>
