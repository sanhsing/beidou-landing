<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­”é¡Œç·´ç¿’ - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="js/components.css">
  <style>
    .option-card {
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    .option-card:hover:not(.disabled) {
      border-color: var(--primary);
      transform: translateX(4px);
    }
    .option-card.selected {
      border-color: var(--primary);
      background: #eef2ff;
    }
    .option-card.correct {
      border-color: var(--success);
      background: #dcfce7;
    }
    .option-card.wrong {
      border-color: var(--danger);
      background: #fee2e2;
    }
    .option-card.disabled {
      pointer-events: none;
    }
    .streak-badge {
      animation: bounceIn 0.5s ease;
    }
    @keyframes bounceIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .timer-warning { color: var(--danger); animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- é ‚éƒ¨é€²åº¦æ¢ -->
  <div class="fixed top-0 left-0 right-0 h-1 bg-gray-200 z-50">
    <div id="progressBar" class="h-full bg-indigo-600 transition-all duration-300" style="width: 0%"></div>
  </div>

  <!-- é ‚éƒ¨å°èˆª -->
  <nav class="bg-white shadow-sm sticky top-0 z-40 mt-1">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="dashboard.html" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
        <span>â†</span> è¿”å›
      </a>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <span class="text-2xl">â±ï¸</span>
          <span id="timer" class="font-mono text-lg font-bold">00:00</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-2xl">ğŸ”¥</span>
          <span id="streak" class="font-bold text-orange-500">0</span>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- é¡Œç›®è³‡è¨Š -->
    <div class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="badge badge-primary" id="questionNum">1 / 10</span>
        <span class="badge" id="subjectBadge">æ•¸å­¸</span>
        <span class="badge" id="difficultyBadge">ä¸­ç­‰</span>
      </div>
      <div class="text-sm text-gray-500">
        æ­£ç¢ºç‡: <span id="accuracy" class="font-bold text-green-600">100%</span>
      </div>
    </div>

    <!-- é¡Œç›®å¡ç‰‡ -->
    <div class="card mb-6">
      <!-- æƒ…å¢ƒ -->
      <div id="contextArea" class="hidden mb-4 p-4 bg-blue-50 rounded-lg text-sm text-gray-700">
      </div>
      
      <!-- é¡Œå¹¹ -->
      <div id="questionText" class="text-lg font-medium text-gray-800 mb-6">
        è¼‰å…¥é¡Œç›®ä¸­...
      </div>

      <!-- é¸é … -->
      <div id="optionsContainer" class="space-y-3">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ç­”é¡Œå›é¥‹ -->
    <div id="feedback" class="hidden card mb-6">
      <div id="feedbackIcon" class="text-4xl text-center mb-3"></div>
      <div id="feedbackText" class="text-center font-medium mb-4"></div>
      <div id="explanation" class="p-4 bg-gray-50 rounded-lg text-sm text-gray-600"></div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="flex justify-between">
      <button id="skipBtn" onclick="skipQuestion()" class="btn btn-secondary">
        è·³éæ­¤é¡Œ
      </button>
      <button id="nextBtn" onclick="nextQuestion()" class="btn btn-primary hidden">
        ä¸‹ä¸€é¡Œ â†’
      </button>
      <button id="finishBtn" onclick="showResults()" class="btn btn-success hidden">
        å®Œæˆæ¸¬é©— âœ“
      </button>
    </div>
  </main>

  <!-- çµæœé é¢ -->
  <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center">
      <div class="text-6xl mb-4" id="resultEmoji">ğŸ‰</div>
      <h2 class="text-2xl font-bold mb-2">æ¸¬é©—å®Œæˆï¼</h2>
      <div class="text-5xl font-bold text-indigo-600 my-6" id="finalScore">0%</div>
      
      <div class="grid grid-cols-3 gap-4 mb-6 text-sm">
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="text-2xl font-bold text-gray-800" id="totalAnswered">0</div>
          <div class="text-gray-500">ç¸½é¡Œæ•¸</div>
        </div>
        <div class="p-3 bg-green-50 rounded-lg">
          <div class="text-2xl font-bold text-green-600" id="correctCount">0</div>
          <div class="text-gray-500">ç­”å°</div>
        </div>
        <div class="p-3 bg-red-50 rounded-lg">
          <div class="text-2xl font-bold text-red-600" id="wrongCountResult">0</div>
          <div class="text-gray-500">ç­”éŒ¯</div>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="location.reload()" class="btn btn-secondary flex-1">å†ç·´ä¸€æ¬¡</button>
        <button onclick="location.href='dashboard.html'" class="btn btn-primary flex-1">è¿”å›é¦–é </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="js/api.js"></script>
  <script>
    // ç‹€æ…‹
    const state = {
      questions: [],
      currentIndex: 0,
      answers: [],
      streak: 0,
      maxStreak: 0,
      startTime: Date.now(),
      questionStartTime: Date.now(),
      totalQuestions: 10
    };

    // åˆå§‹åŒ–
        async function init() {
      // æª¢æŸ¥è©¦ç”¨æ¨¡å¼
      const params = new URLSearchParams(window.location.search);
      state.trialMode = params.get('mode') === 'trial';
      
      if (state.trialMode) {
        console.log('ğŸ® è©¦ç”¨æ¨¡å¼å•Ÿå‹•');
        state.totalQuestions = 10;
      }
      
      startTimer();
      await loadQuestions();
    }

    async function loadQuestions() {
      try {
        const params = new URLSearchParams(window.location.search);
        const subject = params.get('subject') || '';
        const count = state.trialMode ? 10 : (params.get('count') || 10);
        const node = params.get('node') || '';
        
        state.totalQuestions = parseInt(count);

        const res = await BeidouAPI.quiz.getQuestions({ 
          subject, 
          count,
          node,
          shuffle: true 
        });

        if (res.success && res.data && res.data.length > 0) {
          state.questions = res.data;
          renderQuestion();
        } else {
          showToast('ç„¡æ³•è¼‰å…¥é¡Œç›®', 'error');
          if (state.trialMode) loadFallbackQuestions();
        }
      } catch (error) {
        console.error('Load questions error:', error);
        showToast('è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
        if (state.trialMode) loadFallbackQuestions();
      }
    }

    function loadFallbackQuestions() {
      const params = new URLSearchParams(window.location.search);
      const filterSubject = params.get('subject') || '';
      
      let allQuestions = [
        { id: 'demo_1', subject: 'æ•¸å­¸', question: 'è‹¥ xÂ² - 5x + 6 = 0ï¼Œå‰‡ x çš„è§£ç‚ºï¼Ÿ', options: ['x = 1, 6', 'x = 2, 3', 'x = -2, -3', 'x = 1, 5'], answer: 'B', explanation: 'å› å¼åˆ†è§£ï¼š(x-2)(x-3) = 0' },
        { id: 'demo_2', subject: 'ç‰©ç†', question: 'è³ªé‡ 2 kg ç‰©é«”å— 10 N åŠ›ï¼ŒåŠ é€Ÿåº¦ç‚ºï¼Ÿ', options: ['2 m/sÂ²', '5 m/sÂ²', '10 m/sÂ²', '20 m/sÂ²'], answer: 'B', explanation: 'a = F/m = 10/2 = 5 m/sÂ²' },
        { id: 'demo_3', subject: 'åŒ–å­¸', question: 'æ°´çš„åŒ–å­¸å¼æ˜¯ï¼Ÿ', options: ['Hâ‚‚O', 'COâ‚‚', 'NaCl', 'Hâ‚‚SOâ‚„'], answer: 'A', explanation: 'æ°´ = Hâ‚‚O' },
        { id: 'demo_4', subject: 'è‹±æ–‡', question: 'The book _____ on the table.', options: ['is', 'are', 'be', 'been'], answer: 'A', explanation: 'å–®æ•¸ç”¨ is' },
        { id: 'demo_5', subject: 'åœ‹æ–‡', question: 'ã€ŒåºŠå‰æ˜æœˆå…‰ã€å‡ºè‡ªå“ªä½è©©äººï¼Ÿ', options: ['æœç”«', 'æç™½', 'ç™½å±…æ˜“', 'ç‹ç¶­'], answer: 'B', explanation: 'æç™½ã€Šéœå¤œæ€ã€‹' },
        { id: 'demo_6', subject: 'æ•¸å­¸', question: 'sin 30Â° = ?', options: ['0', '0.5', '1', 'âˆš3/2'], answer: 'B', explanation: 'sin 30Â° = 1/2 = 0.5' },
        { id: 'demo_7', subject: 'ç”Ÿç‰©', question: 'äººé«”æœ€å¤§çš„å™¨å®˜æ˜¯ï¼Ÿ', options: ['å¿ƒè‡Ÿ', 'è‚è‡Ÿ', 'çš®è†š', 'å¤§è…¦'], answer: 'C', explanation: 'çš®è†šæ˜¯äººé«”æœ€å¤§çš„å™¨å®˜' },
        { id: 'demo_8', subject: 'åœ°ç†', question: 'å°ç£æœ€é«˜å³°æ˜¯ï¼Ÿ', options: ['é˜¿é‡Œå±±', 'ç‰å±±', 'é›ªå±±', 'åˆæ­¡å±±'], answer: 'B', explanation: 'ç‰å±±æµ·æ‹” 3952 å…¬å°º' },
        { id: 'demo_9', subject: 'æ­·å²', question: 'å°ç£ç¬¬ä¸€ä»»æ°‘é¸ç¸½çµ±æ˜¯ï¼Ÿ', options: ['è”£ä¸­æ­£', 'æç™»è¼', 'é™³æ°´æ‰', 'è”£ç¶“åœ‹'], answer: 'B', explanation: '1996å¹´æç™»è¼ç•¶é¸é¦–ä»»æ°‘é¸ç¸½çµ±' },
        { id: 'demo_10', subject: 'å…¬æ°‘', question: 'ä¸­è¯æ°‘åœ‹æ†²æ³•å…±æœ‰å¹¾ç« ï¼Ÿ', options: ['10ç« ', '12ç« ', '14ç« ', '16ç« '], answer: 'C', explanation: 'æ†²æ³•å…±14ç« 175æ¢' }
      ];
      
      // æŒ‰ç§‘ç›®éæ¿¾
      if (filterSubject) {
        state.questions = allQuestions.filter(q => q.subject === filterSubject);
        if (state.questions.length === 0) {
          state.questions = allQuestions; // ç„¡åŒ¹é…å‰‡é¡¯ç¤ºå…¨éƒ¨
        }
      } else {
        state.questions = allQuestions;
      }
      
      renderQuestion();
      showToast(`å·²è¼‰å…¥è©¦ç”¨é¡Œç›® (${state.questions.length}é¡Œ)`, 'info');
    }

    document.addEventListener('DOMContentLoaded', init);

    

    

    function renderQuestion() {
      const q = state.questions[state.currentIndex];
      if (!q) return;

      state.questionStartTime = Date.now();

      // æ›´æ–°é€²åº¦
      const progress = ((state.currentIndex) / state.questions.length) * 100;
      document.getElementById('progressBar').style.width = progress + '%';
      document.getElementById('questionNum').textContent = 
        `${state.currentIndex + 1} / ${state.questions.length}`;

      // æ›´æ–°æ¨™ç±¤
      document.getElementById('subjectBadge').textContent = q.subject || 'ç¶œåˆ';
      document.getElementById('difficultyBadge').textContent = 
        ['ç°¡å–®', 'ä¸­ç­‰', 'ä¸­ç­‰', 'å›°é›£', 'å›°é›£'][q.difficulty - 1] || 'ä¸­ç­‰';

      // æƒ…å¢ƒ
      const contextArea = document.getElementById('contextArea');
      if (q.context && q.context.length > 50) {
        contextArea.innerHTML = q.context;
        contextArea.classList.remove('hidden');
      } else {
        contextArea.classList.add('hidden');
      }

      // é¡Œå¹¹
      document.getElementById('questionText').innerHTML = q.question || q.question_text;

      // é¸é …
      let options = q.options;
      if (typeof options === 'string') {
        try { options = JSON.parse(options); } catch (e) { options = []; }
      }

      const container = document.getElementById('optionsContainer');
      container.innerHTML = options.map((opt, idx) => `
        <div class="option-card p-4 bg-white rounded-lg cursor-pointer shadow-sm" 
             onclick="selectOption(${idx})" data-index="${idx}">
          <div class="flex items-center gap-3">
            <span class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full font-bold">
              ${String.fromCharCode(65 + idx)}
            </span>
            <span class="flex-1">${typeof opt === 'object' ? opt.text || opt : opt}</span>
          </div>
        </div>
      `).join('');

      // éš±è—å›é¥‹å’ŒæŒ‰éˆ•
      document.getElementById('feedback').classList.add('hidden');
      document.getElementById('nextBtn').classList.add('hidden');
      document.getElementById('finishBtn').classList.add('hidden');
      document.getElementById('skipBtn').classList.remove('hidden');

      // æ›´æ–°æ­£ç¢ºç‡
      updateAccuracy();
    }

    async function selectOption(index) {
      const q = state.questions[state.currentIndex];
      const options = document.querySelectorAll('.option-card');
      
      // ç¦ç”¨æ‰€æœ‰é¸é …
      options.forEach(opt => opt.classList.add('disabled'));

      // æ¨™è¨˜é¸æ“‡
      options[index].classList.add('selected');

      // åˆ¤æ–·æ­£ç¢º
      let correctIndex = q.answer;
      if (typeof correctIndex === 'string') {
        correctIndex = correctIndex.charCodeAt(0) - 65;
      }

      const isCorrect = index === correctIndex;
      const timeSpent = Math.round((Date.now() - state.questionStartTime) / 1000);

      // è¨˜éŒ„ç­”æ¡ˆ
      state.answers.push({
        questionId: q.id || q.question_id,
        nodeId: q.node_id,
        subjectId: q.subject,
        userAnswer: String.fromCharCode(65 + index),
        correctAnswer: String.fromCharCode(65 + correctIndex),
        isCorrect,
        timeSpent
      });

      // é¡¯ç¤ºçµæœ
      if (isCorrect) {
        options[index].classList.add('correct');
        state.streak++;
        if (state.streak > state.maxStreak) state.maxStreak = state.streak;
        showFeedback(true, q.explanation);
      } else {
        options[index].classList.add('wrong');
        options[correctIndex].classList.add('correct');
        state.streak = 0;
        showFeedback(false, q.explanation);
      }

      // æ›´æ–°é€£çºŒç­”å°
      document.getElementById('streak').textContent = state.streak;

      // æäº¤åˆ°å¾Œç«¯
      try {
        await BeidouAPI.answers.submit({
          questionId: q.id || q.question_id,
          nodeId: q.node_id,
          subjectId: q.subject,
          userAnswer: String.fromCharCode(65 + index),
          correctAnswer: String.fromCharCode(65 + correctIndex),
          timeSpent
        });
      } catch (e) {
        console.error('Submit answer error:', e);
      }

      // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
      document.getElementById('skipBtn').classList.add('hidden');
      if (state.currentIndex < state.questions.length - 1) {
        document.getElementById('nextBtn').classList.remove('hidden');
      } else {
        document.getElementById('finishBtn').classList.remove('hidden');
      }

      updateAccuracy();
    }

    function showFeedback(isCorrect, explanation) {
      const feedback = document.getElementById('feedback');
      const icon = document.getElementById('feedbackIcon');
      const text = document.getElementById('feedbackText');
      const exp = document.getElementById('explanation');

      feedback.classList.remove('hidden');
      
      if (isCorrect) {
        icon.textContent = state.streak >= 3 ? 'ğŸ”¥' : 'âœ…';
        text.innerHTML = state.streak >= 3 
          ? `<span class="text-orange-500">é€£çºŒ ${state.streak} é¡Œæ­£ç¢ºï¼</span>` 
          : '<span class="text-green-600">ç­”å°äº†ï¼</span>';
        text.className = 'text-center font-medium mb-4';
      } else {
        icon.textContent = 'âŒ';
        text.innerHTML = '<span class="text-red-600">ç­”éŒ¯äº†ï¼Œç¹¼çºŒåŠ æ²¹ï¼</span>';
      }

      exp.innerHTML = explanation || 'æš«ç„¡è§£æ';
    }

    function skipQuestion() {
      state.answers.push({
        questionId: state.questions[state.currentIndex].id,
        skipped: true
      });
      nextQuestion();
    }

    function nextQuestion() {
      state.currentIndex++;
      if (state.currentIndex < state.questions.length) {
        renderQuestion();
      } else {
        showResults();
      }
    }

    function showResults() {
      const correct = state.answers.filter(a => a.isCorrect).length;
      const total = state.answers.filter(a => !a.skipped).length;
      const score = total > 0 ? Math.round(correct / total * 100) : 0;

      document.getElementById('finalScore').textContent = score + '%';
      document.getElementById('totalAnswered').textContent = state.answers.length;
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('wrongCountResult').textContent = total - correct;
      
      // è¡¨æƒ…
      let emoji = 'ğŸ˜…';
      if (score >= 90) emoji = 'ğŸ†';
      else if (score >= 80) emoji = 'ğŸ‰';
      else if (score >= 60) emoji = 'ğŸ‘';
      document.getElementById('resultEmoji').textContent = emoji;

      document.getElementById('resultsModal').classList.remove('hidden');
    }

    function updateAccuracy() {
      const answered = state.answers.filter(a => !a.skipped);
      const correct = answered.filter(a => a.isCorrect).length;
      const accuracy = answered.length > 0 ? Math.round(correct / answered.length * 100) : 100;
      document.getElementById('accuracy').textContent = accuracy + '%';
    }

    // è¨ˆæ™‚å™¨
    function startTimer() {
      setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const secs = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${mins}:${secs}`;
      }, 1000);
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
