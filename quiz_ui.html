<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | å­¸æ¸¬ç·´ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .subject-card { transition: all 0.2s ease; cursor: pointer; }
        .subject-card:hover { transform: scale(1.02); }
        .subject-card.active { border-color: #3b82f6; background: #eff6ff; }
        .option-btn { transition: all 0.2s ease; }
        .option-btn:hover:not(.answered) { transform: scale(1.01); background: #f3f4f6; }
        .option-btn.selected { border-color: #3b82f6; background: #eff6ff; }
        .option-btn.correct { border-color: #10b981; background: #d1fae5; }
        .option-btn.wrong { border-color: #ef4444; background: #fee2e2; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0VB6K9G7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());
  gtag("config", "G-8X0VB6K9G7");
</script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <a href="index.html" class="flex items-center space-x-3">
                        <div class="text-3xl">â­</div>
                        <div>
                            <h1 class="text-xl font-bold">åŒ—æ–—æ•™è‚²</h1>
                            <p class="text-sm text-blue-200">108èª²ç¶±å­¸æ¸¬ç·´ç¿’</p>
                        </div>
                    </a>
                    <div class="text-right">
                        <div class="text-2xl font-bold" id="totalQuestions">--</div>
                        <div class="text-sm text-blue-200">é“é¡Œç›®</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!-- Loading -->
            <div id="loadingSection" class="text-center py-12">
                <div class="text-4xl mb-4 loading">â­</div>
                <p class="text-gray-500">è¼‰å…¥é¡Œåº«ä¸­...</p>
            </div>

            <!-- Subject Selection -->
            <section id="subjectSection" class="mb-8 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“š é¸æ“‡ç§‘ç›®</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3" id="subjectGrid"></div>
            </section>

            <!-- Quiz Settings -->
            <section id="settingsSection" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
                <h2 class="text-lg font-bold text-gray-800 mb-4">âš™ï¸ æ¸¬é©—è¨­å®š</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¡Œç›®æ•¸é‡</label>
                        <select id="countSelect" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="5">5 é¡Œï¼ˆå¿«é€Ÿï¼‰</option>
                            <option value="10" selected>10 é¡Œï¼ˆæ¨™æº–ï¼‰</option>
                            <option value="20">20 é¡Œï¼ˆå®Œæ•´ï¼‰</option>
                            <option value="50">50 é¡Œï¼ˆæŒ‘æˆ°ï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›£åº¦</label>
                        <select id="difficultySelect" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="" selected>æ··åˆ</option>
                            <option value="1">åŸºç¤</option>
                            <option value="2">é€²éš</option>
                            <option value="3">æŒ‘æˆ°</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="startQuiz()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-blue-700 transition">
                            é–‹å§‹æ¸¬é©— ğŸš€
                        </button>
                    </div>
                </div>
                <div id="selectedSubjectInfo" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                    <span class="text-gray-600">å·²é¸æ“‡ï¼š</span>
                    <span id="selectedSubjectName" class="font-bold text-blue-600"></span>
                    <span id="selectedSubjectCount" class="text-gray-500 ml-2"></span>
                </div>
            </section>

            <!-- Stats Table -->
            <section id="statsSection" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
                <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š å„ç§‘é¡Œåº«çµ±è¨ˆï¼ˆå³æ™‚ï¼‰</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b bg-gray-50">
                                <th class="text-left py-3 px-4 font-medium text-gray-600">ç§‘ç›®</th>
                                <th class="text-right py-3 px-4 font-medium text-gray-600">é¡Œç›®æ•¸</th>
                                <th class="text-right py-3 px-4 font-medium text-gray-600">ä½”æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Quiz Area -->
            <section id="quizArea" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-6 animate-fadeIn">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-2">
                            <span id="questionSubject" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"></span>
                            <span id="questionTopic" class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs"></span>
                        </div>
                        <div class="text-gray-500">
                            <span id="progressText">1 / 10</span>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 10%"></div>
                    </div>
                    
                    <div class="mb-6">
                        <p id="questionText" class="text-lg text-gray-800 leading-relaxed"></p>
                    </div>
                    
                    <div id="optionsContainer" class="space-y-3 mb-6"></div>
                    
                    <div id="explanationArea" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-bold text-gray-700 mb-2">ğŸ“ è§£æ</h4>
                        <p id="explanationText" class="text-gray-600"></p>
                        <div id="mnemonicArea" class="mt-2 hidden">
                            <span class="text-sm text-blue-600">ğŸ’¡ å£è¨£ï¼š</span>
                            <span id="mnemonicText" class="text-sm text-blue-800 font-medium"></span>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button onclick="prevQuestion()" id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50" disabled>
                            â† ä¸Šä¸€é¡Œ
                        </button>
                        <button onclick="nextQuestion()" id="nextBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ä¸‹ä¸€é¡Œ â†’
                        </button>
                    </div>
                </div>
            </section>

            <!-- Results Area -->
            <section id="resultsArea" class="hidden">
                <div class="bg-white rounded-xl shadow-md p-8 text-center animate-fadeIn">
                    <div class="text-6xl mb-4" id="resultEmoji">ğŸ‰</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">æ¸¬é©—å®Œæˆï¼</h2>
                    <div class="text-5xl font-bold text-blue-600 mb-2" id="scoreDisplay">80%</div>
                    <p class="text-gray-500 mb-6" id="scoreDetail">ç­”å° 8 / 10 é¡Œ</p>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
                        <div class="p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="correctCount">8</div>
                            <div class="text-sm text-green-700">ç­”å°</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <div class="text-2xl font-bold text-red-600" id="wrongCount">2</div>
                            <div class="text-sm text-red-700">ç­”éŒ¯</div>
                        </div>
                    </div>
                    
                    <!-- åˆ†äº«æŒ‰éˆ• -->
                    <div class="flex justify-center gap-2 mb-6">
                        <button onclick="shareResult('line')" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600" title="åˆ†äº«åˆ° LINE">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 5.67 2 10.2c0 4.03 3.58 7.4 8.39 8.05.33.07.77.21.88.49.1.25.07.64.03.89l-.14.85c-.04.26-.2 1.02.89.56 1.1-.46 5.93-3.49 8.09-5.98C21.95 12.08 22 10.69 22 10.2 22 5.67 17.52 2 12 2z"/></svg>
                        </button>
                        <button onclick="shareResult('fb')" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700" title="åˆ†äº«åˆ° Facebook">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg>
                        </button>
                        <button onclick="shareResult('twitter')" class="w-10 h-10 rounded-full bg-sky-500 text-white flex items-center justify-center hover:bg-sky-600" title="åˆ†äº«åˆ° X">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </button>
                        <button onclick="shareResult('copy')" class="w-10 h-10 rounded-full bg-gray-500 text-white flex items-center justify-center hover:bg-gray-600" title="è¤‡è£½é€£çµ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        </button>
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <button onclick="reviewAnswers()" class="px-6 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">
                            æŸ¥çœ‹è§£æ
                        </button>
                        <button onclick="resetQuiz()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            å†æ¸¬ä¸€æ¬¡
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
            <div class="container mx-auto px-4 text-center">
                <p>Â© 2025 åŒ—æ–—æ•¸ä½å·¥ä½œå®¤</p>
                <p class="text-sm mt-1">XTFå­¸ç¿’æ³• | æ¶ˆ-æ‹“-è</p>
            </div>
        </footer>
    </div>

    <script>
        // ==========================================
        // åŒ—æ–—æ•™è‚² å­¸æ¸¬ç·´ç¿’ v3.0 (API æ•´åˆç‰ˆ)
        // ==========================================
        
        // API Base URL
        const API_BASE = 'https://beidou-edu-server-1.onrender.com/api';
        
        // ç§‘ç›®åœ–æ¨™
        const subjectIcons = {
            'æ•¸å­¸': 'ğŸ“', 'ç‰©ç†': 'âš¡', 'åŒ–å­¸': 'ğŸ§ª', 'ç”Ÿç‰©': 'ğŸ§¬',
            'åœ°ç§‘': 'ğŸŒ', 'åœ‹æ–‡': 'ğŸ“œ', 'è‹±æ–‡': 'ğŸ”¤', 'æ­·å²': 'ğŸ›ï¸',
            'åœ°ç†': 'ğŸ—ºï¸', 'å…¬æ°‘': 'âš–ï¸'
        };
        
        // State
        let state = {
            subjects: [],
            selectedSubject: null,
            questions: [],
            currentIndex: 0,
            answers: [],
            score: 0
        };

        // API å‘¼å«
        async function fetchAPI(endpoint) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`);
                const data = await res.json();
                return data.success ? data : null;
            } catch (err) {
                console.error('API Error:', err);
                return null;
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            // è¼‰å…¥ç§‘ç›®çµ±è¨ˆ
            const stats = await fetchAPI('/subjects');
            
            if (stats && stats.data) {
                state.subjects = stats.data;
                document.getElementById('totalQuestions').textContent = stats.total.toLocaleString();
                
                // éš±è— loadingï¼Œé¡¯ç¤ºå…§å®¹
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('subjectSection').classList.remove('hidden');
                document.getElementById('settingsSection').classList.remove('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                
                renderSubjects();
                renderStats();
            } else {
                // API å¤±æ•—ï¼Œä½¿ç”¨å‚™æ´æ•¸æ“š
                useFallbackData();
            }
            
            checkUrlParams();
        }

        // å‚™æ´æ•¸æ“š
        function useFallbackData() {
            state.subjects = [
                { subject: 'æ•¸å­¸', count: 394 },
                { subject: 'ç‰©ç†', count: 169 },
                { subject: 'åœ°ç§‘', count: 127 },
                { subject: 'åœ‹æ–‡', count: 127 },
                { subject: 'è‹±æ–‡', count: 124 },
                { subject: 'åŒ–å­¸', count: 124 },
                { subject: 'å…¬æ°‘', count: 122 },
                { subject: 'ç”Ÿç‰©', count: 114 },
                { subject: 'åœ°ç†', count: 96 },
                { subject: 'æ­·å²', count: 94 }
            ];
            
            const total = state.subjects.reduce((sum, s) => sum + s.count, 0);
            document.getElementById('totalQuestions').textContent = total.toLocaleString();
            
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('subjectSection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            
            renderSubjects();
            renderStats();
        }

        // æª¢æŸ¥ URL åƒæ•¸
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const subject = params.get('subject');
            if (subject) {
                selectSubject(subject);
            }
        }

        // æ¸²æŸ“ç§‘ç›®é¸æ“‡
        function renderSubjects() {
            const grid = document.getElementById('subjectGrid');
            grid.innerHTML = state.subjects.map(s => `
                <div onclick="selectSubject('${s.subject}')" 
                    class="subject-card p-4 rounded-xl border-2 border-gray-200 bg-white hover:border-blue-400 hover:bg-blue-50 text-center"
                    data-subject="${s.subject}" id="card-${s.subject}">
                    <div class="text-3xl mb-2">${subjectIcons[s.subject] || 'ğŸ“š'}</div>
                    <div class="font-medium text-gray-700">${s.subject}</div>
                    <div class="text-xs text-gray-400 mt-1">${s.count} é¡Œ</div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“çµ±è¨ˆè¡¨æ ¼
        function renderStats() {
            const tbody = document.getElementById('statsTableBody');
            const total = state.subjects.reduce((sum, s) => sum + s.count, 0);

            tbody.innerHTML = state.subjects.map(s => `
                <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="selectSubject('${s.subject}')">
                    <td class="py-3 px-4">
                        <span class="mr-2">${subjectIcons[s.subject] || 'ğŸ“š'}</span>
                        <span class="font-medium">${s.subject}</span>
                    </td>
                    <td class="py-3 px-4 text-right text-blue-600 font-medium">${s.count}</td>
                    <td class="py-3 px-4 text-right text-gray-500">${Math.round(s.count / total * 100)}%</td>
                </tr>
            `).join('') + `
                <tr class="bg-gray-50 font-bold">
                    <td class="py-3 px-4">ç¸½è¨ˆ</td>
                    <td class="py-3 px-4 text-right text-blue-600">${total.toLocaleString()}</td>
                    <td class="py-3 px-4 text-right">100%</td>
                </tr>
            `;
        }

        // é¸æ“‡ç§‘ç›®
        function selectSubject(subjectId) {
            state.selectedSubject = subjectId;
            
            // GA äº‹ä»¶è¿½è¹¤ - ç§‘ç›®é¸æ“‡
            gtag('event', 'select_subject', {
                'event_category': 'quiz',
                'event_label': subjectId
            });
            
            document.querySelectorAll('.subject-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50', 'active');
            });
            const selectedCard = document.getElementById(`card-${subjectId}`);
            if (selectedCard) {
                selectedCard.classList.add('border-blue-500', 'bg-blue-50', 'active');
            }
            
            const subject = state.subjects.find(s => s.subject === subjectId);
            if (subject) {
                document.getElementById('selectedSubjectInfo').classList.remove('hidden');
                document.getElementById('selectedSubjectName').textContent = `${subjectIcons[subjectId] || 'ğŸ“š'} ${subjectId}`;
                document.getElementById('selectedSubjectCount').textContent = `(${subject.count} é¡Œå¯ç”¨)`;
            }
        }

        // é–‹å§‹æ¸¬é©—
        async function startQuiz() {
            if (!state.selectedSubject) {
                alert('è«‹å…ˆé¸æ“‡ç§‘ç›®ï¼');
                return;
            }
            
            const count = document.getElementById('countSelect').value;
            const difficulty = document.getElementById('difficultySelect').value;
            
            // GA äº‹ä»¶è¿½è¹¤ - é–‹å§‹æ¸¬é©—
            gtag('event', 'start_quiz', {
                'event_category': 'quiz',
                'event_label': state.selectedSubject,
                'value': parseInt(count)
            });
            
            // å¾ API ç²å–é¡Œç›®
            let endpoint = `/quiz/subject/${encodeURIComponent(state.selectedSubject)}?limit=${count}`;
            if (difficulty) {
                endpoint += `&difficulty=${difficulty}`;
            }
            
            const result = await fetchAPI(endpoint);
            
            if (result && result.data && result.data.length > 0) {
                state.questions = result.data;
            } else {
                alert('ç„¡æ³•è¼‰å…¥é¡Œç›®ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            state.currentIndex = 0;
            state.answers = new Array(state.questions.length).fill(null);
            state.score = 0;
            
            // åˆ‡æ›ä»‹é¢
            document.getElementById('subjectSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            
            renderQuestion();
        }

        // æ¸²æŸ“é¡Œç›®
        function renderQuestion() {
            const q = state.questions[state.currentIndex];
            const total = state.questions.length;
            
            document.getElementById('progressText').textContent = `${state.currentIndex + 1} / ${total}`;
            document.getElementById('progressBar').style.width = `${((state.currentIndex + 1) / total) * 100}%`;
            
            document.getElementById('questionSubject').textContent = q.subject;
            document.getElementById('questionTopic').textContent = q.topic || '';
            document.getElementById('questionText').textContent = q.text;
            
            const container = document.getElementById('optionsContainer');
            const answered = state.answers[state.currentIndex] !== null;
            const options = Array.isArray(q.options) ? q.options : JSON.parse(q.options || '[]');
            
            container.innerHTML = options.map((opt, i) => {
                let classes = 'option-btn w-full p-4 text-left border-2 rounded-lg';
                if (answered) {
                    classes += ' answered';
                    if (i === q.answer) {
                        classes += ' correct';
                    } else if (i === state.answers[state.currentIndex]) {
                        classes += ' wrong';
                    }
                } else if (state.answers[state.currentIndex] === i) {
                    classes += ' selected';
                }
                
                return `
                    <button onclick="${answered ? '' : `selectOption(${i})`}" class="${classes}" ${answered ? 'disabled' : ''}>
                        <span class="inline-block w-8 h-8 rounded-full bg-gray-100 text-center leading-8 mr-3 font-medium">
                            ${String.fromCharCode(65 + i)}
                        </span>
                        ${opt}
                        ${answered && i === q.answer ? ' âœ“' : ''}
                        ${answered && i === state.answers[state.currentIndex] && i !== q.answer ? ' âœ—' : ''}
                    </button>
                `;
            }).join('');
            
            const explanationArea = document.getElementById('explanationArea');
            if (answered) {
                explanationArea.classList.remove('hidden');
                document.getElementById('explanationText').textContent = q.explanation || 'æš«ç„¡è§£æ';
                
                if (q.mnemonic) {
                    document.getElementById('mnemonicArea').classList.remove('hidden');
                    document.getElementById('mnemonicText').textContent = q.mnemonic;
                } else {
                    document.getElementById('mnemonicArea').classList.add('hidden');
                }
            } else {
                explanationArea.classList.add('hidden');
            }
            
            document.getElementById('prevBtn').disabled = state.currentIndex === 0;
            document.getElementById('nextBtn').textContent = state.currentIndex === total - 1 ? 'å®Œæˆæ¸¬é©—' : 'ä¸‹ä¸€é¡Œ â†’';
        }

        function selectOption(optionIndex) {
            if (state.answers[state.currentIndex] !== null) return;
            
            const startTime = state.questionStartTime || Date.now();
            const timeSpent = Math.round((Date.now() - startTime) / 1000);
            
            state.answers[state.currentIndex] = optionIndex;
            const q = state.questions[state.currentIndex];
            const isCorrect = optionIndex === q.answer;
            if (isCorrect) {
                state.score++;
            }
            
            // GA äº‹ä»¶è¿½è¹¤ - ç­”é¡Œ
            gtag('event', 'answer_question', {
                'event_category': 'quiz',
                'event_label': isCorrect ? 'correct' : 'wrong',
                'value': state.currentIndex + 1
            });
            
            // MongoDB ç­”é¡Œè¨˜éŒ„
            recordAnswer({
                questionId: q.id || `q_${state.currentIndex}`,
                subject: q.subject,
                nodeId: q.node_id,
                userAnswer: optionIndex,
                correctAnswer: q.answer,
                isCorrect,
                timeSpent,
                source: 'quiz'
            });
            
            // é‡ç½®è¨ˆæ™‚
            state.questionStartTime = Date.now();
            
            renderQuestion();
        }
        
        // è¨˜éŒ„ç­”é¡Œåˆ° MongoDB
        async function recordAnswer(data) {
            const token = localStorage.getItem('beidou_token');
            if (!token) return; // æœªç™»å…¥ä¸è¨˜éŒ„
            
            try {
                const res = await fetch(`${API_BASE}/user/record-answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await res.json();
                if (result.success) {
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ¶è³‡æ–™
                    const userData = localStorage.getItem('beidou_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        user.xp = result.data.totalXp;
                        user.level = result.data.level;
                        user.coins = result.data.coins;
                        localStorage.setItem('beidou_user', JSON.stringify(user));
                        
                        // é¡¯ç¤º XP æç¤º
                        showXPToast(result.data.xpEarned, data.isCorrect);
                    }
                }
            } catch (err) {
                console.log('è¨˜éŒ„ç­”é¡Œå¤±æ•—:', err);
            }
        }
        
        // XP æç¤º
        function showXPToast(xp, isCorrect) {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all transform translate-x-full ${isCorrect ? 'bg-green-500' : 'bg-blue-500'}`;
            toast.textContent = `+${xp} XP`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }

        function prevQuestion() {
            if (state.currentIndex > 0) {
                state.currentIndex--;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (state.answers[state.currentIndex] === null) {
                alert('è«‹å…ˆä½œç­”ï¼');
                return;
            }
            
            if (state.currentIndex < state.questions.length - 1) {
                state.currentIndex++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            const total = state.questions.length;
            const correct = state.score;
            const wrong = total - correct;
            const percentage = Math.round((correct / total) * 100);
            
            // GA äº‹ä»¶è¿½è¹¤ - å®Œæˆæ¸¬é©—
            gtag('event', 'finish_quiz', {
                'event_category': 'quiz',
                'event_label': state.selectedSubject,
                'value': percentage
            });
            
            let emoji = 'ğŸ‰';
            if (percentage < 60) emoji = 'ğŸ’ª';
            else if (percentage < 80) emoji = 'ğŸ‘';
            
            document.getElementById('resultEmoji').textContent = emoji;
            document.getElementById('scoreDisplay').textContent = `${percentage}%`;
            document.getElementById('scoreDetail').textContent = `ç­”å° ${correct} / ${total} é¡Œ`;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            
            // å„²å­˜åˆ†äº«è³‡æ–™
            window.shareData = { subject: state.selectedSubject, percentage, correct, total };
            
            document.getElementById('quizArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');
        }
        
        // ç¤¾ç¾¤åˆ†äº«
        function shareResult(platform) {
            const { subject, percentage, correct, total } = window.shareData || {};
            const text = `ğŸŒŸ æˆ‘åœ¨åŒ—æ–—æ•™è‚²å®Œæˆäº† ${subject} æ¸¬é©—ï¼\nğŸ“Š æˆç¸¾ï¼š${percentage}% (${correct}/${total})\nğŸ’ª ä¸€èµ·ä¾†æŒ‘æˆ°ï¼`;
            const url = 'https://beidou-edu.github.io';
            
            const urls = {
                line: `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,
                fb: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`,
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
                copy: null
            };
            
            if (platform === 'copy') {
                navigator.clipboard.writeText(`${text}\n${url}`).then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'));
            } else {
                window.open(urls[platform], '_blank', 'width=600,height=400');
            }
            
            gtag('event', 'share_result', { 'event_category': 'social', 'event_label': platform });
        }

        function resetQuiz() {
            document.getElementById('subjectSection').classList.remove('hidden');
            document.getElementById('settingsSection').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            document.getElementById('quizArea').classList.add('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
        }

        function reviewAnswers() {
            state.currentIndex = 0;
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('quizArea').classList.remove('hidden');
            renderQuestion();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
