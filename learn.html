<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | XTF æ¦‚å¿µå­¸ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 50%, #0f172a 100%); }
        .card { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1); }
        .xtf-tab { transition: all 0.3s; }
        .xtf-tab.active { border-bottom: 3px solid; }
        .xtf-content { display: none; }
        .xtf-content.active { display: block; }
        .node-card { transition: all 0.3s; cursor: pointer; }
        .node-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.3); }
        .node-card.selected { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">

    <!-- å°èˆªåˆ— -->
    <nav class="py-4 px-6 border-b border-white/10">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒŸ</span>
                <span class="font-bold text-xl">åŒ—æ–—æ•™è‚²</span>
            </a>
            <div class="hidden md:flex items-center gap-6">
                <a href="courses.html" class="text-gray-300 hover:text-white">å­¸æ¸¬èª²ç¨‹</a>
                <a href="starmap.html" class="text-gray-300 hover:text-white">çŸ¥è­˜æ˜Ÿåœ–</a>
                <a href="battle.html" class="text-orange-400 hover:text-orange-300">âš”ï¸ æˆ°é¬¥</a>
            </div>
            <a href="auth.html" id="authLink" class="text-gray-300 hover:text-white">ç™»å…¥</a>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">ğŸ“– XTF æ¦‚å¿µå­¸ç¿’</h1>
            <p class="text-gray-400">æ¶ˆ(ç†è§£) â†’ æ‹“(è¨˜æ†¶) â†’ è(æ‡‰ç”¨)</p>
        </div>

        <div class="grid md:grid-cols-4 gap-6">
            <!-- å·¦å´ï¼šç§‘ç›®èˆ‡ç¯€é»é¸æ“‡ -->
            <div class="md:col-span-1 space-y-4">
                <!-- ç§‘ç›®é¸æ“‡ -->
                <div class="card rounded-xl p-4">
                    <h3 class="font-bold mb-3">ğŸ“š é¸æ“‡ç§‘ç›®</h3>
                    <select id="subjectSelect" onchange="loadNodes()" class="w-full bg-slate-700 rounded-lg p-2 text-white">
                        <option value="">-- é¸æ“‡ç§‘ç›® --</option>
                    </select>
                </div>

                <!-- ç¯€é»åˆ—è¡¨ -->
                <div class="card rounded-xl p-4 max-h-[500px] overflow-y-auto">
                    <h3 class="font-bold mb-3">ğŸ“‹ çŸ¥è­˜ç¯€é» <span id="nodeCount" class="text-gray-400 text-sm">(0)</span></h3>
                    <div id="nodeList" class="space-y-2">
                        <p class="text-gray-500 text-sm">è«‹å…ˆé¸æ“‡ç§‘ç›®</p>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šXTF å…§å®¹ -->
            <div class="md:col-span-3">
                <div class="card rounded-xl overflow-hidden">
                    <!-- XTF æ¨™ç±¤ -->
                    <div class="flex border-b border-white/10">
                        <button onclick="showTab('understand')" class="xtf-tab active flex-1 py-4 text-center border-blue-400 text-blue-400" data-tab="understand">
                            ğŸ”» æ¶ˆ (ç†è§£)
                        </button>
                        <button onclick="showTab('memorize')" class="xtf-tab flex-1 py-4 text-center text-gray-400 hover:text-purple-400" data-tab="memorize">
                            ğŸ”€ æ‹“ (è¨˜æ†¶)
                        </button>
                        <button onclick="showTab('apply')" class="xtf-tab flex-1 py-4 text-center text-gray-400 hover:text-green-400" data-tab="apply">
                            ğŸ”º è (æ‡‰ç”¨)
                        </button>
                    </div>

                    <!-- å…§å®¹å€ -->
                    <div class="p-6">
                        <!-- ç¯€é»æ¨™é¡Œ -->
                        <div id="nodeTitle" class="mb-6">
                            <h2 class="text-2xl font-bold mb-2">é¸æ“‡ä¸€å€‹çŸ¥è­˜ç¯€é»</h2>
                            <p class="text-gray-400">å¾å·¦å´åˆ—è¡¨é¸æ“‡è¦å­¸ç¿’çš„æ¦‚å¿µ</p>
                        </div>

                        <!-- æ¶ˆï¼šç†è§£ -->
                        <div id="tab-understand" class="xtf-content active">
                            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-6">
                                <h3 class="text-lg font-bold text-blue-400 mb-4">ğŸ”» æ¶ˆï¼šç™½è©±ç†è§£</h3>
                                <div id="content-understand" class="text-gray-300 leading-relaxed whitespace-pre-wrap">
                                    é¸æ“‡ç¯€é»å¾Œé¡¯ç¤ºå…§å®¹...
                                </div>
                            </div>
                        </div>

                        <!-- æ‹“ï¼šè¨˜æ†¶ -->
                        <div id="tab-memorize" class="xtf-content">
                            <div class="bg-purple-900/20 border border-purple-500/30 rounded-xl p-6">
                                <h3 class="text-lg font-bold text-purple-400 mb-4">ğŸ”€ æ‹“ï¼šå£è¨£è¨˜æ†¶</h3>
                                <div id="content-memorize" class="text-gray-300 leading-relaxed whitespace-pre-wrap">
                                    é¸æ“‡ç¯€é»å¾Œé¡¯ç¤ºå…§å®¹...
                                </div>
                            </div>
                        </div>

                        <!-- èï¼šæ‡‰ç”¨ -->
                        <div id="tab-apply" class="xtf-content">
                            <div class="bg-green-900/20 border border-green-500/30 rounded-xl p-6">
                                <h3 class="text-lg font-bold text-green-400 mb-4">ğŸ”º èï¼šè€ƒè©¦æ‡‰ç”¨</h3>
                                <div id="content-apply" class="text-gray-300 leading-relaxed whitespace-pre-wrap">
                                    é¸æ“‡ç¯€é»å¾Œé¡¯ç¤ºå…§å®¹...
                                </div>
                            </div>

                            <!-- ç›¸é—œé€£çµ -->
                            <div id="linkSection" class="mt-4 hidden">
                                <div class="text-gray-400 text-sm mb-2">ğŸ“ ç›¸é—œæ¦‚å¿µï¼š</div>
                                <div id="content-link" class="text-purple-400"></div>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div id="actionButtons" class="mt-6 flex gap-3 hidden">
                            <a id="btn-starmap" href="starmap.html" class="flex-1 bg-purple-600 hover:bg-purple-500 py-3 rounded-lg font-bold text-center">
                                ğŸŒŸ æŸ¥çœ‹æ˜Ÿåœ–
                            </a>
                            <a id="btn-battle" href="battle.html" class="flex-1 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 py-3 rounded-lg font-bold text-center">
                                âš”ï¸ é–‹å§‹æˆ°é¬¥
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-8 border-t border-white/10 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-500">
            <p>Â© 2025 åŒ—æ–—ä¸ƒæ˜Ÿæ–‡å‰µæ•¸ä½æœ‰é™å…¬å¸</p>
        </div>
    </footer>

    <script>
        let nodesData = null;
        let currentNode = null;

        const subjectNames = {
            'math': 'æ•¸å­¸',
            'physics': 'ç‰©ç†',
            'chemistry': 'åŒ–å­¸',
            'biology': 'ç”Ÿç‰©',
            'earth_science': 'åœ°çƒç§‘å­¸',
            'chinese': 'åœ‹æ–‡',
            'english': 'è‹±æ–‡',
            'history': 'æ­·å²',
            'geography': 'åœ°ç†',
            'civics': 'å…¬æ°‘'
        };

        const subjectEmojis = {
            'math': 'ğŸ“',
            'physics': 'âš¡',
            'chemistry': 'ğŸ§ª',
            'biology': 'ğŸ§¬',
            'earth_science': 'ğŸŒ',
            'chinese': 'ğŸ“š',
            'english': 'ğŸ”¤',
            'history': 'ğŸ“œ',
            'geography': 'ğŸ—ºï¸',
            'civics': 'âš–ï¸'
        };

        // åˆå§‹åŒ–
        async function init() {
            try {
                const res = await fetch('data/nodes_xtf.json');
                nodesData = await res.json();
                console.log(`è¼‰å…¥ ${nodesData.meta.total} å€‹ç¯€é»`);
                
                // å¡«å……ç§‘ç›®é¸æ“‡
                const select = document.getElementById('subjectSelect');
                for (const subj of nodesData.meta.subjects) {
                    const opt = document.createElement('option');
                    opt.value = subj;
                    opt.textContent = `${subjectEmojis[subj] || 'ğŸ“'} ${subjectNames[subj] || subj}`;
                    select.appendChild(opt);
                }

                // URL åƒæ•¸
                const params = new URLSearchParams(window.location.search);
                const subject = params.get('subject');
                if (subject) {
                    // è½‰æ›ä¸­æ–‡ç§‘ç›®ååˆ° key
                    const subjectKey = Object.entries(subjectNames).find(([k, v]) => v === subject)?.[0];
                    if (subjectKey) {
                        select.value = subjectKey;
                        loadNodes();
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
            }

            // ç™»å…¥ç‹€æ…‹
            const user = JSON.parse(localStorage.getItem('beidou_user') || 'null');
            if (user && !user.guest) {
                document.getElementById('authLink').textContent = user.username || 'æœƒå“¡';
                document.getElementById('authLink').href = 'dashboard.html';
            }
        }

        // è¼‰å…¥ç¯€é»åˆ—è¡¨
        function loadNodes() {
            const subject = document.getElementById('subjectSelect').value;
            const container = document.getElementById('nodeList');
            
            if (!subject || !nodesData.by_subject[subject]) {
                container.innerHTML = '<p class="text-gray-500 text-sm">è«‹é¸æ“‡ç§‘ç›®</p>';
                document.getElementById('nodeCount').textContent = '(0)';
                return;
            }

            const nodes = nodesData.by_subject[subject];
            document.getElementById('nodeCount').textContent = `(${nodes.length})`;

            container.innerHTML = nodes.map((n, i) => `
                <div class="node-card card rounded-lg p-3 text-sm" onclick="selectNode('${subject}', ${i})">
                    <div class="font-medium">${n.name}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${'â­'.repeat(n.importance || 3)}
                    </div>
                </div>
            `).join('');
        }

        // é¸æ“‡ç¯€é»
        function selectNode(subject, index) {
            const node = nodesData.by_subject[subject][index];
            currentNode = node;

            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.node-card').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('nodeTitle').innerHTML = `
                <h2 class="text-2xl font-bold mb-2">${subjectEmojis[subject] || 'ğŸ“'} ${node.name}</h2>
                <div class="flex items-center gap-4 text-sm text-gray-400">
                    <span>é‡è¦åº¦ï¼š${'â­'.repeat(node.importance || 3)}</span>
                    <span>é›£åº¦ï¼š${'ğŸ”¥'.repeat(node.difficulty || 2)}</span>
                </div>
            `;

            // å¡«å…… XTF å…§å®¹
            document.getElementById('content-understand').textContent = node.understand || 'æš«ç„¡å…§å®¹';
            document.getElementById('content-memorize').textContent = node.memorize || 'æš«ç„¡å…§å®¹';
            document.getElementById('content-apply').textContent = node.apply || 'æš«ç„¡å…§å®¹';
            
            // ç›¸é—œé€£çµ
            if (node.link) {
                document.getElementById('linkSection').classList.remove('hidden');
                document.getElementById('content-link').textContent = node.link;
            } else {
                document.getElementById('linkSection').classList.add('hidden');
            }

            // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
            document.getElementById('actionButtons').classList.remove('hidden');
            
            // æ›´æ–°é€£çµ
            const subjectZh = subjectNames[subject] || subject;
            document.getElementById('btn-starmap').href = `starmap.html?subject=${subjectZh}`;
            document.getElementById('btn-battle').href = `battle.html?subject=${subjectZh}`;
        }

        // åˆ‡æ›æ¨™ç±¤
        function showTab(tab) {
            // æ›´æ–°æ¨™ç±¤æ¨£å¼
            document.querySelectorAll('.xtf-tab').forEach(el => {
                const isActive = el.dataset.tab === tab;
                el.classList.toggle('active', isActive);
                el.classList.toggle('text-gray-400', !isActive);
                
                if (isActive) {
                    if (tab === 'understand') el.classList.add('text-blue-400', 'border-blue-400');
                    else if (tab === 'memorize') el.classList.add('text-purple-400', 'border-purple-400');
                    else if (tab === 'apply') el.classList.add('text-green-400', 'border-green-400');
                } else {
                    el.classList.remove('text-blue-400', 'border-blue-400', 'text-purple-400', 'border-purple-400', 'text-green-400', 'border-green-400');
                }
            });

            // é¡¯ç¤ºå°æ‡‰å…§å®¹
            document.querySelectorAll('.xtf-content').forEach(el => {
                el.classList.toggle('active', el.id === `tab-${tab}`);
            });
        }

        init();
    </script>
</body>
</html>
