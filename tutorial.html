<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | æ–°æ‰‹æ‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .dream-bg { background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); min-height: 100vh; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .fade-in { animation: fadeIn 0.8s ease-in forwards; opacity: 0; }
        @keyframes fadeIn { to { opacity: 1; } }
        .flashcard { perspective: 1000px; }
        .flashcard-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { backface-visibility: hidden; position: absolute; inset: 0; }
        .flashcard-back { transform: rotateY(180deg); }
        .dialog-box { background: rgba(30, 41, 59, 0.95); border: 2px solid rgba(96, 165, 250, 0.5); box-shadow: 0 0 30px rgba(96, 165, 250, 0.2); }
        .monster-dialog { background: rgba(51, 65, 85, 0.95); border: 2px solid rgba(251, 191, 36, 0.5); }
        .subject-card { transition: all 0.3s; }
        .subject-card:hover { transform: scale(1.05); }
        .subject-card.selected { border-color: #fbbf24; box-shadow: 0 0 20px rgba(251,191,36,0.4); }
        .hp-bar { transition: width 0.5s ease-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .shake { animation: shake 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .bounce { animation: bounce 0.5s; }
        @keyframes glow { 0%, 100% { filter: drop-shadow(0 0 5px gold); } 50% { filter: drop-shadow(0 0 20px gold); } }
        .glow { animation: glow 1s infinite; }
    </style>
</head>
<body class="dream-bg text-white overflow-hidden">
    <div id="stars" class="fixed inset-0 pointer-events-none z-0"></div>
    <div id="app" class="relative z-10 min-h-screen flex items-center justify-center p-4"></div>

    <script>
    let dialogues = null, flashcards = null, monsters = null;
    
    let state = {
        stage: 'loading',
        name: '',
        subject: '',
        currentDialog: 0,
        currentCard: 0,
        currentMonster: 0,
        currentQuestion: 0,
        battlePhase: 'appear',
        playerHp: 100,
        monsterHp: 0,
        exp: 0,
        coins: 0
    };

    const subjects = [
        { id: 'æ•¸å­¸', icon: 'ğŸ“', color: 'from-amber-500 to-orange-500' },
        { id: 'ç‰©ç†', icon: 'âš›ï¸', color: 'from-blue-500 to-cyan-500' },
        { id: 'åŒ–å­¸', icon: 'ğŸ§ª', color: 'from-purple-500 to-pink-500' },
        { id: 'ç”Ÿç‰©', icon: 'ğŸ§¬', color: 'from-green-500 to-teal-500' },
        { id: 'åœ‹æ–‡', icon: 'ğŸ“œ', color: 'from-red-500 to-rose-500' },
        { id: 'è‹±æ–‡', icon: 'ğŸ”¤', color: 'from-indigo-500 to-blue-500' },
        { id: 'æ­·å²', icon: 'ğŸ›ï¸', color: 'from-yellow-600 to-amber-600' },
        { id: 'åœ°ç†', icon: 'ğŸŒ', color: 'from-emerald-500 to-green-500' },
        { id: 'å…¬æ°‘èˆ‡ç¤¾æœƒ', icon: 'âš–ï¸', color: 'from-slate-500 to-gray-500' },
        { id: 'åœ°çƒç§‘å­¸', icon: 'ğŸŒ', color: 'from-sky-500 to-blue-500' }
    ];

    async function init() {
        createStars();
        if (localStorage.getItem('beidou_tutorial_done')) {
            window.location.href = 'index.html';
            return;
        }
        try {
            const [d1, d2, d3] = await Promise.all([
                fetch('data/tutorial_dialogues.json').then(r => r.json()),
                fetch('data/tutorial_flashcards.json').then(r => r.json()),
                fetch('data/tutorial_monsters.json').then(r => r.json())
            ]);
            dialogues = d1; flashcards = d2; monsters = d3;
            state.stage = 'opening';
            render();
        } catch (e) {
            document.getElementById('app').innerHTML = '<div class="text-red-400">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
        }
    }

    function createStars() {
        const c = document.getElementById('stars');
        for (let i = 0; i < 80; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;width:${Math.random()*2+1}px;height:${Math.random()*2+1}px;animation-delay:${Math.random()*2}s`;
            c.appendChild(s);
        }
    }

    function render() {
        const app = document.getElementById('app');
        const renders = {
            opening: renderOpening,
            chenyun: renderChenyun,
            name: renderName,
            subject: renderSubject,
            flashcard_intro: renderFlashcardIntro,
            flashcard: renderFlashcard,
            battle_intro: renderBattleIntro,
            battle: renderBattle,
            monster_defeat: renderMonsterDefeat,
            ending: renderEnding
        };
        app.innerHTML = (renders[state.stage] || (() => ''))();
    }

    // ===== é–‹å ´ =====
    function renderOpening() {
        return `<div class="text-center max-w-2xl fade-in">
            <div class="text-2xl md:text-3xl leading-relaxed mb-12 min-h-[100px]">${dialogues.opening[state.currentDialog]}</div>
            <button onclick="nextOpening()" class="px-8 py-3 bg-blue-600/50 hover:bg-blue-600 rounded-full border border-blue-400/50 transition">
                ${state.currentDialog < dialogues.opening.length - 1 ? 'ç¹¼çºŒ' : 'é€²å…¥å¤¢å¢ƒ'}
            </button>
        </div>`;
    }
    function nextOpening() {
        if (++state.currentDialog >= dialogues.opening.length) { state.stage = 'chenyun'; state.currentDialog = 0; }
        render();
    }

    // ===== æ¾„éŸ» =====
    function renderChenyun() {
        return `<div class="text-center max-w-2xl">
            <div class="text-8xl mb-6 fade-in">ğŸ‘©â€ğŸ«</div>
            <div class="text-xl text-blue-400 mb-2 fade-in">æ¾„éŸ» Â· å¤©æ¬Šæ˜Ÿ</div>
            <div class="dialog-box rounded-2xl p-6 mb-8 fade-in"><div class="text-xl leading-relaxed">${dialogues.chenyun_intro[state.currentDialog]}</div></div>
            <button onclick="nextChenyun()" class="px-8 py-3 bg-blue-600/50 hover:bg-blue-600 rounded-full border border-blue-400/50 transition fade-in">
                ${state.currentDialog < dialogues.chenyun_intro.length - 1 ? 'ç¹¼çºŒ' : 'ä½ å¥½ï¼Œæ¾„éŸ»'}
            </button>
        </div>`;
    }
    function nextChenyun() {
        if (++state.currentDialog >= dialogues.chenyun_intro.length) { state.stage = 'name'; }
        render();
    }

    // ===== åå­— =====
    function renderName() {
        return `<div class="text-center max-w-md w-full">
            <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
            <div class="dialog-box rounded-2xl p-6 mb-6">
                <div class="text-xl mb-2">${dialogues.name_prompt.ask}</div>
                <div class="text-sm text-gray-400">${dialogues.name_prompt.hint}</div>
            </div>
            <input type="text" id="playerName" maxlength="10" placeholder="è¼¸å…¥ä½ çš„åå­—..." class="w-full bg-slate-800/80 border border-white/20 rounded-xl px-4 py-3 text-center text-xl mb-4 focus:border-blue-400 focus:outline-none">
            <button onclick="submitName()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-bold">ç¢ºèª</button>
        </div>`;
    }
    function submitName() {
        const n = document.getElementById('playerName').value.trim();
        if (!n) { alert('è«‹è¼¸å…¥åå­—'); return; }
        state.name = n; state.stage = 'subject'; render();
    }

    // ===== é¸ç§‘ =====
    function renderSubject() {
        return `<div class="text-center max-w-4xl w-full">
            <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
            <div class="dialog-box rounded-2xl p-4 mb-6 inline-block">
                <div class="text-lg">${dialogues.subject_prompt.ask}</div>
                <div class="text-sm text-gray-400">${dialogues.subject_prompt.hint}</div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                ${subjects.map(s => `<button onclick="selectSubject('${s.id}')" class="subject-card bg-gradient-to-br ${s.color} p-4 rounded-xl border-2 ${state.subject === s.id ? 'border-amber-400' : 'border-transparent'}">
                    <div class="text-3xl mb-1">${s.icon}</div><div class="font-bold text-sm">${s.id}</div>
                </button>`).join('')}
            </div>
            ${state.subject ? `<button onclick="confirmSubject()" class="px-8 py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold">ç¢ºèªé¸æ“‡ ${subjects.find(s=>s.id===state.subject)?.icon} ${state.subject}</button>` : ''}
        </div>`;
    }
    function selectSubject(id) { state.subject = id; render(); }
    function confirmSubject() { state.stage = 'flashcard_intro'; state.currentDialog = 0; render(); }

    // ===== é–ƒå¡ä»‹ç´¹ =====
    function renderFlashcardIntro() {
        return `<div class="text-center max-w-2xl">
            <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
            <div class="dialog-box rounded-2xl p-6 mb-8"><div class="text-xl leading-relaxed">${dialogues.flashcard_intro[state.currentDialog]}</div></div>
            <button onclick="nextFlashcardIntro()" class="px-8 py-3 bg-blue-600/50 hover:bg-blue-600 rounded-full border border-blue-400/50 transition">
                ${state.currentDialog < dialogues.flashcard_intro.length - 1 ? 'ç¹¼çºŒ' : 'é–‹å§‹å­¸ç¿’'}
            </button>
        </div>`;
    }
    function nextFlashcardIntro() {
        if (++state.currentDialog >= dialogues.flashcard_intro.length) { state.stage = 'flashcard'; state.currentCard = 0; }
        render();
    }

    // ===== é–ƒå¡ =====
    function renderFlashcard() {
        const cards = flashcards[state.subject], card = cards[state.currentCard];
        return `<div class="text-center max-w-lg w-full">
            <div class="flex items-center justify-between mb-4 text-sm text-gray-400">
                <span>${subjects.find(s=>s.id===state.subject)?.icon} ${state.subject}</span>
                <span>é–ƒå¡ ${state.currentCard + 1} / ${cards.length}</span>
            </div>
            <div class="h-2 bg-gray-700 rounded-full mb-6 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500" style="width:${(state.currentCard+1)/cards.length*100}%"></div>
            </div>
            <div id="flashcard" class="flashcard h-64 mb-6 cursor-pointer" onclick="flipCard()">
                <div class="flashcard-inner relative w-full h-full">
                    <div class="flashcard-front bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-6 flex items-center justify-center border border-white/10"><div class="text-xl">${card.front}</div></div>
                    <div class="flashcard-back bg-gradient-to-br from-blue-900 to-purple-900 rounded-2xl p-6 flex items-center justify-center border border-blue-400/30"><div class="text-lg">${card.back}</div></div>
                </div>
            </div>
            <div class="text-sm text-gray-400 mb-4">é»æ“Šå¡ç‰‡ç¿»è½‰</div>
            <div class="flex gap-4">
                <button onclick="rateCard('ğŸ˜•')" class="flex-1 py-3 bg-red-900/50 hover:bg-red-800 rounded-xl">ğŸ˜• ä¸ç†Ÿ</button>
                <button onclick="rateCard('ğŸ¤”')" class="flex-1 py-3 bg-yellow-900/50 hover:bg-yellow-800 rounded-xl">ğŸ¤” æœ‰å°è±¡</button>
                <button onclick="rateCard('ğŸ˜„')" class="flex-1 py-3 bg-green-900/50 hover:bg-green-800 rounded-xl">ğŸ˜„ ç†Ÿäº†</button>
            </div>
        </div>`;
    }
    function flipCard() { document.getElementById('flashcard').classList.toggle('flipped'); }
    function rateCard(r) {
        state.exp += r==='ğŸ˜„'?10:r==='ğŸ¤”'?5:2;
        if (++state.currentCard >= flashcards[state.subject].length) { state.stage = 'battle_intro'; state.currentDialog = 0; }
        render();
    }

    // ===== æˆ°é¬¥ä»‹ç´¹ =====
    function renderBattleIntro() {
        return `<div class="text-center max-w-2xl">
            <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
            <div class="dialog-box rounded-2xl p-6 mb-8"><div class="text-xl leading-relaxed">${dialogues.battle_intro[state.currentDialog]}</div></div>
            <button onclick="nextBattleIntro()" class="px-8 py-3 bg-red-600/50 hover:bg-red-600 rounded-full border border-red-400/50 transition">
                ${state.currentDialog < dialogues.battle_intro.length - 1 ? 'ç¹¼çºŒ' : 'âš”ï¸ é–‹å§‹æˆ°é¬¥ï¼'}
            </button>
        </div>`;
    }
    function nextBattleIntro() {
        if (++state.currentDialog >= dialogues.battle_intro.length) {
            state.stage = 'battle';
            state.currentMonster = 0; state.currentQuestion = 0;
            state.playerHp = 100; state.monsterHp = monsters.monsters[0].hp;
            state.battlePhase = 'appear';
        }
        render();
    }

    // ===== æˆ°é¬¥ =====
    function renderBattle() {
        const m = monsters.monsters[state.currentMonster];
        const cards = flashcards[state.subject];
        const card = cards[(state.currentMonster * 2 + state.currentQuestion) % cards.length];
        const mHpPct = Math.max(0, state.monsterHp / m.hp * 100);
        const pHpPct = Math.max(0, state.playerHp);
        
        // æ€ªç‰©å°è©±
        let mDialog = m.dialogues[state.battlePhase] || m.dialogues.attack;
        if (state.monsterHp < m.hp * 0.3 && m.dialogues.low_hp) mDialog = m.dialogues.low_hp;
        
        return `<div class="w-full max-w-2xl">
            <!-- æ€ªç‰© -->
            <div class="text-center mb-4">
                <div class="text-sm text-gray-400 mb-1">Lv.${m.level} ${m.name}</div>
                <div id="monsterAvatar" class="text-7xl mb-2 ${state.battlePhase==='appear'?'bounce':''}">${m.avatar}</div>
                <div class="monster-dialog rounded-xl px-4 py-2 mb-3 mx-auto max-w-sm fade-in">
                    <div class="text-sm text-amber-100">${mDialog}</div>
                </div>
                <div class="w-48 mx-auto">
                    <div class="flex justify-between text-xs text-gray-400 mb-1"><span>HP</span><span>${Math.max(0,state.monsterHp)}/${m.hp}</span></div>
                    <div class="h-3 bg-gray-700 rounded-full overflow-hidden"><div class="hp-bar h-full bg-gradient-to-r from-red-500 to-orange-500 rounded-full" style="width:${mHpPct}%"></div></div>
                </div>
            </div>
            <!-- é¡Œç›® -->
            <div class="bg-slate-800/80 rounded-2xl p-6 mb-4 border border-white/10">
                <div class="text-center text-lg mb-4">${card.front}</div>
                <input type="text" id="answerInput" placeholder="è¼¸å…¥ç­”æ¡ˆ..." class="w-full bg-slate-900 border border-white/20 rounded-xl px-4 py-3 text-center focus:border-blue-400 focus:outline-none" onkeypress="if(event.key==='Enter')submitAnswer()">
                <div class="text-xs text-gray-500 mt-2 text-center">æç¤ºï¼š${card.back.substring(0,15)}...</div>
            </div>
            <button onclick="submitAnswer()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-bold mb-4">âš”ï¸ ç¢ºèªç­”æ¡ˆ</button>
            <!-- æ¾„éŸ»æç¤º -->
            <div class="flex items-start gap-3 bg-blue-900/30 rounded-xl p-3 mb-4 border border-blue-500/30">
                <span class="text-2xl">ğŸ‘©â€ğŸ«</span>
                <div class="text-sm text-blue-200">${monsters.chenyun_battle_tips[Math.floor(Math.random()*monsters.chenyun_battle_tips.length)].replace('{name}',state.name)}</div>
            </div>
            <!-- ç©å®¶ -->
            <div class="flex items-center justify-between bg-slate-800/50 rounded-xl p-3">
                <div class="flex items-center gap-2"><span class="text-2xl">ğŸ§™</span><span class="font-bold">${state.name}</span></div>
                <div class="w-32">
                    <div class="text-xs text-gray-400 text-right mb-1">HP ${pHpPct}/100</div>
                    <div class="h-2 bg-gray-700 rounded-full overflow-hidden"><div class="hp-bar h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full" style="width:${pHpPct}%"></div></div>
                </div>
            </div>
        </div>`;
    }

    function submitAnswer() {
        const ans = document.getElementById('answerInput').value.trim();
        const m = monsters.monsters[state.currentMonster];
        const isCorrect = ans.length > 0;
        
        if (isCorrect) {
            state.monsterHp -= monsters.battle_rules.correct_damage;
            state.exp += 15; state.coins += 20;
            state.battlePhase = 'hit';
        } else {
            state.playerHp -= monsters.battle_rules.wrong_damage;
            state.battlePhase = 'miss';
        }
        render();
        
        if (isCorrect) {
            document.getElementById('monsterAvatar')?.classList.add('shake');
            setTimeout(() => document.getElementById('monsterAvatar')?.classList.remove('shake'), 400);
        }
        
        setTimeout(() => {
            if (state.monsterHp <= 0) {
                state.stage = 'monster_defeat';
                render();
                return;
            }
            if (state.playerHp <= 0) {
                state.playerHp = 20;
                alert('æ¾„éŸ»ï¼šã€Œåˆ¥ç°å¿ƒï¼Œæˆ‘ä¾†å¹«ä½ æ¢å¾©ä¸€äº›é«”åŠ›ï¼ã€');
            }
            state.battlePhase = 'attack';
            state.currentQuestion++;
            render();
        }, 1200);
    }

    // ===== æ€ªç‰©æ“Šæ•— =====
    function renderMonsterDefeat() {
        const m = monsters.monsters[state.currentMonster];
        return `<div class="text-center max-w-md fade-in">
            <div class="text-8xl mb-4 opacity-50">${m.avatar}</div>
            <div class="text-2xl font-bold text-amber-400 mb-4">ğŸ‰ æ“Šæ•— ${m.name}ï¼</div>
            <div class="monster-dialog rounded-2xl p-6 mb-6">
                <div class="text-lg leading-relaxed">${m.dialogues.defeat}</div>
            </div>
            <div class="flex justify-center gap-6 mb-6">
                <div class="text-center"><div class="text-2xl text-amber-400">+30</div><div class="text-sm text-gray-400">EXP</div></div>
                <div class="text-center"><div class="text-2xl text-yellow-400">+40</div><div class="text-sm text-gray-400">é‡‘å¹£</div></div>
            </div>
            <button onclick="nextMonster()" class="px-8 py-3 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold glow">
                ${state.currentMonster < monsters.monsters.length - 1 ? 'ç¹¼çºŒå‰é€² â†’' : 'ğŸ† å®Œæˆè©¦ç…‰ï¼'}
            </button>
        </div>`;
    }
    function nextMonster() {
        state.exp += 30; state.coins += 40;
        if (++state.currentMonster < monsters.monsters.length) {
            state.monsterHp = monsters.monsters[state.currentMonster].hp;
            state.currentQuestion = 0;
            state.battlePhase = 'appear';
            state.stage = 'battle';
        } else {
            state.stage = 'ending'; state.currentDialog = 0;
        }
        render();
    }

    // ===== çµç®— =====
    function renderEnding() {
        if (state.currentDialog < dialogues.ending.length - 1) {
            return `<div class="text-center max-w-2xl">
                <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
                <div class="dialog-box rounded-2xl p-6 mb-8"><div class="text-xl leading-relaxed">${dialogues.ending[state.currentDialog].replace('{name}',state.name)}</div></div>
                <button onclick="nextEnding()" class="px-8 py-3 bg-amber-600/50 hover:bg-amber-600 rounded-full border border-amber-400/50 transition">ç¹¼çºŒ</button>
            </div>`;
        }
        return `<div class="text-center max-w-md fade-in">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <div class="text-2xl font-bold mb-6">æ–°æ‰‹æ‘å®Œæˆï¼</div>
            <div class="bg-slate-800/80 rounded-2xl p-6 mb-6 border border-amber-500/30">
                <div class="text-lg mb-4">ç²å¾—çå‹µ</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900/50 rounded-xl p-3"><div class="text-amber-400 text-2xl font-bold">${state.exp}</div><div class="text-sm text-gray-400">ç¶“é©—å€¼</div></div>
                    <div class="bg-slate-900/50 rounded-xl p-3"><div class="text-yellow-400 text-2xl font-bold">${state.coins}</div><div class="text-sm text-gray-400">é‡‘å¹£</div></div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/10">
                    <div class="text-purple-400">ğŸ… ç²å¾—ç¨±è™Ÿ</div>
                    <div class="font-bold">ã€Œæ–°æ‰‹æ‘ç•¢æ¥­ç”Ÿã€</div>
                </div>
            </div>
            <button onclick="finishTutorial()" class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl font-bold text-lg glow">é€²å…¥å­¸æ¸¬å¤§é™¸ â†’</button>
        </div>`;
    }
    function nextEnding() { state.currentDialog++; render(); }
    function finishTutorial() {
        localStorage.setItem('beidou_player', JSON.stringify({
            name: state.name, mainSubject: state.subject, exp: state.exp, coins: state.coins,
            level: 1, titles: ['æ–°æ‰‹æ‘ç•¢æ¥­ç”Ÿ'], tutorialDone: true, createdAt: new Date().toISOString()
        }));
        localStorage.setItem('beidou_tutorial_done', 'true');
        window.location.href = 'index.html';
    }

    init();
    </script>
</body>
</html>
