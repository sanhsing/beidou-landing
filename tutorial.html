<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | æ–°æ‰‹æ‘å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow { box-shadow: 0 0 30px rgba(139, 92, 246, 0.3); }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .bounce-in { animation: bounceIn 0.6s ease-out; }
        @keyframes bounceIn { 0%{opacity:0;transform:scale(0.3)} 50%{transform:scale(1.05)} 100%{opacity:1;transform:scale(1)} }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0%,100%{box-shadow:0 0 20px rgba(139,92,246,0.4)} 50%{box-shadow:0 0 40px rgba(139,92,246,0.8)} }
        .progress-bar { transition: width 0.5s ease-out; }
        .monster-sprite { font-size: 4rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .hp-bar { transition: width 0.3s ease-out; }
        .damage-text { animation: damageFloat 1s ease-out forwards; }
        @keyframes damageFloat { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-50px)} }
        .reward-pop { animation: rewardPop 0.5s ease-out; }
        @keyframes rewardPop { 0%{transform:scale(0)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        .confetti { position: fixed; pointer-events: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- é ‚éƒ¨é€²åº¦ -->
    <div class="fixed top-0 left-0 right-0 z-50 bg-black/50 backdrop-blur">
        <div class="max-w-4xl mx-auto px-4 py-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒŸ</span>
                <span class="font-bold">æ–°æ‰‹æ‘</span>
            </div>
            <div class="flex-1 mx-4">
                <div class="bg-white/10 rounded-full h-2">
                    <div id="totalProgress" class="progress-bar bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="text-sm text-gray-400">
                <span id="stepLabel">1/7</span>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="pt-16 pb-8 px-4 max-w-2xl mx-auto min-h-screen flex flex-col">
        
        <!-- æ­¥é©Ÿ 1: æ­¡è¿ -->
        <div id="step1" class="step flex-1 flex flex-col items-center justify-center text-center">
            <div class="bounce-in">
                <div class="text-8xl mb-6">ğŸŒŸ</div>
                <h1 class="text-3xl font-bold mb-4">æ­¡è¿ä¾†åˆ°åŒ—æ–—æ•™è‚²</h1>
                <p class="text-gray-400 mb-8 max-w-md">
                    åœ¨é€™è£¡ï¼Œå­¸ç¿’ä¸å†æ¯ç‡¥ç„¡èŠ<br>
                    æ‰“æ€ªå‡ç´šï¼Œé †ä¾¿è€ƒä¸Šç†æƒ³å­¸æ ¡ï¼
                </p>
                <button onclick="nextStep()" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold text-lg hover:scale-105 transition pulse-glow">
                    é–‹å§‹å†’éšª â†’
                </button>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 2: é¸æ“‡ç§‘ç›® -->
        <div id="step2" class="step hidden flex-1 flex flex-col">
            <div class="slide-up">
                <h2 class="text-2xl font-bold text-center mb-2">é¸æ“‡ä½ çš„ä¸»ä¿®ç§‘ç›®</h2>
                <p class="text-gray-400 text-center mb-6">å…ˆé¸ä¸€ç§‘é–‹å§‹ï¼Œä¹‹å¾Œå¯ä»¥éš¨æ™‚æ›´æ›</p>
                
                <div class="grid grid-cols-2 gap-3" id="subjectGrid">
                    <!-- ç§‘ç›®æŒ‰éˆ•å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div id="subjectConfirm" class="hidden mt-6 text-center">
                    <p class="text-lg mb-4">ä½ é¸æ“‡äº† <span id="selectedSubjectName" class="text-purple-400 font-bold"></span></p>
                    <button onclick="confirmSubject()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold hover:scale-105 transition">
                        ç¢ºèªé¸æ“‡ â†’
                    </button>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 3: ä»‹ç´¹æˆ°é¬¥ -->
        <div id="step3" class="step hidden flex-1 flex flex-col items-center justify-center">
            <div class="slide-up text-center">
                <div class="text-6xl mb-4">âš”ï¸</div>
                <h2 class="text-2xl font-bold mb-4">æˆ°é¬¥ç³»çµ±ä»‹ç´¹</h2>
                <div class="glass rounded-xl p-6 mb-6 text-left max-w-md">
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">1ï¸âƒ£</span>
                            <div>
                                <p class="font-bold">é‡åˆ°æ€ªç¸</p>
                                <p class="text-gray-400 text-sm">æ¯éš»æ€ªç¸å°æ‡‰ä¸€å€‹çŸ¥è­˜é»</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">2ï¸âƒ£</span>
                            <div>
                                <p class="font-bold">å›ç­”é¡Œç›®</p>
                                <p class="text-gray-400 text-sm">ç­”å°æ”»æ“Šæ€ªç¸ï¼Œç­”éŒ¯å—åˆ°å‚·å®³</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">3ï¸âƒ£</span>
                            <div>
                                <p class="font-bold">ç²å¾—çå‹µ</p>
                                <p class="text-gray-400 text-sm">æ“Šæ•—æ€ªç¸ç²å¾—ç¶“é©—å€¼å’Œé‡‘å¹£</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="nextStep()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold hover:scale-105 transition">
                    æˆ‘æ‡‚äº†ï¼Œé–‹æˆ°ï¼ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 4: ç¬¬ä¸€å ´æˆ°é¬¥ -->
        <div id="step4" class="step hidden flex-1 flex flex-col">
            <div class="slide-up flex-1 flex flex-col">
                <!-- æ€ªç¸å€ -->
                <div class="glass rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span id="monster1Emoji" class="text-3xl">ğŸ‘¾</span>
                            <div>
                                <p id="monster1Name" class="font-bold">æ–°æ‰‹å°æ€ª</p>
                                <p class="text-xs text-gray-400">Lv.1 æ–°æ‰‹æ‘</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">HP</p>
                            <p id="monster1HpText" class="font-bold text-green-400">100/100</p>
                        </div>
                    </div>
                    <div class="bg-black/30 rounded-full h-3 overflow-hidden">
                        <div id="monster1HpBar" class="hp-bar bg-gradient-to-r from-green-500 to-green-400 h-full" style="width: 100%"></div>
                    </div>
                    <div id="damageContainer" class="relative h-8"></div>
                </div>

                <!-- é¡Œç›®å€ -->
                <div class="glass rounded-xl p-4 flex-1 flex flex-col">
                    <p class="text-xs text-purple-400 mb-2">ğŸ’¡ æ–°æ‰‹é¡Œç›®</p>
                    <p id="question1" class="text-lg mb-4 flex-1">è¼‰å…¥ä¸­...</p>
                    <div id="options1" class="space-y-2">
                        <!-- é¸é …å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç©å®¶ç‹€æ…‹ -->
                <div class="glass rounded-xl p-3 mt-4 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ§™</span>
                        <div>
                            <p class="font-bold text-sm">å†’éšªè€…</p>
                            <p class="text-xs text-gray-400">Lv.1</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <p class="text-xs text-gray-400">ç¶“é©—</p>
                            <p id="playerExp" class="font-bold text-purple-400">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-400">é‡‘å¹£</p>
                            <p id="playerCoins" class="font-bold text-yellow-400">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 5: å‹åˆ© + ç¬¬äºŒé¡Œ -->
        <div id="step5" class="step hidden flex-1 flex flex-col items-center justify-center">
            <div class="slide-up text-center">
                <div class="text-6xl mb-4 reward-pop">ğŸ‰</div>
                <h2 class="text-2xl font-bold mb-2">æ“Šæ•—äº†æ€ªç¸ï¼</h2>
                <div class="glass rounded-xl p-4 mb-6 inline-block">
                    <p class="text-gray-400 mb-2">ç²å¾—çå‹µï¼š</p>
                    <div class="flex gap-6 justify-center">
                        <div>
                            <p class="text-2xl font-bold text-purple-400">+50</p>
                            <p class="text-xs text-gray-400">ç¶“é©—å€¼</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-yellow-400">+10</p>
                            <p class="text-xs text-gray-400">é‡‘å¹£</p>
                        </div>
                    </div>
                </div>
                <p class="text-gray-400 mb-4">ç¹¼çºŒæŒ‘æˆ°ä¸‹ä¸€éš»æ€ªç¸ï¼Ÿ</p>
                <button onclick="startBattle2()" class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold hover:scale-105 transition">
                    ç¹¼çºŒæˆ°é¬¥ï¼ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 6: å‡ç´š + Boss é å‘Š -->
        <div id="step6" class="step hidden flex-1 flex flex-col items-center justify-center">
            <div class="slide-up text-center">
                <div class="text-6xl mb-4">â¬†ï¸</div>
                <h2 class="text-3xl font-bold mb-2 text-yellow-400">å‡ç´šäº†ï¼</h2>
                <p class="text-xl mb-6">Lv.1 â†’ Lv.2</p>
                
                <div class="glass rounded-xl p-4 mb-6">
                    <p class="text-gray-400 mb-2">è§£é–åŠŸèƒ½ï¼š</p>
                    <div class="space-y-2 text-left">
                        <div class="flex items-center gap-2">
                            <span>âœ…</span>
                            <span>éŒ¯é¡Œæœ¬</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>âœ…</span>
                            <span>æ¯æ—¥ä»»å‹™</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-500">
                            <span>ğŸ”’</span>
                            <span>PvP å°æˆ° (Lv.5)</span>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-xl p-4 mb-6 border border-red-500/30">
                    <p class="text-red-400 mb-2">âš ï¸ æ–°æ‰‹æ‘ Boss å‡ºç¾ï¼</p>
                    <div class="text-4xl mb-2">ğŸ‘‘ğŸ²</div>
                    <p class="font-bold">ç« ç¯€å®ˆè­·è€…</p>
                    <p class="text-xs text-gray-400">æ“Šæ•—ä»–æ‰èƒ½é›¢é–‹æ–°æ‰‹æ‘</p>
                </div>

                <button onclick="startBossBattle()" class="px-8 py-3 bg-gradient-to-r from-red-600 to-orange-600 rounded-xl font-bold hover:scale-105 transition">
                    æŒ‘æˆ° Bossï¼ â†’
                </button>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 7: é€šé—œ + è¨»å†Šæç¤º -->
        <div id="step7" class="step hidden flex-1 flex flex-col items-center justify-center">
            <div class="bounce-in text-center">
                <div class="text-8xl mb-4">ğŸ†</div>
                <h2 class="text-3xl font-bold mb-2">æ­å–œé€šé—œæ–°æ‰‹æ‘ï¼</h2>
                <p class="text-gray-400 mb-6">ä½ å·²ç¶“æŒæ¡äº†åŸºæœ¬ç©æ³•</p>
                
                <div class="glass rounded-xl p-6 mb-6">
                    <p class="text-lg mb-4">ä½ çš„æˆ°ç¸¾ï¼š</p>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-2xl font-bold text-purple-400" id="finalExp">150</p>
                            <p class="text-xs text-gray-400">ç¶“é©—å€¼</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-yellow-400" id="finalCoins">50</p>
                            <p class="text-xs text-gray-400">é‡‘å¹£</p>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-green-400">Lv.2</p>
                            <p class="text-xs text-gray-400">ç­‰ç´š</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-center gap-2 text-yellow-400">
                        <span>ğŸ…</span>
                        <span class="font-bold">ç²å¾—ç¨±è™Ÿï¼šã€Œå†’éšªæ–°æ˜Ÿã€</span>
                    </div>
                </div>

                <div class="glass rounded-xl p-6 mb-6 border border-purple-500/50">
                    <p class="text-lg font-bold mb-2">ğŸ’¾ å„²å­˜ä½ çš„é€²åº¦ï¼Ÿ</p>
                    <p class="text-gray-400 text-sm mb-4">è¨»å†Šå¾Œå¯è·¨è£ç½®åŒæ­¥ã€åƒåŠ æ’è¡Œæ¦œ</p>
                    
                    <div class="space-y-3">
                        <button onclick="goToRegister()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold hover:scale-105 transition">
                            ğŸ“§ Email è¨»å†Šï¼ˆ10ç§’ï¼‰
                        </button>
                        <button onclick="googleLogin()" class="w-full px-6 py-3 bg-white/10 rounded-xl font-bold hover:bg-white/20 transition flex items-center justify-center gap-2">
                            <img src="https://www.google.com/favicon.ico" class="w-5 h-5"> Google å¿«é€Ÿç™»å…¥
                        </button>
                        <button onclick="continueTrial()" class="w-full px-6 py-3 text-gray-400 hover:text-white transition text-sm">
                            ç¨å¾Œå†èªªï¼Œç¹¼çºŒè©¦ç© â†’
                        </button>
                    </div>
                </div>

                <p class="text-xs text-gray-500">
                    âš ï¸ ä¸è¨»å†Šçš„è©±ï¼Œæ›è£ç½®æœƒéºå¤±é€²åº¦å–”
                </p>
            </div>
        </div>

    </div>

    <script>
        // ========== å…¨åŸŸç‹€æ…‹ ==========
        let currentStep = 1;
        let selectedSubject = null;
        let playerExp = 0;
        let playerCoins = 0;
        let playerLevel = 1;
        
        // ç§‘ç›®é…ç½®
        const subjects = [
            { id: 'math', name: 'æ•¸å­¸', emoji: 'ğŸ“', color: 'from-blue-500 to-cyan-500' },
            { id: 'chinese', name: 'åœ‹æ–‡', emoji: 'ğŸ“š', color: 'from-red-500 to-pink-500' },
            { id: 'english', name: 'è‹±æ–‡', emoji: 'ğŸ”¤', color: 'from-green-500 to-teal-500' },
            { id: 'physics', name: 'ç‰©ç†', emoji: 'âš¡', color: 'from-yellow-500 to-orange-500' },
            { id: 'chemistry', name: 'åŒ–å­¸', emoji: 'ğŸ§ª', color: 'from-purple-500 to-pink-500' },
            { id: 'biology', name: 'ç”Ÿç‰©', emoji: 'ğŸ§¬', color: 'from-green-500 to-lime-500' },
            { id: 'history', name: 'æ­·å²', emoji: 'ğŸ›ï¸', color: 'from-amber-500 to-yellow-500' },
            { id: 'geography', name: 'åœ°ç†', emoji: 'ğŸŒ', color: 'from-blue-500 to-green-500' },
            { id: 'civics', name: 'å…¬æ°‘', emoji: 'âš–ï¸', color: 'from-indigo-500 to-purple-500' },
            { id: 'earth', name: 'åœ°ç§‘', emoji: 'ğŸŒ', color: 'from-teal-500 to-cyan-500' },
        ];

        // æ–°æ‰‹é¡Œç›®åº« (ç°¡å–®é¡Œç›®)
        const tutorialQuestions = {
            math: [
                { q: '2 + 3 = ?', options: ['4', '5', '6', '7'], answer: 1 },
                { q: '10 - 4 = ?', options: ['5', '6', '7', '8'], answer: 1 },
            ],
            chinese: [
                { q: 'ã€Œé’å‡ºæ–¼è—ã€çš„ä¸‹ä¸€å¥æ˜¯ï¼Ÿ', options: ['è€Œå‹æ–¼è—', 'æ›´å‹æ–¼è—', 'è¶…è¶Šæ–¼è—', 'é«˜æ–¼è—'], answer: 0 },
                { q: 'ã€Œä¸€æ—¥ä¸è¦‹ã€ä¸‹ä¸€å¥æ˜¯ï¼Ÿ', options: ['å¦‚éš”ä¸‰ç§‹', 'å¦‚éš”ä¸‰å¹´', 'æ€å¿µè¬åˆ†', 'é­‚ç‰½å¤¢ç¸ˆ'], answer: 0 },
            ],
            english: [
                { q: 'Apple çš„ä¸­æ–‡æ˜¯ï¼Ÿ', options: ['è˜‹æœ', 'é¦™è•‰', 'æ©˜å­', 'è¥¿ç“œ'], answer: 0 },
                { q: '"Hello" æ˜¯ä»€éº¼æ„æ€ï¼Ÿ', options: ['å†è¦‹', 'ä½ å¥½', 'è¬è¬', 'å°ä¸èµ·'], answer: 1 },
            ],
            physics: [
                { q: 'ç‰›é “ç¬¬ä¸€é‹å‹•å®šå¾‹åˆç¨±ï¼Ÿ', options: ['æ…£æ€§å®šå¾‹', 'åŠ é€Ÿåº¦å®šå¾‹', 'ä½œç”¨åŠ›å®šå¾‹', 'é‡åŠ›å®šå¾‹'], answer: 0 },
                { q: 'å…‰é€Ÿç´„ç‚ºï¼Ÿ', options: ['3å„„ m/s', '3è¬ m/s', '30è¬ m/s', '300è¬ m/s'], answer: 0 },
            ],
            chemistry: [
                { q: 'æ°´çš„åŒ–å­¸å¼æ˜¯ï¼Ÿ', options: ['H2O', 'CO2', 'NaCl', 'O2'], answer: 0 },
                { q: 'æ°§æ°£çš„åŒ–å­¸ç¬¦è™Ÿæ˜¯ï¼Ÿ', options: ['O', 'O2', 'H', 'N'], answer: 1 },
            ],
            biology: [
                { q: 'äººé«”æœ€å¤§çš„å™¨å®˜æ˜¯ï¼Ÿ', options: ['å¿ƒè‡Ÿ', 'è‚è‡Ÿ', 'çš®è†š', 'å¤§è…¦'], answer: 2 },
                { q: 'æ¤ç‰©è¡Œå…‰åˆä½œç”¨ç”¢ç”Ÿï¼Ÿ', options: ['äºŒæ°§åŒ–ç¢³', 'æ°§æ°£', 'æ°®æ°£', 'æ°«æ°£'], answer: 1 },
            ],
            history: [
                { q: 'ä¸­è¯æ°‘åœ‹æˆç«‹æ–¼å“ªä¸€å¹´ï¼Ÿ', options: ['1911', '1912', '1949', '1945'], answer: 1 },
                { q: 'å°ç£å…‰å¾©ç¯€æ˜¯å“ªä¸€å¤©ï¼Ÿ', options: ['10/10', '10/25', '2/28', '7/7'], answer: 1 },
            ],
            geography: [
                { q: 'å°ç£æœ€é«˜å³°æ˜¯ï¼Ÿ', options: ['é˜¿é‡Œå±±', 'ç‰å±±', 'é›ªå±±', 'åˆæ­¡å±±'], answer: 1 },
                { q: 'ä¸–ç•Œæœ€å¤§çš„æµ·æ´‹æ˜¯ï¼Ÿ', options: ['å¤§è¥¿æ´‹', 'å°åº¦æ´‹', 'å¤ªå¹³æ´‹', 'åŒ—å†°æ´‹'], answer: 2 },
            ],
            civics: [
                { q: 'ä¸­è¯æ°‘åœ‹æ†²æ³•ç¬¬ä¸€æ¢ï¼šä¸­è¯æ°‘åœ‹åŸºæ–¼ï¼Ÿ', options: ['ä¸‰æ°‘ä¸»ç¾©', 'äº”æ¬Šåˆ†ç«‹', 'æ°‘ä¸»å…±å’Œ', 'è‡ªç”±å¹³ç­‰'], answer: 0 },
                { q: 'å°ç£çš„ç«‹æ³•æ©Ÿé—œæ˜¯ï¼Ÿ', options: ['è¡Œæ”¿é™¢', 'ç«‹æ³•é™¢', 'å¸æ³•é™¢', 'ç›£å¯Ÿé™¢'], answer: 1 },
            ],
            earth: [
                { q: 'åœ°çƒè‡ªè½‰ä¸€åœˆç´„éœ€ï¼Ÿ', options: ['12å°æ™‚', '24å°æ™‚', '7å¤©', '365å¤©'], answer: 1 },
                { q: 'é€ æˆå››å­£è®ŠåŒ–çš„ä¸»å› æ˜¯ï¼Ÿ', options: ['åœ°çƒå…¬è½‰', 'åœ°è»¸å‚¾æ–œ', 'æ—¥åœ°è·é›¢', 'æœˆçƒå¼•åŠ›'], answer: 1 },
            ],
        };

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            initSubjectGrid();
            updateProgress();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æš«å­˜é€²åº¦
            const saved = localStorage.getItem('beidou_tutorial_progress');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.completed) {
                    // å·²å®Œæˆæ–°æ‰‹æ‘ï¼Œè·³è½‰
                    window.location.href = 'dashboard.html';
                }
            }
        });

        // ========== æ­¥é©Ÿæ§åˆ¶ ==========
        function nextStep() {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.remove('hidden');
            updateProgress();
            saveProgress();
        }

        function goToStep(step) {
            document.getElementById(`step${currentStep}`).classList.add('hidden');
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.remove('hidden');
            updateProgress();
        }

        function updateProgress() {
            const progress = ((currentStep - 1) / 6) * 100;
            document.getElementById('totalProgress').style.width = `${progress}%`;
            document.getElementById('stepLabel').textContent = `${currentStep}/7`;
        }

        // ========== ç§‘ç›®é¸æ“‡ ==========
        function initSubjectGrid() {
            const grid = document.getElementById('subjectGrid');
            grid.innerHTML = subjects.map(s => `
                <button onclick="selectSubject('${s.id}', '${s.name}')" 
                    id="subject_${s.id}"
                    class="glass p-4 rounded-xl text-center hover:scale-105 transition border-2 border-transparent">
                    <div class="text-3xl mb-1">${s.emoji}</div>
                    <div class="font-bold">${s.name}</div>
                </button>
            `).join('');
        }

        function selectSubject(id, name) {
            selectedSubject = id;
            // æ¸…é™¤å…¶ä»–é¸ä¸­
            subjects.forEach(s => {
                document.getElementById(`subject_${s.id}`).classList.remove('border-purple-500', 'glow');
            });
            // é¸ä¸­ç•¶å‰
            document.getElementById(`subject_${id}`).classList.add('border-purple-500', 'glow');
            // é¡¯ç¤ºç¢ºèª
            document.getElementById('selectedSubjectName').textContent = name;
            document.getElementById('subjectConfirm').classList.remove('hidden');
        }

        function confirmSubject() {
            if (!selectedSubject) return;
            localStorage.setItem('beidou_selected_subject', selectedSubject);
            nextStep();
        }

        // ========== æˆ°é¬¥ç³»çµ± ==========
        let currentQuestion = 0;
        let monsterHp = 100;
        let maxMonsterHp = 100;

        function loadQuestion(questionIndex) {
            const questions = tutorialQuestions[selectedSubject] || tutorialQuestions.math;
            const q = questions[questionIndex % questions.length];
            
            document.getElementById('question1').textContent = q.q;
            
            const optionsDiv = document.getElementById('options1');
            optionsDiv.innerHTML = q.options.map((opt, i) => `
                <button onclick="answerQuestion(${i}, ${q.answer})" 
                    class="w-full glass p-3 rounded-lg text-left hover:bg-white/10 transition flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-sm">${String.fromCharCode(65+i)}</span>
                    <span>${opt}</span>
                </button>
            `).join('');
        }

        function answerQuestion(selected, correct) {
            const buttons = document.querySelectorAll('#options1 button');
            buttons.forEach(b => b.disabled = true);
            
            if (selected === correct) {
                // ç­”å°
                buttons[selected].classList.add('bg-green-500/30', 'border', 'border-green-500');
                attackMonster(30);
            } else {
                // ç­”éŒ¯
                buttons[selected].classList.add('bg-red-500/30', 'border', 'border-red-500');
                buttons[correct].classList.add('bg-green-500/30', 'border', 'border-green-500');
                showDamage('-10 HP', 'red');
            }
            
            setTimeout(() => {
                if (monsterHp <= 0) {
                    // æ€ªç¸æ­»äº¡
                    playerExp += 50;
                    playerCoins += 10;
                    updatePlayerStats();
                    
                    if (currentStep === 4) {
                        nextStep(); // é€²å…¥å‹åˆ©ç•«é¢
                    }
                } else {
                    // ç¹¼çºŒä¸‹ä¸€é¡Œ
                    currentQuestion++;
                    loadQuestion(currentQuestion);
                }
            }, 1000);
        }

        function attackMonster(damage) {
            monsterHp = Math.max(0, monsterHp - damage);
            const percent = (monsterHp / maxMonsterHp) * 100;
            
            document.getElementById('monster1HpBar').style.width = `${percent}%`;
            document.getElementById('monster1HpText').textContent = `${monsterHp}/${maxMonsterHp}`;
            
            // è®Šè‰²
            if (percent < 30) {
                document.getElementById('monster1HpBar').classList.remove('from-green-500', 'to-green-400', 'from-yellow-500', 'to-yellow-400');
                document.getElementById('monster1HpBar').classList.add('from-red-500', 'to-red-400');
            } else if (percent < 60) {
                document.getElementById('monster1HpBar').classList.remove('from-green-500', 'to-green-400');
                document.getElementById('monster1HpBar').classList.add('from-yellow-500', 'to-yellow-400');
            }
            
            showDamage(`-${damage}`, 'yellow');
        }

        function showDamage(text, color) {
            const container = document.getElementById('damageContainer');
            const el = document.createElement('div');
            el.className = `damage-text absolute left-1/2 transform -translate-x-1/2 font-bold text-xl text-${color}-400`;
            el.textContent = text;
            container.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updatePlayerStats() {
            document.getElementById('playerExp').textContent = playerExp;
            document.getElementById('playerCoins').textContent = playerCoins;
        }

        // Step 4 åˆå§‹åŒ–
        document.getElementById('step4').addEventListener('transitionend', () => {
            if (!document.getElementById('step4').classList.contains('hidden')) {
                // åˆå§‹åŒ–ç¬¬ä¸€å ´æˆ°é¬¥
                const subjectConfig = subjects.find(s => s.id === selectedSubject);
                document.getElementById('monster1Emoji').textContent = subjectConfig?.emoji || 'ğŸ‘¾';
                document.getElementById('monster1Name').textContent = `${subjectConfig?.name || 'çŸ¥è­˜'}å°ç²¾éˆ`;
                loadQuestion(0);
            }
        });

        // ç¬¬äºŒå ´æˆ°é¬¥
        function startBattle2() {
            monsterHp = 100;
            maxMonsterHp = 100;
            currentQuestion = 1;
            
            goToStep(4);
            
            // æ›´æ–°æ€ªç¸
            setTimeout(() => {
                document.getElementById('monster1HpBar').style.width = '100%';
                document.getElementById('monster1HpBar').classList.remove('from-red-500', 'to-red-400', 'from-yellow-500', 'to-yellow-400');
                document.getElementById('monster1HpBar').classList.add('from-green-500', 'to-green-400');
                document.getElementById('monster1HpText').textContent = '100/100';
                document.getElementById('monster1Name').textContent = `${subjects.find(s => s.id === selectedSubject)?.name || 'çŸ¥è­˜'}æ€ªç¸`;
                loadQuestion(currentQuestion);
            }, 100);
        }

        // Boss æˆ°
        function startBossBattle() {
            // æ¨¡æ“¬ Boss æˆ°å‹åˆ©
            playerExp += 100;
            playerCoins += 30;
            playerLevel = 2;
            
            document.getElementById('finalExp').textContent = playerExp;
            document.getElementById('finalCoins').textContent = playerCoins;
            
            goToStep(7);
            createConfetti();
        }

        // ========== å®Œæˆ ==========
        function goToRegister() {
            saveProgress();
            localStorage.setItem('beidou_tutorial_completed', 'true');
            localStorage.setItem('beidou_tutorial_data', JSON.stringify({
                exp: playerExp,
                coins: playerCoins,
                level: playerLevel,
                subject: selectedSubject
            }));
            window.location.href = 'auth.html?mode=register&from=tutorial';
        }

        function googleLogin() {
            saveProgress();
            // TODO: å¯¦ä½œ Google OAuth
            alert('Google ç™»å…¥åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆä½¿ç”¨ Email è¨»å†Š');
        }

        function continueTrial() {
            saveProgress();
            localStorage.setItem('beidou_tutorial_completed', 'true');
            localStorage.setItem('beidou_guest_mode', 'true');
            window.location.href = 'dashboard.html?guest=true';
        }

        function saveProgress() {
            localStorage.setItem('beidou_tutorial_progress', JSON.stringify({
                step: currentStep,
                subject: selectedSubject,
                exp: playerExp,
                coins: playerCoins,
                level: playerLevel,
                timestamp: Date.now()
            }));
        }

        // ========== ç‰¹æ•ˆ ==========
        function createConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.cssText = `
                    position: fixed;
                    width: 10px;
                    height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: ${Math.random() * 100}vw;
                    top: -10px;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    animation: fall ${2 + Math.random() * 2}s linear forwards;
                `;
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 4000);
            }
            
            // æ·»åŠ æ‰è½å‹•ç•«
            if (!document.getElementById('confetti-style')) {
                const style = document.createElement('style');
                style.id = 'confetti-style';
                style.textContent = `
                    @keyframes fall {
                        to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Step 3 çµæŸå¾Œè‡ªå‹•é€²å…¥ Step 4
        const step3Btn = document.querySelector('#step3 button');
        if (step3Btn) {
            step3Btn.addEventListener('click', () => {
                setTimeout(() => {
                    const subjectConfig = subjects.find(s => s.id === selectedSubject);
                    document.getElementById('monster1Emoji').textContent = subjectConfig?.emoji || 'ğŸ‘¾';
                    document.getElementById('monster1Name').textContent = `${subjectConfig?.name || 'çŸ¥è­˜'}å°ç²¾éˆ`;
                    monsterHp = 100;
                    loadQuestion(0);
                }, 100);
            });
        }
    </script>
</body>
</html>
