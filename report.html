<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | å­¸ç¿’å ±å‘Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0VB6K9G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8X0VB6K9G7');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @media print {
            .no-print { display: none; }
            body { background: white; color: black; }
            .card { background: #f3f4f6; border: 1px solid #e5e7eb; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- å°èˆªåˆ— -->
    <nav class="border-b border-white/10 px-6 py-4 no-print">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒŸ</span>
                <span class="font-bold text-xl">åŒ—æ–—æ•™è‚²</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="text-gray-400 hover:text-white transition">å„€è¡¨æ¿</a>
                <button onclick="window.print()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">
                    ğŸ–¨ï¸ åˆ—å°å ±å‘Š
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-6 py-8">
        <!-- å ±å‘Šæ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">ğŸ“Š å­¸ç¿’å ±å‘Š</h1>
            <p class="text-gray-400" id="reportPeriod">è¼‰å…¥ä¸­...</p>
        </div>
        
        <!-- æ™‚é–“ç¯„åœé¸æ“‡ -->
        <div class="flex justify-center gap-2 mb-8 no-print">
            <button onclick="setPeriod('week')" id="periodWeek"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-purple-600">
                æœ¬é€±
            </button>
            <button onclick="setPeriod('month')" id="periodMonth"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-white/10 text-gray-400">
                æœ¬æœˆ
            </button>
            <button onclick="setPeriod('all')" id="periodAll"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-white/10 text-gray-400">
                å…¨éƒ¨
            </button>
        </div>
        
        <!-- ç¸½è¦½å¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="card rounded-xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ“</div>
                <div id="statTotal" class="text-2xl font-bold text-blue-400">0</div>
                <div class="text-gray-400 text-sm">ç¸½ç­”é¡Œæ•¸</div>
            </div>
            <div class="card rounded-xl p-5 text-center">
                <div class="text-3xl mb-2">âœ…</div>
                <div id="statCorrect" class="text-2xl font-bold text-green-400">0</div>
                <div class="text-gray-400 text-sm">ç­”å°é¡Œæ•¸</div>
            </div>
            <div class="card rounded-xl p-5 text-center">
                <div class="text-3xl mb-2">ğŸ¯</div>
                <div id="statAccuracy" class="text-2xl font-bold text-purple-400">0%</div>
                <div class="text-gray-400 text-sm">æ­£ç¢ºç‡</div>
            </div>
            <div class="card rounded-xl p-5 text-center">
                <div class="text-3xl mb-2">â±ï¸</div>
                <div id="statTime" class="text-2xl font-bold text-orange-400">0</div>
                <div class="text-gray-400 text-sm">å­¸ç¿’æ™‚é–“ (åˆ†)</div>
            </div>
        </div>
        
        <!-- åœ–è¡¨å€ -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- æ¯æ—¥è¶¨å‹¢ -->
            <div class="card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ æ¯æ—¥ç­”é¡Œè¶¨å‹¢</h3>
                <canvas id="dailyChart" height="200"></canvas>
            </div>
            
            <!-- ç§‘ç›®æ­£ç¢ºç‡ -->
            <div class="card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“Š å„ç§‘æ­£ç¢ºç‡</h3>
                <canvas id="subjectChart" height="200"></canvas>
            </div>
        </div>
        
        <!-- ç§‘ç›®è©³æƒ… -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">ğŸ“š å„ç§‘ç›®è¡¨ç¾</h3>
            <div id="subjectDetails" class="space-y-4">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
        
        <!-- å­¸ç¿’å»ºè­° -->
        <div class="card rounded-xl p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4">ğŸ’¡ å­¸ç¿’å»ºè­°</h3>
            <div id="suggestions" class="space-y-3">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
        
        <!-- æˆå°±æ‘˜è¦ -->
        <div class="card rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ† æœ¬æœŸæˆå°±</h3>
            <div id="achievements" class="flex flex-wrap gap-3">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </main>
    
    <!-- é å°¾ -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        åŒ—æ–—æ•™è‚² Â© 2025 | å ±å‘Šç”¢ç”Ÿæ™‚é–“ï¼š<span id="generateTime"></span>
    </footer>

    <script>
        const API_BASE = 'https://beidou-edu-server-1.onrender.com/api';
        let currentPeriod = 'week';
        let reportData = null;
        let dailyChart = null;
        let subjectChart = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('beidou_token');
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }
            
            document.getElementById('generateTime').textContent = 
                new Date().toLocaleString('zh-TW');
            
            loadReport();
            
            gtag('event', 'page_view', {
                'event_category': 'report'
            });
        });
        
        // è¨­å®šæ™‚é–“ç¯„åœ
        function setPeriod(period) {
            currentPeriod = period;
            
            ['week', 'month', 'all'].forEach(p => {
                const btn = document.getElementById(`period${p.charAt(0).toUpperCase() + p.slice(1)}`);
                if (p === period) {
                    btn.classList.remove('bg-white/10', 'text-gray-400');
                    btn.classList.add('bg-purple-600');
                } else {
                    btn.classList.add('bg-white/10', 'text-gray-400');
                    btn.classList.remove('bg-purple-600');
                }
            });
            
            loadReport();
            
            gtag('event', 'change_period', {
                'event_category': 'report',
                'event_label': period
            });
        }
        
        // è¼‰å…¥å ±å‘Š
        async function loadReport() {
            const token = localStorage.getItem('beidou_token');
            
            let days = 7;
            let periodText = 'æœ¬é€±';
            if (currentPeriod === 'month') {
                days = 30;
                periodText = 'æœ¬æœˆ';
            } else if (currentPeriod === 'all') {
                days = 365;
                periodText = 'å…¨éƒ¨æ™‚é–“';
            }
            
            document.getElementById('reportPeriod').textContent = periodText;
            
            try {
                const res = await fetch(`${API_BASE}/user/stats?days=${days}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success) {
                    reportData = data.data;
                    renderReport();
                } else {
                    throw new Error('è¼‰å…¥å¤±æ•—');
                }
            } catch (err) {
                console.error('è¼‰å…¥å ±å‘Šå¤±æ•—:', err);
                useMockData();
            }
        }
        
        // æ¨¡æ“¬è³‡æ–™
        function useMockData() {
            reportData = {
                daily: Array.from({length: 7}, (_, i) => {
                    const date = new Date(Date.now() - (6-i) * 86400000);
                    return {
                        date: date.toISOString().split('T')[0],
                        totalQuestions: Math.floor(Math.random() * 30) + 5,
                        correctCount: Math.floor(Math.random() * 25) + 3,
                        totalTime: Math.floor(Math.random() * 60) + 10
                    };
                }),
                subjects: [
                    { _id: 'æ•¸å­¸', total: 45, correct: 38 },
                    { _id: 'ç‰©ç†', total: 32, correct: 26 },
                    { _id: 'åŒ–å­¸', total: 28, correct: 21 },
                    { _id: 'ç”Ÿç‰©', total: 20, correct: 17 },
                    { _id: 'è‹±æ–‡', total: 35, correct: 30 }
                ]
            };
            renderReport();
        }
        
        // æ¸²æŸ“å ±å‘Š
        function renderReport() {
            const { daily, subjects } = reportData;
            
            // è¨ˆç®—ç¸½è¨ˆ
            const totalQuestions = daily.reduce((sum, d) => sum + d.totalQuestions, 0);
            const totalCorrect = daily.reduce((sum, d) => sum + d.correctCount, 0);
            const totalTime = daily.reduce((sum, d) => sum + (d.totalTime || 0), 0);
            const accuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            
            document.getElementById('statTotal').textContent = totalQuestions;
            document.getElementById('statCorrect').textContent = totalCorrect;
            document.getElementById('statAccuracy').textContent = `${accuracy}%`;
            document.getElementById('statTime').textContent = Math.round(totalTime / 60);
            
            renderDailyChart(daily);
            renderSubjectChart(subjects);
            renderSubjectDetails(subjects);
            renderSuggestions(subjects, accuracy);
        }
        
        // æ¯æ—¥è¶¨å‹¢åœ–
        function renderDailyChart(daily) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (dailyChart) dailyChart.destroy();
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: daily.map(d => d.date.slice(5)),
                    datasets: [
                        {
                            label: 'ç­”é¡Œæ•¸',
                            data: daily.map(d => d.totalQuestions),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'ç­”å°æ•¸',
                            data: daily.map(d => d.correctCount),
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // ç§‘ç›®æ­£ç¢ºç‡åœ–
        function renderSubjectChart(subjects) {
            const ctx = document.getElementById('subjectChart').getContext('2d');
            
            if (subjectChart) subjectChart.destroy();
            
            const labels = subjects.map(s => s._id);
            const accuracies = subjects.map(s => 
                s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0
            );
            
            subjectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'æ­£ç¢ºç‡ %',
                        data: accuracies,
                        backgroundColor: accuracies.map(a => 
                            a >= 80 ? '#10b981' : a >= 60 ? '#f59e0b' : '#ef4444'
                        ),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // ç§‘ç›®è©³æƒ…
        function renderSubjectDetails(subjects) {
            const html = subjects.map(s => {
                const acc = s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0;
                const color = acc >= 80 ? 'green' : acc >= 60 ? 'yellow' : 'red';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="w-3 h-3 rounded-full bg-${color}-500"></span>
                            <span class="font-medium">${s._id}</span>
                        </div>
                        <div class="flex items-center gap-6 text-sm">
                            <span class="text-gray-400">ç­”é¡Œ ${s.total}</span>
                            <span class="text-gray-400">ç­”å° ${s.correct}</span>
                            <span class="font-medium text-${color}-400">${acc}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('subjectDetails').innerHTML = html || 
                '<div class="text-gray-500 text-center">æš«ç„¡è³‡æ–™</div>';
        }
        
        // å­¸ç¿’å»ºè­°
        function renderSuggestions(subjects, overallAccuracy) {
            const suggestions = [];
            
            // æ‰¾å‡ºå¼±é …ç§‘ç›®
            const weakSubjects = subjects.filter(s => {
                const acc = s.total > 0 ? (s.correct / s.total) * 100 : 0;
                return s.total >= 5 && acc < 70;
            });
            
            if (weakSubjects.length > 0) {
                suggestions.push({
                    icon: 'ğŸ“š',
                    text: `å»ºè­°åŠ å¼· ${weakSubjects.map(s => s._id).join('ã€')}ï¼Œé€™äº›ç§‘ç›®æ­£ç¢ºç‡è¼ƒä½`
                });
            }
            
            // æ•´é«”å»ºè­°
            if (overallAccuracy >= 85) {
                suggestions.push({
                    icon: 'ğŸŒŸ',
                    text: 'è¡¨ç¾å„ªç§€ï¼å¯ä»¥æŒ‘æˆ°æ›´é«˜é›£åº¦çš„é¡Œç›®'
                });
            } else if (overallAccuracy >= 70) {
                suggestions.push({
                    icon: 'ğŸ’ª',
                    text: 'ç¹¼çºŒä¿æŒï¼Œå¤šç·´ç¿’éŒ¯é¡Œå¯ä»¥æ›´é€²æ­¥'
                });
            } else {
                suggestions.push({
                    icon: 'ğŸ¯',
                    text: 'å»ºè­°å…ˆéå›ºåŸºç¤æ¦‚å¿µï¼Œå–„ç”¨ XTF å­—å¡è¤‡ç¿’'
                });
            }
            
            // å­¸ç¿’ç¿’æ…£
            suggestions.push({
                icon: 'â°',
                text: 'æ¯å¤©å›ºå®šæ™‚é–“å­¸ç¿’ 30 åˆ†é˜ï¼Œæ•ˆæœæœ€ä½³'
            });
            
            document.getElementById('suggestions').innerHTML = suggestions.map(s => `
                <div class="flex items-start gap-3 p-3 bg-white/5 rounded-lg">
                    <span class="text-2xl">${s.icon}</span>
                    <span>${s.text}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
