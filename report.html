<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç¿’å ±å‘Š - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="js/components.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .chart-container { position: relative; height: 280px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="dashboard.html" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">
        <span>â†</span> è¿”å›å„€è¡¨æ¿
      </a>
      <h1 class="font-bold text-lg">ğŸ“Š å­¸ç¿’å ±å‘Š</h1>
      <button onclick="exportReport()" class="btn btn-primary text-sm">åŒ¯å‡º PDF</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- ç¸½è¦½å¡ç‰‡ -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“š</div>
        <div class="stat-content">
          <div class="stat-value" id="totalQuestions">0</div>
          <div class="stat-label">ç´¯è¨ˆç­”é¡Œ</div>
        </div>
      </div>
      <div class="stat-card success">
        <div class="stat-icon">âœ“</div>
        <div class="stat-content">
          <div class="stat-value" id="overallAccuracy">0%</div>
          <div class="stat-label">ç¸½æ­£ç¢ºç‡</div>
        </div>
      </div>
      <div class="stat-card warning">
        <div class="stat-icon">ğŸ“ˆ</div>
        <div class="stat-content">
          <div class="stat-value" id="avgMastery">0%</div>
          <div class="stat-label">å¹³å‡æŒæ¡åº¦</div>
        </div>
      </div>
      <div class="stat-card info">
        <div class="stat-icon">ğŸ¯</div>
        <div class="stat-content">
          <div class="stat-value" id="nodesStudied">0</div>
          <div class="stat-label">å·²å­¸ç¯€é»</div>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- 30å¤©è¶¨å‹¢ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“… 30å¤©å­¸ç¿’è¶¨å‹¢</h2>
        </div>
        <div class="chart-container">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <!-- ç§‘ç›®èƒ½åŠ›é›·é” -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ¯ ç§‘ç›®èƒ½åŠ›åˆ†æ</h2>
        </div>
        <div class="chart-container">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- å¼±é»ç§‘ç›® -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">âš ï¸ å¼±é»ç§‘ç›®</h2>
        </div>
        <div id="weakSubjects" class="space-y-3">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
      </div>

      <!-- å¼±é»ç¯€é» -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ“ éœ€åŠ å¼·çš„çŸ¥è­˜é»</h2>
        </div>
        <div id="weakNodes" class="space-y-3">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
      </div>
    </div>

    <!-- å­¸ç¿’å»ºè­° -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">ğŸ’¡ å­¸ç¿’å»ºè­°</h2>
      </div>
      <div id="recommendations" class="grid md:grid-cols-2 gap-4">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>
  </main>

  <script src="js/api.js"></script>
  <script src="js/charts.js"></script>
  <script>
    let charts = {};

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      await loadReport();
    }

    async function loadReport() {
      try {
        const [dashRes, trendRes, weakRes] = await Promise.all([
          BeidouAPI.analytics.dashboard(),
          BeidouAPI.analytics.trends(null, 30),
          BeidouAPI.analytics.weakness()
        ]);

        if (dashRes.success) renderOverview(dashRes.data);
        if (trendRes.success) renderTrends(trendRes.data);
        if (weakRes.success) renderWeakness(weakRes.data);

      } catch (error) {
        console.error('Load report error:', error);
      }
    }

    function renderOverview(data) {
      const { overview } = data;
      document.getElementById('totalQuestions').textContent = overview?.total_questions || 0;
      const acc = overview?.total_questions > 0 
        ? Math.round(overview.total_correct / overview.total_questions * 100) 
        : 0;
      document.getElementById('overallAccuracy').textContent = acc + '%';
      document.getElementById('avgMastery').textContent = Math.round(overview?.avg_mastery || 0) + '%';
      document.getElementById('nodesStudied').textContent = overview?.nodes_studied || 0;
    }

    function renderTrends(data) {
      const { dailyTrend, subjectTrend } = data;

      // 30å¤©è¶¨å‹¢
      if (dailyTrend && dailyTrend.length > 0) {
        const chartData = dailyTrend.map(d => ({
          date: d.date.slice(5),
          value: d.accuracy || 0
        }));
        charts.trend = BeidouCharts.trendLine('trendChart', chartData, { color: '#6366f1' });
      }

      // ç§‘ç›®é›·é”
      if (subjectTrend && subjectTrend.length > 0) {
        const radarData = subjectTrend.slice(0, 8).map(s => ({
          subject: s.subject_id,
          mastery: s.accuracy || 0
        }));
        charts.radar = BeidouCharts.radarChart('radarChart', radarData);
      }
    }

    function renderWeakness(data) {
      const { weakSubjects, weakNodes, recommendations } = data;

      // å¼±é»ç§‘ç›®
      const subjEl = document.getElementById('weakSubjects');
      if (weakSubjects && weakSubjects.length > 0) {
        subjEl.innerHTML = weakSubjects.map(s => `
          <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
            <div>
              <span class="font-medium">${s.subject_id}</span>
              <span class="text-sm text-gray-500 ml-2">${s.total} é¡Œ</span>
            </div>
            <span class="text-red-600 font-bold">${s.accuracy}%</span>
          </div>
        `).join('');
      } else {
        subjEl.innerHTML = '<div class="text-center text-gray-400 py-4">ğŸ‘ å„ç§‘è¡¨ç¾å‡è¡¡</div>';
      }

      // å¼±é»ç¯€é»
      const nodeEl = document.getElementById('weakNodes');
      if (weakNodes && weakNodes.length > 0) {
        nodeEl.innerHTML = weakNodes.slice(0, 5).map(n => `
          <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
            <div>
              <div class="font-medium">${n.node_name || n.node_id}</div>
              <div class="text-sm text-gray-500">${n.subject_id || ''}</div>
            </div>
            <div class="text-right">
              <div class="font-bold ${n.mastery_level < 50 ? 'text-red-600' : 'text-yellow-600'}">${n.mastery_level}%</div>
              <a href="quiz_v2.html?node=${n.node_id}" class="text-sm text-indigo-600">å»ç·´ç¿’ â†’</a>
            </div>
          </div>
        `).join('');
      } else {
        nodeEl.innerHTML = '<div class="text-center text-gray-400 py-4">ğŸ‘ æ²’æœ‰éœ€è¦åŠ å¼·çš„çŸ¥è­˜é»</div>';
      }

      // å­¸ç¿’å»ºè­°
      const recEl = document.getElementById('recommendations');
      if (recommendations && recommendations.length > 0) {
        recEl.innerHTML = recommendations.map(r => `
          <div class="p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-500">
            <div class="font-medium text-indigo-700 mb-1">${r.nodeName || r.nodeId}</div>
            <div class="text-sm text-gray-600">${r.reason}</div>
            <a href="quiz_v2.html?node=${r.nodeId}" class="inline-block mt-2 text-sm text-indigo-600 font-medium">
              é–‹å§‹ç·´ç¿’ â†’
            </a>
          </div>
        `).join('');
      } else {
        recEl.innerHTML = `
          <div class="col-span-2 text-center py-8 text-gray-400">
            ç¹¼çºŒå­¸ç¿’ï¼Œæˆ‘å€‘æœƒç‚ºä½ æä¾›å€‹äººåŒ–å»ºè­°
          </div>
        `;
      }
    }

    function exportReport() {
      alert('PDF åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...');
    }
  </script>
</body>
</html>
