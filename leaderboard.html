<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ–—æ•™è‚² | æ’è¡Œæ¦œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8X0VB6K9G7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-8X0VB6K9G7');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .rank-2 { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #b45309 100%); }
        .rank-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- å°èˆªåˆ— -->
    <nav class="border-b border-white/10 px-6 py-4">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2">
                <span class="text-2xl">ğŸŒŸ</span>
                <span class="font-bold text-xl">åŒ—æ–—æ•™è‚²</span>
            </a>
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="text-gray-400 hover:text-white transition">å„€è¡¨æ¿</a>
                <a href="quiz_ui.html" class="text-gray-400 hover:text-white transition">æ¸¬é©—</a>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-6 py-8">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">ğŸ† æ’è¡Œæ¦œ</h1>
            <p class="text-gray-400">èˆ‡å…¨åœ‹å­¸ç¿’è€…ä¸€è¼ƒé«˜ä¸‹ï¼</p>
        </div>
        
        <!-- æ’è¡Œé¡å‹åˆ‡æ› -->
        <div class="flex justify-center gap-2 mb-8">
            <button onclick="switchType('xp')" id="tabXp"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-purple-600">
                â­ ç¶“é©—å€¼
            </button>
            <button onclick="switchType('streak')" id="tabStreak"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-white/10 text-gray-400">
                ğŸ”¥ é€£çºŒå¤©æ•¸
            </button>
            <button onclick="switchType('accuracy')" id="tabAccuracy"
                class="px-6 py-2 rounded-full text-sm font-medium transition bg-white/10 text-gray-400">
                âœ… æ­£ç¢ºç‡
            </button>
        </div>
        
        <!-- å‰ä¸‰å -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <!-- ç¬¬äºŒå -->
            <div class="card rounded-xl p-4 text-center order-1" id="rank2Card">
                <div class="w-16 h-16 mx-auto mb-2 rounded-full rank-2 flex items-center justify-center text-2xl font-bold">
                    2
                </div>
                <div id="rank2Name" class="font-semibold truncate">-</div>
                <div id="rank2Value" class="text-gray-400 text-sm">-</div>
            </div>
            
            <!-- ç¬¬ä¸€å -->
            <div class="card rounded-xl p-4 text-center order-0 md:order-1 transform md:scale-110" id="rank1Card">
                <div class="text-3xl mb-1">ğŸ‘‘</div>
                <div class="w-20 h-20 mx-auto mb-2 rounded-full rank-1 flex items-center justify-center text-3xl font-bold text-white">
                    1
                </div>
                <div id="rank1Name" class="font-semibold truncate">-</div>
                <div id="rank1Value" class="text-yellow-400 text-lg font-bold">-</div>
            </div>
            
            <!-- ç¬¬ä¸‰å -->
            <div class="card rounded-xl p-4 text-center order-2" id="rank3Card">
                <div class="w-16 h-16 mx-auto mb-2 rounded-full rank-3 flex items-center justify-center text-2xl font-bold text-white">
                    3
                </div>
                <div id="rank3Name" class="font-semibold truncate">-</div>
                <div id="rank3Value" class="text-gray-400 text-sm">-</div>
            </div>
        </div>
        
        <!-- æˆ‘çš„æ’å -->
        <div class="card rounded-xl p-4 mb-6 border-2 border-purple-500/50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold" id="myRankNum">
                        -
                    </div>
                    <div>
                        <div class="font-semibold" id="myName">ä½ </div>
                        <div class="text-gray-400 text-sm">æˆ‘çš„æ’å</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-purple-400" id="myValue">-</div>
                    <div class="text-gray-500 text-sm" id="myValueLabel">ç¶“é©—å€¼</div>
                </div>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
        <div class="card rounded-xl overflow-hidden">
            <div class="p-4 border-b border-white/10">
                <h3 class="font-semibold">å…¨éƒ¨æ’å</h3>
            </div>
            <div id="rankList" class="divide-y divide-white/5">
                <!-- å‹•æ…‹è¼‰å…¥ -->
                <div class="p-8 text-center text-gray-500">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'https://beidou-edu-server-1.onrender.com/api';
        let currentType = 'xp';
        let leaderboardData = [];
        let myRank = null;
        
        // åˆ‡æ›é¡å‹
        function switchType(type) {
            currentType = type;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            ['xp', 'streak', 'accuracy'].forEach(t => {
                const tab = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if (t === type) {
                    tab.classList.remove('bg-white/10', 'text-gray-400');
                    tab.classList.add('bg-purple-600');
                } else {
                    tab.classList.add('bg-white/10', 'text-gray-400');
                    tab.classList.remove('bg-purple-600');
                }
            });
            
            // GA
            gtag('event', 'switch_leaderboard', {
                'event_category': 'leaderboard',
                'event_label': type
            });
            
            loadLeaderboard();
        }
        
        // è¼‰å…¥æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            const token = localStorage.getItem('beidou_token');
            
            try {
                const res = await fetch(`${API_BASE}/leaderboard?type=${currentType}&limit=50`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                });
                const data = await res.json();
                
                if (data.success) {
                    leaderboardData = data.data.rankings;
                    myRank = data.data.myRank;
                    renderLeaderboard();
                } else {
                    throw new Error('è¼‰å…¥å¤±æ•—');
                }
            } catch (err) {
                console.error('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', err);
                // ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                useMockData();
            }
        }
        
        // æ¨¡æ“¬è³‡æ–™
        function useMockData() {
            const names = ['å­¸éœ¸å°æ˜', 'åŠªåŠ›å°è¯', 'èªçœŸå°ç¾', 'å‹¤å¥®å°å¼·', 'ç”¨åŠŸå°èŠ³', 
                          'è°æ˜å°å‚‘', 'ç©æ¥µå°ç²', 'å°ˆæ³¨å°å‰', 'å …æŒå°é›¯', 'é€²æ­¥å°è±ª'];
            
            leaderboardData = names.map((name, i) => ({
                username: name,
                xp: Math.floor(5000 - i * 400 + Math.random() * 100),
                streak: Math.floor(30 - i * 2 + Math.random() * 3),
                accuracy: Math.floor(95 - i * 2 + Math.random() * 3),
                level: Math.floor(10 - i * 0.8)
            }));
            
            // æˆ‘çš„è³‡æ–™
            const userData = localStorage.getItem('beidou_user');
            if (userData) {
                const user = JSON.parse(userData);
                myRank = {
                    rank: Math.floor(Math.random() * 50) + 10,
                    username: user.username,
                    xp: user.xp || 0,
                    streak: 0,
                    accuracy: 0
                };
            }
            
            renderLeaderboard();
        }
        
        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderLeaderboard() {
            const valueKey = currentType;
            const valueLabel = {
                'xp': 'ç¶“é©—å€¼',
                'streak': 'é€£çºŒå¤©æ•¸',
                'accuracy': 'æ­£ç¢ºç‡'
            }[currentType];
            
            // å‰ä¸‰å
            for (let i = 1; i <= 3; i++) {
                const item = leaderboardData[i - 1];
                if (item) {
                    document.getElementById(`rank${i}Name`).textContent = item.username;
                    let val = item[valueKey];
                    if (currentType === 'accuracy') val += '%';
                    else if (currentType === 'streak') val += ' å¤©';
                    document.getElementById(`rank${i}Value`).textContent = val;
                }
            }
            
            // æˆ‘çš„æ’å
            if (myRank) {
                document.getElementById('myRankNum').textContent = myRank.rank;
                document.getElementById('myName').textContent = myRank.username;
                let myVal = myRank[valueKey];
                if (currentType === 'accuracy') myVal += '%';
                else if (currentType === 'streak') myVal += ' å¤©';
                document.getElementById('myValue').textContent = myVal;
                document.getElementById('myValueLabel').textContent = valueLabel;
            }
            
            // åˆ—è¡¨
            const listHtml = leaderboardData.slice(3).map((item, idx) => {
                const rank = idx + 4;
                let val = item[valueKey];
                if (currentType === 'accuracy') val += '%';
                else if (currentType === 'streak') val += ' å¤©';
                
                return `
                    <div class="rank-item flex items-center justify-between p-4 transition">
                        <div class="flex items-center gap-4">
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-sm font-medium">
                                ${rank}
                            </div>
                            <div>
                                <div class="font-medium">${item.username}</div>
                                <div class="text-gray-500 text-sm">Lv.${item.level || 1}</div>
                            </div>
                        </div>
                        <div class="text-gray-400">${val}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('rankList').innerHTML = listHtml || '<div class="p-8 text-center text-gray-500">æš«ç„¡è³‡æ–™</div>';
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadLeaderboard();
            
            // æˆ‘çš„åå­—
            const userData = localStorage.getItem('beidou_user');
            if (userData) {
                const user = JSON.parse(userData);
                document.getElementById('myName').textContent = user.username;
            }
            
            gtag('event', 'page_view', {
                'event_category': 'leaderboard'
            });
        });
    </script>
</body>
</html>
