<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ªç¸æˆ°é¬¥ - åŒ—æ–—æ•™è‚²</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4F46E5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
    }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
    }
    .hp-bar {
      height: 20px;
      border-radius: 10px;
      background: #333;
      overflow: hidden;
      position: relative;
    }
    .hp-fill {
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }
    .hp-fill.player { background: linear-gradient(90deg, #10B981, #34D399); }
    .hp-fill.monster { background: linear-gradient(90deg, #EF4444, #F87171); }
    .monster-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .monster-card:hover { transform: scale(1.02); border-color: var(--primary); }
    .option-btn {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      transition: all 0.2s;
    }
    .option-btn:hover { background: rgba(79, 70, 229, 0.3); border-color: var(--primary); }
    .option-btn.correct { background: rgba(16, 185, 129, 0.5); border-color: var(--success); }
    .option-btn.wrong { background: rgba(239, 68, 68, 0.5); border-color: var(--danger); }
    .option-btn.disabled { pointer-events: none; opacity: 0.7; }
    .shake { animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .damage-popup {
      position: absolute;
      font-size: 2rem;
      font-weight: bold;
      animation: floatUp 1s ease-out forwards;
      pointer-events: none;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-50px); }
    }
    .combo-badge {
      animation: pulse 0.5s;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
  </style>
</head>
<body class="text-white">
  <div id="app" class="container mx-auto px-4 py-6 max-w-4xl">
    
    <!-- éšæ®µ1: é¸æ“‡ç§‘ç›®/æ€ªç¸ -->
    <div id="selectScreen">
      <h1 class="text-3xl font-bold text-center mb-2">âš”ï¸ æ€ªç¸æˆ°é¬¥</h1>
      <p class="text-center text-gray-400 mb-6">é¸æ“‡ç§‘ç›®ï¼ŒæŒ‘æˆ°çŸ¥è­˜æ€ªç¸ï¼</p>
      
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <button onclick="selectSubject('æ•¸å­¸')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ“</div>
          <div class="font-bold">æ•¸å­¸</div>
        </button>
        <button onclick="selectSubject('ç‰©ç†')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">âš¡</div>
          <div class="font-bold">ç‰©ç†</div>
        </button>
        <button onclick="selectSubject('åŒ–å­¸')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ§ª</div>
          <div class="font-bold">åŒ–å­¸</div>
        </button>
        <button onclick="selectSubject('ç”Ÿç‰©')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ§¬</div>
          <div class="font-bold">ç”Ÿç‰©</div>
        </button>
        <button onclick="selectSubject('åœ°ç§‘')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸŒ</div>
          <div class="font-bold">åœ°ç§‘</div>
        </button>
        <button onclick="selectSubject('åœ‹æ–‡')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ“œ</div>
          <div class="font-bold">åœ‹æ–‡</div>
        </button>
        <button onclick="selectSubject('è‹±æ–‡')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ”¤</div>
          <div class="font-bold">è‹±æ–‡</div>
        </button>
        <button onclick="selectSubject('æ­·å²')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ›ï¸</div>
          <div class="font-bold">æ­·å²</div>
        </button>
        <button onclick="selectSubject('åœ°ç†')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">ğŸ—ºï¸</div>
          <div class="font-bold">åœ°ç†</div>
        </button>
        <button onclick="selectSubject('å…¬æ°‘')" class="monster-card rounded-xl p-4 text-center">
          <div class="text-3xl mb-2">âš–ï¸</div>
          <div class="font-bold">å…¬æ°‘</div>
        </button>
      </div>
      
      <div class="text-center">
        <button onclick="selectSubject('')" class="bg-gradient-to-r from-purple-600 to-indigo-600 px-8 py-3 rounded-full font-bold hover:opacity-90">
          ğŸ² éš¨æ©ŸæŒ‘æˆ°
        </button>
      </div>
    </div>
    
    <!-- éšæ®µ2: æˆ°é¬¥ç•«é¢ -->
    <div id="battleScreen" class="hidden">
      <!-- æ€ªç¸å€ -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span id="monsterEmoji" class="text-4xl">ğŸ‘¾</span>
            <div>
              <div id="monsterName" class="font-bold text-xl">æœªçŸ¥æ€ªç¸</div>
              <div id="monsterSubject" class="text-sm text-gray-400">æ•¸å­¸</div>
            </div>
          </div>
          <div id="monsterHpText" class="font-mono">100/100</div>
        </div>
        <div class="hp-bar">
          <div id="monsterHpBar" class="hp-fill monster" style="width: 100%"></div>
        </div>
      </div>
      
      <!-- VS åˆ†éš” -->
      <div class="text-center my-4">
        <span class="text-2xl font-bold text-yellow-400">âš”ï¸ VS âš”ï¸</span>
        <span id="comboBadge" class="ml-2 hidden bg-orange-500 px-3 py-1 rounded-full text-sm font-bold combo-badge">
          ğŸ”¥ é€£æ“Š x<span id="comboCount">0</span>
        </span>
      </div>
      
      <!-- ç©å®¶å€ -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-4xl">ğŸ§‘â€ğŸ“</span>
            <div>
              <div class="font-bold text-xl">å­¸ç¿’è€…</div>
              <div class="text-sm text-gray-400">å¾—åˆ†: <span id="score">0</span></div>
            </div>
          </div>
          <div id="playerHpText" class="font-mono">100/100</div>
        </div>
        <div class="hp-bar">
          <div id="playerHpBar" class="hp-fill player" style="width: 100%"></div>
        </div>
      </div>
      
      <!-- é¡Œç›®å€ -->
      <div class="monster-card rounded-2xl p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <span id="questionNum" class="text-sm text-gray-400">ç¬¬ 1/5 é¡Œ</span>
          <span id="difficultyBadge" class="bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold">ä¸­ç­‰</span>
        </div>
        <div id="questionText" class="text-lg mb-6 leading-relaxed">
          è¼‰å…¥ä¸­...
        </div>
        <div id="optionsContainer" class="grid gap-3">
          <!-- é¸é …å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      
      <!-- å›é¥‹å€ -->
      <div id="feedback" class="hidden monster-card rounded-2xl p-6 mb-6">
        <div id="feedbackIcon" class="text-5xl text-center mb-3">âœ…</div>
        <div id="feedbackText" class="text-center text-xl font-bold mb-3">æ­£ç¢ºï¼</div>
        <div id="explanation" class="text-gray-300 text-sm p-4 bg-black bg-opacity-30 rounded-lg"></div>
        <button id="nextBtn" onclick="nextQuestion()" class="mt-4 w-full bg-indigo-600 py-3 rounded-lg font-bold hover:bg-indigo-700">
          ä¸‹ä¸€é¡Œ â†’
        </button>
      </div>
    </div>
    
    <!-- éšæ®µ3: çµæœç•«é¢ -->
    <div id="resultScreen" class="hidden text-center">
      <div id="resultEmoji" class="text-8xl mb-4">ğŸ‰</div>
      <h2 id="resultTitle" class="text-3xl font-bold mb-2">æˆ°é¬¥å‹åˆ©ï¼</h2>
      <p id="resultDesc" class="text-gray-400 mb-6">æˆåŠŸæ“Šæ•—æ€ªç¸ï¼</p>
      
      <div class="monster-card rounded-2xl p-6 mb-6">
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-3xl font-bold text-green-400" id="finalScore">0</div>
            <div class="text-sm text-gray-400">å¾—åˆ†</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-yellow-400" id="finalExp">0</div>
            <div class="text-sm text-gray-400">ç¶“é©—å€¼</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-amber-400" id="finalCoins">0</div>
            <div class="text-sm text-gray-400">é‡‘å¹£</div>
          </div>
        </div>
      </div>
      
      <div class="flex gap-4">
        <button onclick="location.reload()" class="flex-1 bg-gray-700 py-3 rounded-lg font-bold hover:bg-gray-600">
          å†ä¾†ä¸€å±€
        </button>
        <button onclick="location.href='index.html'" class="flex-1 bg-indigo-600 py-3 rounded-lg font-bold hover:bg-indigo-700">
          è¿”å›é¦–é 
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://beidou-edu-server-1.onrender.com';
    
    let state = {
      battleId: null,
      monster: null,
      playerHp: 100,
      monsterHp: 100,
      maxMonsterHp: 100,
      combo: 0,
      score: 0,
      currentQuestion: null
    };
    
    // é¸æ“‡ç§‘ç›®
    async function selectSubject(subject) {
      document.getElementById('selectScreen').classList.add('hidden');
      document.getElementById('battleScreen').classList.remove('hidden');
      
      try {
        const res = await fetch(`${API_BASE}/api/battle/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, player_id: 1 })
        });
        const data = await res.json();
        
        if (data.success) {
          state.battleId = data.data.battle_id;
          state.monster = data.data.monster;
          state.playerHp = data.data.player_hp;
          state.monsterHp = data.data.monster_hp;
          state.maxMonsterHp = data.data.monster_hp;
          state.currentQuestion = data.data.current_question;
          
          updateMonsterUI();
          renderQuestion(state.currentQuestion, 1, data.data.total_questions);
        } else {
          alert('é–‹å§‹æˆ°é¬¥å¤±æ•—: ' + data.error);
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        location.reload();
      }
    }
    
    // æ›´æ–°æ€ªç¸ UI
    function updateMonsterUI() {
      const m = state.monster;
      const emojis = {
        'æ•¸å­¸': 'ğŸ“', 'ç‰©ç†': 'âš¡', 'åŒ–å­¸': 'ğŸ§ª', 'ç”Ÿç‰©': 'ğŸ§¬',
        'åœ°ç§‘': 'ğŸŒ', 'åœ‹æ–‡': 'ğŸ“œ', 'è‹±æ–‡': 'ğŸ”¤', 'æ­·å²': 'ğŸ›ï¸',
        'åœ°ç†': 'ğŸ—ºï¸', 'å…¬æ°‘': 'âš–ï¸'
      };
      
      document.getElementById('monsterEmoji').textContent = emojis[m.subject] || 'ğŸ‘¾';
      document.getElementById('monsterName').textContent = m.name || 'çŸ¥è­˜æ€ªç¸';
      document.getElementById('monsterSubject').textContent = m.subject || 'ç¶œåˆ';
    }
    
    // æ¸²æŸ“é¡Œç›®
    function renderQuestion(q, num, total) {
      document.getElementById('questionNum').textContent = `ç¬¬ ${num}/${total} é¡Œ`;
      document.getElementById('questionText').innerHTML = q.question;
      
      const container = document.getElementById('optionsContainer');
      let options = q.options;
      if (typeof options === 'string') {
        try { options = JSON.parse(options); } catch(e) { options = []; }
      }
      
      container.innerHTML = options.map((opt, i) => `
        <button onclick="submitAnswer(${i})" class="option-btn rounded-xl p-4 text-left flex items-center gap-3" data-index="${i}">
          <span class="w-8 h-8 flex items-center justify-center bg-white bg-opacity-20 rounded-full font-bold">
            ${String.fromCharCode(65 + i)}
          </span>
          <span class="flex-1">${typeof opt === 'object' ? opt.text || opt : opt}</span>
        </button>
      `).join('');
      
      document.getElementById('feedback').classList.add('hidden');
      updateHpBars();
    }
    
    // æäº¤ç­”æ¡ˆ
    async function submitAnswer(index) {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(b => b.classList.add('disabled'));
      
      try {
        const res = await fetch(`${API_BASE}/api/battle/answer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            battle_id: state.battleId,
            answer: index
          })
        });
        const data = await res.json();
        
        if (data.success) {
          const result = data.data;
          
          // æ¨™è¨˜æ­£ç¢º/éŒ¯èª¤
          buttons[result.correct_answer].classList.add('correct');
          if (!result.is_correct) {
            buttons[index].classList.add('wrong');
          }
          
          // æ›´æ–°ç‹€æ…‹
          state.playerHp = result.player_hp;
          state.monsterHp = result.monster_hp;
          state.combo = result.combo;
          state.score = result.score;
          
          // å‚·å®³å‹•ç•«
          if (result.is_correct) {
            showDamage('monsterEmoji', result.damage, false);
            document.getElementById('monsterEmoji').parentElement.classList.add('shake');
            setTimeout(() => document.getElementById('monsterEmoji').parentElement.classList.remove('shake'), 500);
          } else {
            showDamage('playerHpBar', result.damage, true);
          }
          
          updateHpBars();
          updateCombo();
          document.getElementById('score').textContent = state.score;
          
          // é¡¯ç¤ºå›é¥‹
          showFeedback(result.is_correct, result.explanation, result.battle_result, result.rewards, result.next_question);
        }
      } catch (err) {
        console.error(err);
        alert('æäº¤å¤±æ•—');
      }
    }
    
    // é¡¯ç¤ºå‚·å®³æ•¸å­—
    function showDamage(elementId, damage, isPlayer) {
      const el = document.getElementById(elementId);
      const popup = document.createElement('div');
      popup.className = 'damage-popup';
      popup.style.color = isPlayer ? '#EF4444' : '#10B981';
      popup.textContent = (isPlayer ? '-' : '-') + damage;
      popup.style.left = '50%';
      popup.style.top = '0';
      el.parentElement.style.position = 'relative';
      el.parentElement.appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }
    
    // æ›´æ–°è¡€æ¢
    function updateHpBars() {
      const playerPct = (state.playerHp / 100) * 100;
      const monsterPct = (state.monsterHp / state.maxMonsterHp) * 100;
      
      document.getElementById('playerHpBar').style.width = playerPct + '%';
      document.getElementById('monsterHpBar').style.width = monsterPct + '%';
      document.getElementById('playerHpText').textContent = `${state.playerHp}/100`;
      document.getElementById('monsterHpText').textContent = `${state.monsterHp}/${state.maxMonsterHp}`;
    }
    
    // æ›´æ–°é€£æ“Š
    function updateCombo() {
      const badge = document.getElementById('comboBadge');
      if (state.combo >= 2) {
        badge.classList.remove('hidden');
        document.getElementById('comboCount').textContent = state.combo;
        badge.classList.remove('combo-badge');
        void badge.offsetWidth;
        badge.classList.add('combo-badge');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    // é¡¯ç¤ºå›é¥‹
    function showFeedback(isCorrect, explanation, battleResult, rewards, nextQ) {
      const feedback = document.getElementById('feedback');
      feedback.classList.remove('hidden');
      
      document.getElementById('feedbackIcon').textContent = isCorrect ? (state.combo >= 3 ? 'ğŸ”¥' : 'âœ…') : 'âŒ';
      document.getElementById('feedbackText').innerHTML = isCorrect 
        ? (state.combo >= 3 ? `<span class="text-orange-400">é€£æ“Š x${state.combo}ï¼</span>` : '<span class="text-green-400">æ­£ç¢ºï¼</span>')
        : '<span class="text-red-400">éŒ¯èª¤ï¼</span>';
      document.getElementById('explanation').textContent = explanation || 'æš«ç„¡è§£æ';
      
      const nextBtn = document.getElementById('nextBtn');
      if (battleResult) {
        nextBtn.textContent = 'æŸ¥çœ‹çµæœ';
        nextBtn.onclick = () => showResult(battleResult, rewards);
      } else {
        nextBtn.textContent = 'ä¸‹ä¸€é¡Œ â†’';
        nextBtn.onclick = () => {
          state.currentQuestion = nextQ;
          const num = parseInt(document.getElementById('questionNum').textContent.split('/')[0].replace('ç¬¬ ', '')) + 1;
          const total = parseInt(document.getElementById('questionNum').textContent.split('/')[1].replace(' é¡Œ', ''));
          renderQuestion(nextQ, num, total);
        };
      }
    }
    
    // é¡¯ç¤ºçµæœ
    function showResult(result, rewards) {
      document.getElementById('battleScreen').classList.add('hidden');
      document.getElementById('resultScreen').classList.remove('hidden');
      
      if (result === 'victory') {
        document.getElementById('resultEmoji').textContent = 'ğŸ‰';
        document.getElementById('resultTitle').textContent = 'æˆ°é¬¥å‹åˆ©ï¼';
        document.getElementById('resultDesc').textContent = 'æˆåŠŸæ“Šæ•— ' + (state.monster?.name || 'æ€ªç¸') + 'ï¼';
      } else {
        document.getElementById('resultEmoji').textContent = 'ğŸ’”';
        document.getElementById('resultTitle').textContent = 'æˆ°é¬¥å¤±æ•—';
        document.getElementById('resultDesc').textContent = 'ä¸‹æ¬¡å†æ¥å†å²ï¼';
      }
      
      document.getElementById('finalScore').textContent = state.score;
      document.getElementById('finalExp').textContent = rewards?.exp || 0;
      document.getElementById('finalCoins').textContent = rewards?.coins || 0;
    }
  </script>
</body>
</html>
